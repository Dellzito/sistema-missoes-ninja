<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Registro de Miss√µes Ninja (ONLINE - FIREBASE)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 4px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        .remove-btn, .edit-btn, .admin-only, .writer-only { transition: all 0.1s ease-in-out; }
        /* Estilo para a lista de executores */
        .executor-list-container {
            min-height: 50px;
            padding: 8px;
            border: 1px solid #4b5563; /* gray-600 */
            border-radius: 8px;
            background-color: #374151; /* gray-700 */
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        .executor-tag {
            display: flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 9999px; /* full rounded */
            font-size: 0.875rem; /* text-sm */
            font-weight: 600;
            background-color: #3b82f6; /* blue-500 */
            color: #fff;
        }
        .executor-remove-btn {
            margin-left: 6px;
            cursor: pointer;
            color: #bfdbfe; /* blue-200 */
        }
        /* Estilo para a Navega√ß√£o */
        .nav-link {
            cursor: pointer;
            padding: 10px 15px;
            font-weight: 600;
            transition: all 0.2s;
        }
        .nav-link:hover:not(.active) {
            background-color: #1e293b; /* slate-800 */
        }
        .nav-link.active {
            color: #fcd34d; /* amber-300 */
            border-bottom: 2px solid #fcd34d;
        }
    </style>
</head>
<body class="p-4 sm:p-8 text-gray-100">

    <div id="app" class="max-w-6xl mx-auto space-y-8">
        
        <!-- HEADER e NAVEGA√á√ÉO -->
        <header class="pb-4 border-b border-blue-700/50">
            <h1 class="text-4xl font-bold text-blue-400 text-center mb-4">üìú Sistema de Registro de Miss√µes Ninja</h1>
            <nav class="flex justify-center bg-gray-900 rounded-xl shadow-lg p-1">
                <a class="nav-link" onclick="window.renderPage('home')" id="nav-home">Home</a>
                <a class="nav-link" onclick="window.renderPage('report_form')" id="nav-report_form">Criar Relat√≥rio</a>
                <a class="nav-link" onclick="window.renderPage('scoreboard')" id="nav-scoreboard">Ver Rank</a>
                <a class="nav-link" onclick="window.renderPage('reports_log')" id="nav-reports_log">Hist√≥rico</a>
                <a class="nav-link" onclick="window.renderPage('auxiliary_log')" id="nav-auxiliary_log">Aux√≠lio</a>
                <a class="nav-link" onclick="window.renderPage('admin_panel')" id="nav-admin_panel">Autoriza√ß√£o</a>
                <a class="nav-link" onclick="window.renderPage('ninja_panel')" id="nav-ninja_panel">Painel de Ninjas</a>
            </nav>
        </header>
        
        <!-- Conte√∫do principal de Roteamento -->
        <div id="content" class="min-h-[60vh]">
            <!-- O conte√∫do da p√°gina ativa ser√° injetado aqui -->
        </div>

        <!-- Loading and Error State -->
        <div id="status" class="text-center p-4 rounded-lg hidden"></div>
        
        <!-- Auth Info for Debugging/Sharing -->
        <div id="auth-info" class="text-sm text-center text-yellow-500">Conectando ao Firebase...</div>
    </div>

    <!-- MODAL DE CONFIRMA√á√ÉO/EDI√á√ÉO CUSTOMIZADO -->
    <div id="custom-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div id="modal-content" class="bg-gray-800 rounded-xl shadow-2xl p-6 w-full max-w-lg space-y-4 transform scale-95 transition-all">
            <h3 id="modal-title" class="text-xl font-bold text-blue-400">T√≠tulo do Modal</h3>
            <p id="modal-message" class="text-gray-300">Mensagem do Modal.</p>
            <div id="modal-input-container" class="space-y-3 hidden">
                <label id="input-label-1" for="modal-input-1" class="block text-sm font-medium text-gray-300">Input 1</label>
                <input type="text" id="modal-input-1" class="w-full p-2.5 rounded-lg bg-gray-700 border border-gray-600 text-white" />
                <label id="input-label-2" for="modal-input-2" class="block text-sm font-medium text-gray-300">Input 2 (Rank)</label>
                <select id="modal-input-2" class="w-full p-2.5 rounded-lg bg-gray-700 border border-gray-600 text-white">
                    <!-- Op√ß√µes de Rank ser√£o injetadas -->
                </select>
                <span id="modal-error" class="text-red-400 text-sm hidden"></span>
            </div>
            <div id="modal-actions" class="flex justify-end gap-3 pt-2">
                <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg transition duration-150">Cancelar</button>
                <button id="modal-confirm-btn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition duration-150">Confirmar</button>
            </div>
        </div>
    </div>
    <!-- FIM DO MODAL -->

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, setDoc, onSnapshot, collection, writeBatch, 
            updateDoc, getDoc, deleteDoc, setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ====================================================================
        // CONFIGURA√á√ïES FIREBASE & CHAVE MESTRA
        // ====================================================================
        
        // VARI√ÅVEIS DE CONFIGURA√á√ÉO DO FIREBASE (DEVE SER CONFIGURADO EM VERCEL/GITHUB SECRETS)
        // OBS: Se estiver no Canvas, a configura√ß√£o √© injetada automaticamente.
        const CUSTOM_FIREBASE_CONFIG = {
            apiKey: "AIzaSyC-QaPr7O6RkWR3vpXCg4zrnUWw3TzU9ss",
            authDomain: "g-2cb53.firebaseapp.com",
            projectId: "g-2cb53",
            storageBucket: "g-2cb53.firebasestorage.app",
            messagingSenderId: "292095146978",
            appId: "1:292095146978:web:836d833230907d081017bb",
            measurementId: "G-B2EXQ2Z75D"
        };
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : CUSTOM_FIREBASE_CONFIG.projectId || 'g-2cb53';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : CUSTOM_FIREBASE_CONFIG;
        
        // CHAVE MESTRA FIXA DO ADMIN MASTER (para o ID 'MASTER_ADMIN')
        const MASTER_ADMIN_ID = 'master_admin_key'; // Este ID √© reservado para o acesso Master
        const WRITER_MODE_ID = 'writer_mode_key'; // Este ID √© reservado para o acesso de Escritor

        let isMasterAdminMode = false; // Controle de acesso total
        let isWriterMode = false; // Controle de acesso para Criar Relat√≥rio / Editar Miss√µes
        let currentPage = 'home';
        
        // Firestore instances and IDs
        let app;
        let db;
        let auth;
        let userId = null;
        let currentReportId = ''; 
        let selectedExecutors = []; 
        
        // Cache de dados (ser√£o preenchidos por onSnapshot)
        let missionsData = {}; 
        let ninjasData = {}; 
        let auxiliaryData = {}; 
        let reportsData = []; 
        let accessKeysData = {}; // NOVO: Cache para IDs/Senhas de Guardi√µes
        
        // Estrutura de Cole√ß√µes (P√∫blica)
        const COLLECTIONS = {
            MISSIONS: `artifacts/${appId}/public/data/missions`,
            REPORTS: `artifacts/${appId}/public/data/reports`,
            NINJAS: `artifacts/${appId}/public/data/ninjas`, 
            AUXILIARY_LOG: `artifacts/${appId}/public/data/auxiliary_log`,
            ACCESS_KEYS: `artifacts/${appId}/public/data/access_keys` // NOVO
        };

        // Mapeamento de Rank para Pontos e Constantes (Mantidas)
        const RANK_POINTS = {
            'SRANK': 5, 'ARANK': 4, 'BRANK': 3, 'CRANK': 2, 'DRANK': 1,
            'DEFESARAID': 10, 'NPCQUEST': 0, 'STORYLINE': 0, 'ANYLEVEL': 0
        };
        const RANK_OPTIONS = [
            "S-Rank", "A-Rank", "B-Rank", "C-Rank", "D-Rank", 
            "Defesa/Raid", "NPC Quest", "Storyline"
        ];
        const RANK_ORDER = ['S', 'A', 'B', 'C', 'D', 'DEFESA'];

        setLogLevel('debug'); 

        // ====================================================================
        // FUN√á√ïES DE PERSIST√äNCIA E INICIALIZA√á√ÉO (FIREBASE)
        // ====================================================================

        async function initializeFirebase() {
            try {
                if (!firebaseConfig || !firebaseConfig.projectId) {
                    throw new Error("Configura√ß√£o do Firebase inv√°lida ou faltando.");
                }
                
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Login An√¥nimo para acesso B√ÅSICO (Leitura)
                const anonUser = await signInAnonymously(auth);
                userId = anonUser.user.uid;
                
                document.getElementById('auth-info').textContent = `Usu√°rio ID (Anon): ${userId} | App ID (DB Contexto): ${appId}`;
                setupFirestoreListeners(); // Inicia os listeners de dados
                window.renderPage(currentPage);
                window.generateReportId(); 
                

            } catch (error) {
                console.error("Erro na inicializa√ß√£o do Firebase:", error);
                const statusElement = document.getElementById('status');
                statusElement.className = 'text-red-400 p-4 bg-red-900/50 rounded-lg block';
                statusElement.textContent = `‚ùå Erro ao conectar: ${error.message}. Verifique sua chave de API e regras de seguran√ßa.`;
            }
        }
        
        function setupFirestoreListeners() {
            if (!db) return;

            // 0. Chaves de Acesso (Nova Cole√ß√£o)
            onSnapshot(collection(db, COLLECTIONS.ACCESS_KEYS), (snapshot) => {
                accessKeysData = {};
                snapshot.forEach(doc => {
                    const data = doc.data();
                    accessKeysData[doc.id] = data; 
                });
            });

            // 1. Miss√µes / Quests
            onSnapshot(collection(db, COLLECTIONS.MISSIONS), (snapshot) => {
                missionsData = {};
                snapshot.forEach(doc => {
                    const data = doc.data();
                    missionsData[data.name] = data; 
                });
                if (Object.keys(missionsData).length === 0) {
                     seedInitialData(db);
                }
                if (['report_form', 'admin_panel'].includes(currentPage)) window.renderPage(currentPage);
            });

            // 2. Ninjas / Cadastro e Scoreboard
            onSnapshot(collection(db, COLLECTIONS.NINJAS), (snapshot) => {
                ninjasData = {};
                snapshot.forEach(doc => {
                    const data = doc.data();
                    data.id = doc.id; 
                    ninjasData[data.id] = data;
                });
                if (['report_form', 'scoreboard', 'admin_panel', 'ninja_panel'].includes(currentPage)) window.renderPage(currentPage);
            });
            
            // 3. Log de Aux√≠lio
            onSnapshot(collection(db, COLLECTIONS.AUXILIARY_LOG), (snapshot) => {
                auxiliaryData = {};
                snapshot.forEach(doc => {
                    const data = doc.data();
                    auxiliaryData[data.id] = data;
                });
                if (['auxiliary_log', 'ninja_panel'].includes(currentPage)) window.renderPage(currentPage);
            });

            // 4. Relat√≥rios / Logs
            onSnapshot(collection(db, COLLECTIONS.REPORTS), (snapshot) => {
                reportsData = [];
                snapshot.forEach(doc => reportsData.push(doc.data()));
                if (['reports_log', 'ninja_panel'].includes(currentPage)) window.renderPage(currentPage);
            });
        }
        
        // Simula o seed de dados no Firestore
        async function seedInitialData(db) {
            // ... (L√≥gica de seed mantida, mas adaptada para incluir chave mestra de exemplo)
            const newMissionsList = [
                { name: "Village's Most Wanted", rank: "S-Rank" },
                { name: "Glacier Bear Hunt", rank: "A-Rank" },
                { name: "Puppet Retirement", rank: "A-Rank" },
                { name: "Retrieve Compromised Documents", rank: "A-Rank" },
                { name: "Spy on Hokage/Kazekage/Mizukage Office", rank: "A-Rank" },
                { name: "Bounty Hunting", rank: "B-Rank" },
                { name: "Cold-Blooded Killer", rank: "B-Rank" },
                { name: "Guilty Pleasure", rank: "B-Rank" },
                { name: "Medical Supplies", rank: "B-Rank" },
                { name: "Antidotes Creation", rank: "C-Rank" },
                { name: "Bear Hunt", rank: "C-Rank" },
                { name: "Messenger Ninja", rank: "C-Rank" },
                { name: "Shark Attack", rank: "C-Rank" },
                { name: "Academy Scrolls", rank: "D-Rank" },
                { name: "Bad Larva", rank: "D-Rank" },
                { name: "Defeat Spiders", rank: "D-Rank" },
                { name: "Lost Puppy 'Giba'", rank: "D-Rank" },
                { name: "Defesa de Vila ou Raid", rank: "Defesa/Raid" },
                { name: "A Demon??", rank: "NPC Quest" },
                { name: "Land Of Waves", rank: "Storyline" },
            ];

            const batch = writeBatch(db);
            let ninjasAdded = 0;

            for (const mission of newMissionsList) {
                const docId = mission.name;
                const missionRef = doc(db, COLLECTIONS.MISSIONS, docId);
                const cleanRank = cleanRankForLookup(mission.rank);
                const points = RANK_POINTS[cleanRank] || 0; 
                batch.set(missionRef, {
                    name: mission.name,
                    baseRank: mission.rank,
                    points: points,
                    id: mission.name
                });
            }

            const exampleNinjas = ['dellzito', 'alnvctr'];
            for (const id of exampleNinjas) {
                const normalizedId = normalizeId(id); 
                const ninjaRef = doc(db, COLLECTIONS.NINJAS, normalizedId);
                const ninjaSnap = await getDoc(ninjaRef);
                if (!ninjaSnap.exists()) {
                    batch.set(ninjaRef, { id: normalizedId, isActive: true, rankPoints: 0, missionsCompleted: 0 });
                    ninjasAdded++;
                }
            }
            
            // NOVO: Adiciona uma chave de ADMIN MASTER para o primeiro uso
            const masterKeyRef = doc(db, COLLECTIONS.ACCESS_KEYS, 'MASTER_ADMIN');
            batch.set(masterKeyRef, {
                id: 'MASTER_ADMIN',
                key: 'MASTER_KEY_001', // Chave √∫nica e secreta para voc√™ (MUDE ESTE VALOR MANUALMENTE NO FIRESTORE)
                level: 'master_admin'
            }, { merge: true });

            // NOVO: Adiciona uma chave de ESCRITOR de exemplo
            const writerKeyRef = doc(db, COLLECTIONS.ACCESS_KEYS, 'Guardi√£o_Exemplo');
            batch.set(writerKeyRef, {
                id: 'GUARDIAN_1',
                key: 'report_123', // Chave para um Guardi√£o (MUDE ESTE VALOR MANUALMENTE NO FIRESTORE)
                level: 'report_writer'
            }, { merge: true });


            if (newMissionsList.length > 0 || ninjasAdded > 0) {
                try {
                    await batch.commit();
                } catch (e) {
                     console.error("Erro ao fazer seed inicial no Firestore:", e);
                }
            }
        }
        
        // ====================================================================
        // FUN√á√ïES DE CONTROLE DE ACESSO
        // ====================================================================

        window.toggleWriterUI = function(isAuthorized) {
            isWriterMode = isAuthorized;
            // Libera a aba Criar Relat√≥rio e o Gerenciamento de Miss√µes
            const writerElements = document.querySelectorAll('.writer-only');
            
            writerElements.forEach(el => {
                if (isAuthorized) {
                    el.classList.remove('hidden');
                } else {
                    el.classList.add('hidden');
                }
            });
            // Re-renderiza a p√°gina atual para aplicar as permiss√µes
            window.renderPage(currentPage);
        }

        window.toggleMasterAdminUI = function(isAuthorized) {
            isMasterAdminMode = isAuthorized;
            // Libera todas as funcionalidades de Admin
            const adminElements = document.querySelectorAll('.admin-only');
            
            adminElements.forEach(el => {
                if (isAuthorized) {
                    el.classList.remove('hidden');
                } else {
                    el.classList.add('hidden');
                }
            });
            // Re-renderiza a p√°gina atual para aplicar as permiss√µes
            window.renderPage(currentPage);
        }
        
        window.checkAccessKey = async function() {
            const idInput = document.getElementById('access-id-input');
            const keyInput = document.getElementById('access-key-input');
            const statusElement = document.getElementById('status');
            
            if (!idInput || !keyInput) return;

            const id = idInput.value.trim();
            const key = keyInput.value.trim();
            
            if (!id || !key) {
                statusElement.textContent = '‚ùå Preencha o ID e a Senha.';
                statusElement.className = 'text-red-400 p-4 bg-red-900/50 rounded-lg block';
                setTimeout(() => statusElement.classList.add('hidden'), 5000);
                return;
            }
            
            // 1. Procura a chave no cache do Firebase
            const accessData = accessKeysData[id];

            if (accessData && accessData.key === key) {
                
                if (accessData.level === 'master_admin') {
                    window.toggleMasterAdminUI(true);
                    window.toggleWriterUI(true);
                    statusElement.textContent = `‚úÖ Acesso MASTER LIBERADO. ID: ${id}`;
                } else if (accessData.level === 'report_writer') {
                    window.toggleWriterUI(true);
                    window.toggleMasterAdminUI(false);
                    statusElement.textContent = `‚úÖ Acesso ESCRITOR LIBERADO. ID: ${id}`;
                } else {
                    statusElement.textContent = '‚ùå ID/Senha v√°lidos, mas N√≠vel de Acesso n√£o reconhecido.';
                    statusElement.className = 'text-red-400 p-4 bg-red-900/50 rounded-lg block';
                    setTimeout(() => statusElement.classList.add('hidden'), 7000);
                    return;
                }
                
                keyInput.value = ''; 
                idInput.value = '';
                statusElement.className = 'text-green-400 p-4 bg-green-900/50 rounded-lg block';
                setTimeout(() => statusElement.classList.add('hidden'), 5000);
                
            } else {
                window.toggleWriterUI(false);
                window.toggleMasterAdminUI(false);
                statusElement.textContent = '‚ùå Autoriza√ß√£o Negada. ID ou Senha Incorreta.';
                statusElement.className = 'text-red-400 p-4 bg-red-900/50 rounded-lg block';
                setTimeout(() => statusElement.classList.add('hidden'), 7000);
            }
        }
        
        // ====================================================================
        // FUN√á√ïES DE ROTEAMENTO E TEMPLATES
        // ====================================================================

        window.renderPage = function(pageName) {
            currentPage = pageName;
            const contentDiv = document.getElementById('content');
            
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            const activeLink = document.getElementById(`nav-${pageName}`);
            if (activeLink) activeLink.classList.add('active');

            contentDiv.innerHTML = '';

            switch (pageName) {
                case 'home':
                    contentDiv.innerHTML = renderHome();
                    break;
                case 'report_form':
                    contentDiv.innerHTML = renderCriarRelatorio();
                    if (!isWriterMode) {
                        contentDiv.innerHTML += '<p class="text-center text-red-500 pt-8">Voc√™ precisa de autoriza√ß√£o (Login na aba Autoriza√ß√£o) para criar relat√≥rios.</p>';
                        break;
                    }
                    // Fun√ß√µes de inicializa√ß√£o espec√≠ficas para a p√°gina de relat√≥rio
                    window.updateMissionSelects(false); 
                    window.updateExecutorSelect();
                    window.updateExecutorTags(false); 
                    window.generateReportId();
                    window.addMissionEntry(null, false); 
                    window.updateDescriptionPreview();
                    break;
                case 'scoreboard':
                    contentDiv.innerHTML = renderRank();
                    renderScoreboard();
                    break;
                case 'reports_log':
                    contentDiv.innerHTML = renderRelatorios();
                    renderReportsLog();
                    break;
                case 'auxiliary_log':
                    contentDiv.innerHTML = renderAuxilio();
                    renderAuxilio();
                    break;
                case 'admin_panel':
                    contentDiv.innerHTML = renderAutorizacao(); // Novo nome da aba
                    break;
                case 'ninja_panel':
                    contentDiv.innerHTML = renderNinjaPanel();
                    window.renderReportsLogFiltered();
                    break;
                default:
                    contentDiv.innerHTML = renderHome();
            }
        }

        // --- TEMPLATES ---
        function renderHome() { /* ... */ return `
                <section class="text-center py-20 bg-gray-800 rounded-xl shadow-2xl space-y-8">
                    <h2 class="text-3xl font-bold text-green-400">Bem-vindo(a) √† Folha de Rosto Ninja!</h2>
                    <p class="text-lg text-gray-300 max-w-2xl mx-auto">
                        Este √© o painel central para o sistema de rastreamento de miss√µes e ranking dos Guardi√µes. 
                        Todos os dados s√£o sincronizados em tempo real via Firebase.
                    </p>
                    <div class="flex flex-col sm:flex-row justify-center gap-6 pt-4">
                        <button onclick="window.renderPage('report_form')" class="py-3 px-8 bg-blue-600 hover:bg-blue-700 rounded-lg font-bold text-white text-xl transition duration-200 shadow-lg shadow-blue-500/50">
                            Criar Novo Relat√≥rio
                        </button>
                        <button onclick="window.renderPage('scoreboard')" class="py-3 px-8 bg-red-600 hover:bg-red-700 rounded-lg font-bold text-white text-xl transition duration-200 shadow-lg shadow-red-500/50">
                            Ver Rank
                        </button>
                        <button onclick="window.renderPage('admin_panel')" class="py-3 px-8 bg-yellow-600 hover:bg-yellow-700 rounded-lg font-bold text-white text-xl transition duration-200 shadow-lg shadow-yellow-500/50">
                            Autoriza√ß√£o
                        </button>
                    </div>
                </section>
            `; }

        function renderCriarRelatorio() { return `
                <section id="report-form-section" class="bg-gray-800 p-6 rounded-xl shadow-2xl space-y-6">
                    <h2 class="text-3xl font-semibold border-b pb-3 border-gray-700 text-blue-300 text-center">Formul√°rio de Registro de Miss√£o</h2>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        
                        <!-- ID Ninja (Quem Realizou) - AGORA COM SELECT -->
                        <div class="space-y-2 lg:col-span-3">
                            <label class="block text-sm font-medium text-gray-300">IDs Ninja (Quem Realizou - Membros Cadastrados)</label>
                            
                            <!-- Select e bot√£o para adicionar -->
                            <div class="flex gap-2">
                                <select id="new-executor-id-select" class="flex-grow p-2.5 rounded-lg bg-gray-700 border border-gray-600 focus:ring-blue-500 focus:border-blue-500 text-white shadow-inner">
                                    <option value="" disabled selected>Selecione um Guardi√£o Ativo</option>
                                    <!-- Options preenchidas dinamicamente por updateExecutorSelect -->
                                </select>
                                <button type="button" id="add-executor-btn" class="py-2.5 px-4 bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg transition duration-200 font-semibold">
                                    Adicionar Executor
                                </button>
                            </div>

                            <!-- Tags de Executores Selecionados -->
                            <div id="executors-tag-container" class="executor-list-container">
                                <!-- Tags ser√£o injetadas aqui -->
                                <span id="no-executor-message" class="text-gray-400 text-sm italic">Nenhum executor selecionado.</span>
                            </div>
                        </div>
                        
                        <!-- ID Cliente (Requisitantes) -->
                        <div class="space-y-2">
                            <label for="clients" class="block text-sm font-medium text-gray-300">Clientes (Requisitantes, separados por v√≠rgula)</label>
                            <input id="clients" type="text" placeholder="lukfault, logagault" class="w-full p-2.5 rounded-lg bg-gray-700 border border-gray-600 focus:ring-blue-500 focus:border-blue-500 text-white shadow-inner" oninput="window.updateDescriptionPreview()">
                        </div>

                        <!-- Aux√≠lio (Quem Ajudou - Rastreamento Separado) -->
                        <div class="space-y-2">
                            <label for="support-ids" class="block text-sm font-medium text-gray-300">Aux√≠lio (IDs, separados por v√≠rgula, Opcional)</label>
                            <input id="support-ids" type="text" placeholder="AlnVctr, Yakuza" class="w-full p-2.5 rounded-lg bg-gray-700 border border-gray-600 focus:ring-blue-500 focus:border-blue-500 text-white shadow-inner" oninput="window.updateDescriptionPreview()">
                        </div>
                        
                        <!-- Detalhes da Miss√£o (Para a Descri√ß√£o) -->
                        <div class="space-y-2 lg:col-span-3">
                            <label for="mission-details" class="block text-sm font-medium text-gray-300">Detalhes para a Descri√ß√£o (Ex: "60 DNAs para o Arco do 30")</label>
                            <input id="mission-details" type="text" placeholder="Descri√ß√£o curta do objetivo da miss√£o" class="w-full p-2.5 rounded-lg bg-gray-700 border border-gray-600 focus:ring-blue-500 focus:border-blue-500 text-white shadow-inner" oninput="window.updateDescriptionPreview()">
                        </div>

                        <!-- ID Relat√≥rio (C√≥digo de Registro) -->
                        <div class="space-y-2 lg:col-span-3">
                            <label for="report-id-display" class="block text-sm font-medium text-gray-300">ID √önico do Relat√≥rio (C√≥digo de Registro)</label>
                            <div class="flex gap-2">
                                <input id="report-id-display" type="text" readonly class="w-full p-2.5 rounded-lg bg-gray-600/50 border border-gray-600 text-purple-300 font-mono shadow-inner cursor-not-allowed" value="Gerado Automaticamente">
                                <button type="button" onclick="window.copyReportId()" class="p-2.5 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition duration-200" title="Copiar ID para o Discord">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M7 9a1 1 0 011-1h4a1 1 0 110 2H8a1 1 0 01-1-1zm0 4a1 1 0 011-1h4a1 1 0 110 2H8a1 1 0 01-1-1z" /><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-5a1 1 0 00-1 1v2a1 1 0 102 0V6a1 1 0 00-1-1zm2 13a1 1 0 001-1v-2a1 1 0 10-2 0v2a1 1 0 001 1z" clip-rule="evenodd" /></svg>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="pt-4 space-y-4 border-t border-gray-700/50">
                        <h3 class="text-xl font-medium text-gray-300 flex justify-between items-center">
                            Miss√µes Conclu√≠das Neste Relat√≥rio
                            <button id="add-mission-btn" class="py-1 px-3 bg-green-600 hover:bg-green-700 text-white text-sm rounded-lg transition duration-200 shadow-md flex items-center gap-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                                Adicionar Miss√£o
                            </button>
                        </h3>

                        <!-- Cont√™iner de Entrada de Miss√µes -->
                        <div id="missions-entry-container" class="space-y-3">
                            <!-- Mission entries will be added here -->
                        </div>

                        <!-- Resumo de Pontos e Rank -->
                        <div class="grid grid-cols-2 gap-4 pt-4">
                            <div class="space-y-2 lg:col-span-2">
                                <label class="block text-sm font-medium text-gray-300">Total de Pontos (Pontos Brutos da Miss√£o)</label>
                                <input id="total-points" type="text" readonly class="w-full p-2.5 rounded-lg bg-gray-600/50 border border-gray-600 text-green-400 font-bold shadow-inner cursor-not-allowed" value="0">
                            </div>
                            <!-- REMOVIDO: Pontos p/ Pessoa (Estimado) -->
                        </div>
                    </div>

                    <!-- Preview da Descri√ß√£o -->
                    <div class="pt-4 space-y-2 border-t border-gray-700/50">
                        <h3 class="text-xl font-medium text-gray-300">Preview da Descri√ß√£o do Relat√≥rio:</h3>
                        <div id="description-preview" class="p-4 bg-gray-700 rounded-lg text-gray-300 italic min-h-[50px]">
                            A descri√ß√£o do relat√≥rio aparecer√° aqui ao preencher o formul√°rio.
                        </div>
                    </div>

                    <button id="submit-report" class="w-full py-3 mt-4 bg-blue-600 hover:bg-blue-700 rounded-lg font-bold text-white text-lg transition duration-200 shadow-lg shadow-blue-500/50" disabled onclick="window.submitReport()">
                        Registrar Miss√£o(√µes) e Atualizar Ranking
                    </button>
                </section>
            `;
        }
        
        function renderRank() {
            return `
                <section class="space-y-4 pt-8">
                    <h2 class="text-3xl font-bold text-red-400 text-center flex justify-center items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 8a1 1 0 000 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /><path fill-rule="evenodd" d="M10 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zM5 10a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
                        Rank dos Guardi√µes (Membros Cadastrados)
                    </h2>
                    <div class="bg-gray-800 p-4 rounded-xl shadow-xl overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-700">
                            <thead class="bg-gray-700">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Rank</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">ID Guardi√£o</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Total de Pontos</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Miss√µes Conclu√≠das</th>
                                </tr>
                            </thead>
                            <tbody id="ninjas-scoreboard" class="bg-gray-800 divide-y divide-gray-700">
                                <!-- Scoreboard data will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </section>
            `;
        }

        function renderRelatorios() {
            return `
                <section class="space-y-4 pt-8">
                    <h2 class="text-3xl font-bold text-blue-400 text-center">Registro Completo de Relat√≥rios</h2>
                    <div class="bg-gray-800 p-4 rounded-xl shadow-xl overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-700">
                            <thead class="bg-gray-700">
                                <tr>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider w-1/12">ID Relat√≥rio</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider w-2/12">Servi√ßos/Rank</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider w-2/12">Executor/Aux√≠lio</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider w-2/12">Clientes</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider w-3/12">Descri√ß√£o</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider w-1/12">Data</th>
                                </tr>
                            </thead>
                            <tbody id="reports-log" class="bg-gray-800 divide-y divide-gray-700">
                                <!-- Report data will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </section>
            `;
        }

        function renderAuxilio() {
            return `
                <section class="space-y-4 pt-8">
                    <h2 class="text-3xl font-bold text-orange-400 text-center flex justify-center items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm4.5-9.5c0 .83-.67 1.5-1.5 1.5s-1.5-.67-1.5-1.5.67-1.5 1.5-1.5 1.5.67 1.5 1.5zM9 9c0-.83-.67-1.5-1.5-1.5S6 8.17 6 9s.67 1.5 1.5 1.5S9 9.83 9 9zm3 2.5c-2.33 0-4.38 1.15-5.69 2.84.03-.02.06-.04.09-.07C6.67 13.92 9.07 15 12 15s5.33-1.08 7.6-2.73c.03.03.06.05.09.07-1.31-1.69-3.36-2.84-5.69-2.84z"/></svg>
                        Log de Aux√≠lio (Potenciais Membros)
                    </h2>
                    <p class="text-center text-gray-400">Pessoas que participaram como aux√≠lio e acumulam pontos separadamente.</p>
                    <div class="bg-gray-800 p-4 rounded-xl shadow-xl overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-700">
                            <thead class="bg-gray-700">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">ID Auxiliar</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">√öltima Participa√ß√£o</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Pontos Acumulados</th>
                                </tr>
                            </thead>
                            <tbody id="auxiliary-log" class="bg-gray-800 divide-y divide-gray-700">
                                <!-- Auxiliary data will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </section>
            `;
        }

        function renderAdministracao() {
             const accessStatus = isMasterAdminMode ? 
                `<div class="text-center text-green-400 font-bold text-lg p-2">‚úÖ MASTER ADMIN ATIVO</div>` : 
                (isWriterMode ? `<div class="text-center text-yellow-400 font-bold text-lg p-2">‚úÖ ESCRITOR DE RELAT√ìRIO ATIVO</div>` :
                `<div class="text-center text-red-400 font-bold text-lg p-2">‚ùå ACESSO INATIVO</div>`);

            return `
                <!-- PAINEL DE AUTORIZA√á√ÉO (Login Customizado) -->
                <section class="space-y-4 pt-4 pb-4 bg-gray-900 p-6 rounded-xl shadow-inner border border-blue-500/50">
                     <h2 class="text-2xl font-bold text-blue-400 text-center flex justify-center items-center gap-2">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M10 2a5 5 0 00-5 5v2a2 2 0 00-2 2v5a2 2 0 002 2h10a2 2 0 002-2v-5a2 2 0 00-2-2V7a5 5 0 00-5-5zm2 5v2h-4V7a3 3 0 016 0z"/></svg>
                         Autoriza√ß√£o de Escrita (ID & Senha √önica)
                     </h2>
                     <p class="text-center text-gray-400">Insira seu ID e Senha fornecidos para liberar as fun√ß√µes de escrita e edi√ß√£o.</p>
                     
                     <div id="admin-status-display">${accessStatus}</div>

                     <div class="flex flex-col md:flex-row gap-4 max-w-lg mx-auto">
                         <input id="access-id-input" type="text" placeholder="Seu ID de Guardi√£o/Admin" class="flex-grow p-2 rounded-lg bg-gray-700 border border-gray-600 text-white shadow-inner">
                         <input id="access-key-input" type="password" placeholder="Sua Senha √önica" class="flex-grow p-2 rounded-lg bg-gray-700 border border-gray-600 text-white shadow-inner">
                         <button id="set-access-key-btn" class="w-full md:w-auto py-2 px-4 bg-blue-600 hover:bg-blue-700 rounded-lg font-bold text-white transition duration-200">
                             Verificar Acesso
                         </button>
                     </div>
                </section>
                
                <!-- 5. CADASTRO: GUARDI√ïES (MASTER ADMIN ONLY) -->
                <section class="space-y-4 pt-8 pb-16">
                    <h2 class="text-3xl font-bold text-yellow-400 text-center">Cadastro: Guardi√µes (Membros da Organiza√ß√£o)</h2>
                    <p class="text-center text-gray-400">Pessoas que pontuam no Rank dos Guardi√µes. <span class="text-red-400">Master Admin Apenas.</span></p>

                    <!-- Add New Ninja Form (ADMIN ONLY) -->
                    <div id="add-ninja-form" class="bg-gray-700 p-4 rounded-lg shadow-inner flex flex-col sm:flex-row gap-4 admin-only ${isMasterAdminMode ? '' : 'hidden'}">
                        <input id="new-ninja-id" type="text" placeholder="ID do Novo Guardi√£o (Ex: Dellzito)" class="flex-grow p-2 rounded-lg bg-gray-800 border border-gray-600 text-white">
                        <button id="add-ninja" class="w-full sm:w-auto py-2 px-4 bg-yellow-600 hover:bg-yellow-700 rounded-lg font-bold text-white transition duration-200" onclick="window.addNinja()">Adicionar Guardi√£o</button>
                    </div>

                    <div class="bg-gray-800 p-4 rounded-xl shadow-xl overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-700">
                            <thead class="bg-gray-700">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">ID Guardi√£o</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Status</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider admin-only ${isMasterAdminMode ? '' : 'hidden'}">A√ß√£o</th>
                                </tr>
                            </thead>
                            <tbody id="ninjas-cadastro" class="bg-gray-800 divide-y divide-gray-700">
                                <!-- Ninja data will be inserted here by renderNinjasTable() -->
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- 6. BANCO DE DADOS: MISS√ïES E RANKS (MASTER ADMIN / WRITER MODE) -->
                <section class="space-y-4 pt-8">
                    <h2 class="text-3xl font-bold text-green-400 text-center">Gerenciamento de Miss√µes (Quests)</h2>
                    <p class="text-center text-gray-400">Adicione, edite ou exclua as quests dispon√≠veis. <span class="${isWriterMode ? 'text-green-400' : 'text-red-400'}">Requer Autoriza√ß√£o de Escrita.</span></p>
                    
                    <!-- Add New Mission Form (WRITER ONLY) -->
                    <div id="add-mission-form" class="bg-gray-700 p-4 rounded-lg shadow-inner flex flex-col sm:flex-row gap-4 writer-only ${isWriterMode ? '' : 'hidden'}">
                        <input id="new-mission-name" type="text" placeholder="Novo Nome da Miss√£o" class="flex-grow p-2 rounded-lg bg-gray-800 border border-gray-600 text-white">
                        <select id="new-mission-rank-select" class="w-full sm:w-32 p-2 rounded-lg bg-gray-800 border border-gray-600 text-white">
                             <option value="S-Rank">S-Rank (5 Pts)</option>
                             <option value="A-Rank">A-Rank (4 Pts)</option>
                             <option value="B-Rank" selected>B-Rank (3 Pts)</option>
                             <option value="C-Rank">C-Rank (2 Pts)</option>
                             <option value="D-Rank">D-Rank (1 Pt)</option>
                             <option value="Defesa/Raid">Defesa/Raid (10 Pts)</option>
                             <option value="NPC Quest">NPC Quest (0 Pts)</option>
                             <option value="Storyline">Storyline (0 Pts)</option>
                        </select>
                        <button id="add-mission" class="w-full sm:w-auto py-2 px-4 bg-green-600 hover:bg-green-700 rounded-lg font-bold text-white transition duration-200" onclick="window.addMission()">Adicionar Miss√£o</button>
                    </div>
                    
                    <div class="bg-gray-800 p-4 rounded-xl shadow-xl overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-700">
                            <thead class="bg-gray-700">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Nome da Miss√£o</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Rank Base</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Pontos</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider writer-only ${isWriterMode ? '' : 'hidden'}">A√ß√£o</th>
                                </tr>
                            </thead>
                            <tbody id="missions-database" class="bg-gray-800 divide-y divide-gray-700">
                                <!-- Mission data will be inserted here by renderMissionsDatabase() -->
                            </tbody>
                        </table>
                    </div>
                </section>
            `;
        }
        
        function renderNinjaPanel() {
            // Combina IDs de Guardi√µes Ativos/Inativos e IDs de Aux√≠lio em uma √∫nica lista
            const allIdsMap = {};
            
            // Adiciona Guardi√µes (com status de ativo)
            Object.values(ninjasData).forEach(n => {
                allIdsMap[n.id] = { id: n.id, type: n.isActive ? 'Guardi√£o Ativo' : 'Guardi√£o Inativo' };
            });

            // Adiciona Auxiliares que n√£o s√£o Guardi√µes
            Object.values(auxiliaryData).forEach(a => {
                if (!allIdsMap[a.id]) {
                    allIdsMap[a.id] = { id: a.id, type: 'Auxiliar' };
                }
            });

            const allIdsSorted = Object.values(allIdsMap).sort((a, b) => a.id.localeCompare(b.id));

            const ninjaOptions = allIdsSorted.map(n => 
                `<option value="${n.id}" class="${n.type.includes('Inativo') ? 'text-red-400' : ''}">
                    ${n.id} (${n.type})
                </option>`
            ).join('');
            
            // REMOVIDA A OP√á√ÉO RESET_LS
            return `
                <section class="space-y-6 pt-4">
                    <h2 class="text-3xl font-bold text-purple-400 text-center flex justify-center items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                        Painel de Ninjas - Hist√≥rico Completo
                    </h2>
                    <p class="text-center text-gray-400">Selecione qualquer ID de Ninja (Guardi√£o ou Auxiliar) para ver seu hist√≥rico de relat√≥rios e pontos.</p>

                    <!-- Seletor de Ninja/Auxiliar -->
                    <div class="max-w-md mx-auto space-y-2">
                        <label for="ninja-filter-select" class="block text-sm font-medium text-gray-300">Selecionar Ninja</label>
                        <select id="ninja-filter-select" onchange="window.renderReportsLogFiltered(this.value)" class="w-full p-2.5 rounded-lg bg-gray-700 border border-gray-600 focus:ring-purple-500 focus:border-purple-500 text-white shadow-inner">
                            <option value="">-- Ver Todos os Relat√≥rios --</option>
                            ${ninjaOptions}
                        </select>
                    </div>

                    <!-- Informa√ß√µes do Ninja Selecionado (Pontos e Miss√µes) -->
                    <div id="guardian-summary" class="max-w-md mx-auto p-4 bg-gray-700 rounded-lg shadow-inner text-center hidden">
                        <!-- Summary will be injected here -->
                    </div>

                    <!-- Tabela de Relat√≥rios Filtrada -->
                    <div id="filtered-reports-container" class="bg-gray-800 p-4 rounded-xl shadow-xl overflow-x-auto">
                        <h3 class="text-xl font-medium text-gray-300 mb-4">Relat√≥rios Envolvidos:</h3>
                        <table class="min-w-full divide-y divide-gray-700">
                            <thead class="bg-gray-700">
                                <tr>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider w-1/12">ID Relat√≥rio</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider w-2/12">Servi√ßos/Rank</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider w-2/12">Fun√ß√£o</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider w-2/12">Total Pts</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider w-4/12">Descri√ß√£o</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider w-1/12">Data</th>
                                </tr>
                            </thead>
                            <tbody id="filtered-reports-log" class="bg-gray-800 divide-y divide-gray-700">
                                <!-- Report data will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </section>
            `;
        }

        function renderScoreboard() {
            const scoreboardBody = document.getElementById('ninjas-scoreboard');
            if (!scoreboardBody) return; 
            
            const guardians = Object.values(ninjasData).filter(n => n.isActive); 
            guardians.sort((a, b) => b.rankPoints - a.rankPoints);
            
            scoreboardBody.innerHTML = '';

            guardians.forEach((ninja, index) => {
                const rankIcon = getRankIcon(index + 1);
                scoreboardBody.innerHTML += `
                    <tr class="hover:bg-gray-700/50">
                        <td class="px-6 py-2 whitespace-nowrap text-sm font-bold text-center">${rankIcon}</td>
                        <td class="px-6 py-2 whitespace-nowrap text-sm font-medium text-blue-300">${ninja.id}</td>
                        <td class="px-6 py-2 whitespace-nowrap text-sm font-bold text-green-400">${Math.round(ninja.rankPoints)} Pts</td>
                        <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-300">${ninja.missionsCompleted || 0}</td>
                    </tr>
                `;
            });
        }
        
        function renderAuxilio() {
            const auxiliaryLogBody = document.getElementById('auxiliary-log');
            if (!auxiliaryLogBody) return;
            
            const sortedAuxiliaries = Object.values(auxiliaryData).sort((a, b) => b.rankPoints - a.rankPoints);
            
            auxiliaryLogBody.innerHTML = '';
            
            sortedAuxiliaries.forEach(data => {
                const lastParticipation = data.lastParticipation ? new Date(data.lastParticipation).toLocaleDateString('pt-BR') : 'N/A';
                
                auxiliaryLogBody.innerHTML += `
                    <tr class="hover:bg-gray-700/50">
                        <td class="px-6 py-2 whitespace-nowrap text-sm font-medium text-orange-300">${data.id}</td>
                        <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-400">${lastParticipation}</td>
                        <td class="px-6 py-2 whitespace-nowrap text-sm font-semibold text-green-400">${Math.round(data.rankPoints || 0)} Pts</td>
                    </tr>
                `;
            });
        }

        function renderReportsLog() {
            window.renderReportsLogFiltered(null, 'reports-log');
        }

        // NOVO: Fun√ß√£o para renderizar relat√≥rios filtrados
        window.renderReportsLogFiltered = function(filterId = null, targetId = 'filtered-reports-log') {
            
            const reportsLog = document.getElementById(targetId);
            const guardianSummaryDiv = document.getElementById('guardian-summary');

            if (!reportsLog) return;
            
            reportsLog.innerHTML = '';
            let filteredReports = reportsData;

            if (filterId) {
                // Filtra relat√≥rios onde o ID est√° como executor OU auxiliar
                filteredReports = reportsData.filter(report => {
                    const isExecutor = Array.isArray(report.executorIds) && report.executorIds.includes(filterId);
                    const isAuxiliary = Array.isArray(report.supportIds) && report.supportIds.includes(filterId);
                    return isExecutor || isAuxiliary;
                });
            }
            
            // Exibe o resumo do Ninja/Auxiliar se o filtro estiver ativo
            if (filterId && guardianSummaryDiv) {
                const ninjaData = ninjasData[filterId];
                const auxData = auxiliaryData[filterId];
                const isGuardian = !!ninjaData;
                
                let points = 0;
                let missions = 0;
                let type = 'ID Inativo';

                if (isGuardian) {
                    points = Math.round(ninjaData.rankPoints);
                    missions = ninjaData.missionsCompleted;
                    type = ninjaData.isActive ? 'Guardi√£o Ativo' : 'Guardi√£o Inativo';
                } else if (auxData) {
                    points = Math.round(auxData.rankPoints);
                    // Conta o n√∫mero de relat√≥rios em que o auxiliar participou
                    missions = reportsData.filter(r => r.supportIds && r.supportIds.includes(filterId)).length;
                    type = 'Auxiliar';
                }

                guardianSummaryDiv.innerHTML = `
                    <p class="text-xl font-bold text-yellow-400">${filterId.toUpperCase()}</p>
                    <p class="text-sm text-gray-300">${type}</p>
                    <p class="text-lg text-green-400">Total de Pontos: ${points} Pts</p>
                    <p class="text-gray-300">Total de Relat√≥rios Envolvidos: ${missions}</p>
                `;
                guardianSummaryDiv.classList.remove('hidden');
            } else if (guardianSummaryDiv) {
                guardianSummaryDiv.classList.add('hidden');
            }


            const sortedReports = filteredReports.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            if (sortedReports.length === 0) {
                 reportsLog.innerHTML = `<tr><td colspan="6" class="px-4 py-4 text-center italic text-gray-500">Nenhum relat√≥rio encontrado${filterId ? ` para o Ninja/Auxiliar "${filterId}"` : ''}.</td></tr>`;
                 return;
            }

            sortedReports.forEach(data => {
                const rankClass = data.finalReportRank ? getRankColor(data.finalReportRank) : 'text-gray-400';
                
                const formattedDate = new Date(data.timestamp).toLocaleDateString('pt-BR', {
                    day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'
                });
                
                const servicesList = data.serviceNames.map(name => 
                    `<span class="text-xs text-gray-400 block">${name}</span>`
                ).join('');
                
                const executorsText = Array.isArray(data.executorIds) ? data.executorIds.join(', ') : data.executorId;
                const finalRankDisplay = data.finalReportRank ? `(Rank ${data.finalReportRank.replace('-Rank', '')})` : '(N/A)';
                
                // Determina o papel do Ninja/Auxiliar para a tabela filtrada
                let role = '';
                if (filterId) {
                    const isExecutor = Array.isArray(data.executorIds) && data.executorIds.includes(filterId);
                    const isAuxiliary = Array.isArray(data.supportIds) && data.supportIds.includes(filterId);
                    if (isExecutor && isAuxiliary) role = 'Executor & Aux√≠lio';
                    else if (isExecutor) role = 'Executor';
                    else if (isAuxiliary) role = 'Aux√≠lio';
                }
                
                // Escolhe o target body correto (reports-log ou filtered-reports-log)
                const targetBody = document.getElementById(targetId);

                if (targetId === 'filtered-reports-log') {
                     // Renderiza a tabela do Painel de Ninjas
                     targetBody.innerHTML += `
                         <tr class="hover:bg-gray-700/50">
                             <td class="px-4 py-2 whitespace-nowrap text-xs text-gray-400 truncate w-1/12">${data.reportId}</td>
                             <td class="px-4 py-2 whitespace-normal text-sm text-white w-2/12">
                                 ${servicesList}
                                 <span class="text-sm ${rankClass} font-bold mt-1 block">${finalRankDisplay}</span>
                             </td>
                             <td class="px-4 py-2 whitespace-normal text-sm text-white w-2/12">
                                 <span class="font-bold text-yellow-300">${role}</span>
                             </td>
                             <td class="px-4 py-2 whitespace-normal text-sm text-green-400 w-2/12">${data.totalPointsRaw} Pts</td>
                             <td class="px-4 py-2 whitespace-normal text-sm italic text-gray-400 w-4/12">${data.description}</td>
                             <td class="px-4 py-2 whitespace-nowrap text-sm w-1/12">
                                 <span class="font-mono text-gray-400 text-xs">${formattedDate}</span>
                             </td>
                         </tr>
                     `;
                } else {
                    // Renderiza a tabela Hist√≥rico Completo
                    targetBody.innerHTML += `
                        <tr class="hover:bg-gray-700/50">
                            <td class="px-4 py-2 whitespace-nowrap text-xs text-gray-400 truncate w-1/12">${data.reportId}</td>
                            <td class="px-4 py-2 whitespace-normal text-sm text-white w-2/12">
                                ${servicesList}
                                <span class="text-sm ${rankClass} font-bold mt-1 block">${finalRankDisplay}</span>
                            </td>
                            <td class="px-4 py-2 whitespace-normal text-sm text-white w-2/12">
                                <span class="font-bold text-blue-300">${executorsText}</span><br>
                                ${data.supportIds && data.supportIds.length > 0 ? `<span class="text-xs text-gray-400">Aux√≠lio: ${data.supportIds.join(', ')}</span>` : '<span class="text-xs text-gray-500">Sem aux√≠lio</span>'}
                            </td>
                            <td class="px-4 py-2 whitespace-normal text-sm text-gray-300 w-2/12">${data.clients.join(', ')}</td>
                            <td class="px-4 py-2 whitespace-normal text-sm italic text-gray-400 w-3/12">${data.description}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm w-1/12">
                                <span class="font-mono text-gray-400 text-xs">${formattedDate}</span>
                            </td>
                        </tr>
                    `;
                }
            });
        }

        window.renderNinjasTable = function() {
            const ninjasBody = document.getElementById('ninjas-cadastro');
            if (!ninjasBody) return; 
            
            const showActionColumn = isMasterAdminMode;

            const actionHeader = ninjasBody.closest('table').querySelector('th.admin-only');
            if (actionHeader) {
                if (showActionColumn) actionHeader.classList.remove('hidden');
                else actionHeader.classList.add('hidden');
            }

            const sortedNinjas = Object.values(ninjasData).sort((a, b) => a.id.localeCompare(b.id));
            
            ninjasBody.innerHTML = '';

            sortedNinjas.forEach(data => {
                
                const statusClass = data.isActive ? 'text-green-400' : 'text-red-400';
                const statusText = data.isActive ? 'Ativo' : 'Inativo';
                
                const actionCell = showActionColumn ? `
                    <td class="px-6 py-2 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="window.editNinja('${data.id}')" class="text-blue-500 hover:text-blue-700 transition duration-150 edit-btn mr-2">Editar Status</button>
                        <button onclick="window.deleteNinja('${data.id}')" class="text-red-500 hover:text-red-700 transition duration-150">Excluir</button>
                    </td>
                ` : '';

                ninjasBody.innerHTML += `
                    <tr class="hover:bg-gray-700/50">
                        <td class="px-6 py-2 whitespace-nowrap text-sm font-medium text-white">${data.id}</td>
                        <td class="px-6 py-2 whitespace-nowrap text-sm ${statusClass}">${statusText}</td>
                        ${actionCell}
                    </tr>
                `;
            });
            
            if (document.getElementById('add-ninja-form')) {
                if (isMasterAdminMode) {
                    document.getElementById('add-ninja-form').classList.remove('hidden');
                } else {
                    document.getElementById('add-ninja-form').classList.add('hidden');
                }
            }
        }
        
        window.renderMissionsDatabase = function() {
            const missionsBody = document.getElementById('missions-database');
            if (!missionsBody) return; 
            
            missionsBody.innerHTML = '';
            
            const showActionColumn = isWriterMode; // A√ß√£o de Quests liberada para Escritor/Admin
            const sortedMissions = Object.values(missionsData).sort((a, b) => a.name.localeCompare(b.name));

            const actionHeader = missionsBody.closest('table').querySelector('th.writer-only');
            if (actionHeader) {
                if (showActionColumn) actionHeader.classList.remove('hidden');
                else actionHeader.classList.add('hidden');
            }
            
            if (document.getElementById('add-mission-form')) {
                if (isWriterMode) {
                    document.getElementById('add-mission-form').classList.remove('hidden');
                } else {
                    document.getElementById('add-mission-form').classList.add('hidden');
                }
            }


            sortedMissions.forEach(data => {
                const encodedId = encodeURIComponent(data.id);
                const encodedName = encodeURIComponent(data.name);
                const encodedRank = encodeURIComponent(data.baseRank);
                
                const actionCell = showActionColumn ? `
                    <td class="px-6 py-2 whitespace-nowrap text-right text-sm font-medium flex gap-2">
                        <button onclick="window.editMission('${encodedId}', '${encodedName}', '${encodedRank}')" class="text-blue-500 hover:text-blue-700 transition duration-150 edit-btn">Editar</button>
                        <button onclick="window.deleteMission('${encodedId}')" class="text-red-500 hover:text-red-700 transition duration-150 remove-btn">Excluir</button>
                    </td>
                ` : '';

                missionsBody.innerHTML += `
                    <tr class="hover:bg-gray-700/50">
                        <td class="px-6 py-2 whitespace-nowrap text-sm font-medium text-white">${data.name}</td>
                        <td class="px-6 py-2 whitespace-nowrap text-sm text-yellow-400 font-semibold">${data.baseRank.replace('-Rank', '')}</td>
                        <td class="px-6 py-2 whitespace-nowrap text-sm text-green-400">${data.points}</td>
                        ${actionCell}
                    </tr>
                `;
            });
        }
        
        // --- Fun√ß√µes Auxiliares e L√≥gica de Dados ---
        function cleanRankForLookup(rank) {
            if (!rank) return '';
            return rank.toUpperCase().replace(/[-\s\/]/g, '');
        }

        function normalizeId(id) {
            if (!id) return '';
            return id.trim().toLowerCase();
        }
        
        window.addExecutorEntry = function() {
            const select = document.getElementById('new-executor-id-select');
            const id = select.value;
            const statusElement = document.getElementById('status');

            if (!id) {
                statusElement.textContent = '‚ö†Ô∏è Por favor, selecione um ID de Guardi√£o da lista.';
                statusElement.className = 'text-yellow-400 p-4 bg-yellow-900/50 rounded-lg block';
                setTimeout(() => statusElement.classList.add('hidden'), 5000);
                return;
            }

            if (selectedExecutors.includes(id)) {
                 statusElement.textContent = `‚ö†Ô∏è ID "${id}" j√° est√° na lista de Executores.`;
                 statusElement.className = 'text-yellow-400 p-4 bg-yellow-900/50 rounded-lg block';
                 setTimeout(() => statusElement.classList.add('hidden'), 5000);
                 return;
            }

            selectedExecutors.push(id);
            select.value = "";
            statusElement.classList.add('hidden');
            window.updateExecutorTags();
        }

        window.removeExecutorEntry = function(idToRemove) {
            selectedExecutors = selectedExecutors.filter(id => id !== idToRemove);
            window.updateExecutorTags();
        }

        window.updateExecutorTags = function(runPreview = true) {
            const container = document.getElementById('executors-tag-container');
            if (!container) return;

            let contentHTML = '';
            
            if (selectedExecutors.length === 0) {
                 contentHTML = '<span id="no-executor-message" class="text-gray-400 text-sm italic">Nenhum executor selecionado.</span>';
                 
            } else {
                 selectedExecutors.forEach(id => {
                    contentHTML += `<span class="executor-tag">${id} <span class="executor-remove-btn" onclick="window.removeExecutorEntry('${id}')">√ó</span></span>`;
                 });
            }
            
            container.innerHTML = contentHTML; 
            window.updateExecutorSelect(); 
            if (runPreview) window.updateDescriptionPreview();
        }

        window.updateExecutorSelect = function() {
            const select = document.getElementById('new-executor-id-select');
            if (!select) return;

            select.innerHTML = '<option value="" disabled selected>Selecione um Guardi√£o Ativo</option>';

            const ninjas = Object.values(ninjasData).filter(n => n.isActive);
            ninjas.forEach(ninja => {
                if (!selectedExecutors.includes(ninja.id)) {
                    const option = document.createElement('option');
                    option.value = ninja.id;
                    option.textContent = ninja.id;
                    select.appendChild(option);
                }
            });
        }
        
        window.updateMissionSelects = function(runPreview = true) {
            const selects = document.querySelectorAll('.mission-select-dropdown');
            if (selects.length === 0) return;
            
            const missionsArray = Object.values(missionsData);
            
            const orderedMissions = missionsArray.sort((a, b) => {
                const rankA = cleanRankForLookup(a.baseRank);
                const rankB = cleanRankForLookup(b.baseRank);
                
                const indexA = RANK_ORDER.findIndex(prefix => rankA.startsWith(prefix));
                const indexB = RANK_ORDER.findIndex(prefix => rankB.startsWith(prefix));

                if (indexA !== indexB) return indexA - indexB;
                return a.name.localeCompare(b.name);
            });

            const missionOptions = orderedMissions
                .map(m => `<option value="${m.name}" data-rank="${m.baseRank}" data-points="${m.points}">${m.name} (Rank ${m.baseRank.replace('-Rank', '')}, ${m.points} Pts)</option>`).join(''); 

            selects.forEach(select => {
                const currentValue = select.value;
                select.innerHTML = `<option value="" disabled ${!currentValue ? 'selected' : ''}>Selecione a Miss√£o</option>` + missionOptions;
                if (currentValue) {
                    select.value = currentValue;
                }
            });
            if (runPreview) window.updateDescriptionPreview();
        }

        window.addMissionEntry = function(initialValue = '', runPreview = true) {
            const container = document.getElementById('missions-entry-container');
            if (!container) return;
            
            const newIndex = container.children.length;

            const missionEntryHtml = `
                <div class="flex gap-2 items-center mission-entry" data-index="${newIndex}">
                    <select id="service-name-${newIndex}" class="mission-select-dropdown w-full p-2.5 rounded-lg bg-gray-700 border border-gray-600 focus:ring-blue-500 focus:border-blue-500 text-white shadow-inner" onchange="window.updateDescriptionPreview()">
                        <!-- Options filled by updateMissionSelects -->
                    </select>
                    <button type="button" class="remove-btn bg-red-600 hover:bg-red-700 text-white p-2 rounded-lg transition duration-200" onclick="window.removeMissionEntry(this)">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 011 1v6a1 1 0 11-2 0V9a1 1 0 011-1zm5 0a1 1 0 011 1v6a1 1 0 11-2 0V9a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                    </button>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', missionEntryHtml);
            
            window.updateMissionSelects(runPreview);

            if (initialValue) {
                document.getElementById(`service-name-${newIndex}`).value = initialValue;
            }
            
            const entries = container.querySelectorAll('.mission-entry');
            if (entries.length === 1) {
                entries[0].querySelector('.remove-btn').classList.add('hidden');
            } else if (entries.length > 1) {
                entries.forEach(entry => entry.querySelector('.remove-btn').classList.remove('hidden'));
            }
        }
        
        window.removeMissionEntry = function(button) {
            const entry = button.closest('.mission-entry');
            entry.remove();
            window.updateDescriptionPreview();
            
            const container = document.getElementById('missions-entry-container');
            if (container) {
                const entries = container.querySelectorAll('.mission-entry');
                if (entries.length === 1) {
                    entries[0].querySelector('.remove-btn').classList.add('hidden');
                }
                if (entries.length === 0) {
                    window.addMissionEntry();
                }
            }
        }

        window.generateReportId = function() {
            currentReportId = Math.random().toString(36).substring(2, 10).toUpperCase();
            const reportDisplay = document.getElementById('report-id-display');
            if (reportDisplay) reportDisplay.value = currentReportId;
        }
        
        window.copyReportId = function() {
            const reportDisplay = document.getElementById('report-id-display');
            if (!reportDisplay) return;

            const text = reportDisplay.value;
            const tempInput = document.createElement('input');
            tempInput.value = text;
            document.body.appendChild(tempInput);
            tempInput.select();
            
            try {
                document.execCommand('copy'); 
                console.log('ID do Relat√≥rio copiado: ' + text);
            } catch (err) {
                console.error('Falha ao copiar ID para o clipboard:', err);
            }
            document.body.removeChild(tempInput);
        }

        function getRankColor(rank) {
            const base = rank.toUpperCase().replace('-RANK', '').trim();
            switch (base) {
                case 'S': return 'text-purple-400';
                case 'A': return 'text-red-400';
                case 'B': return 'text-yellow-400';
                case 'C': return 'text-green-400';
                case 'D': return 'text-blue-400';
                case 'DEFESA/RAID': return 'text-pink-400';
                case 'NPC QUEST':
                case 'STORYLINE':
                default: return 'text-gray-400';
            }
        }

        function getRankIcon(rank) {
            switch (rank) {
                case 1: return '<span class="text-yellow-500 text-xl">ü•á</span>';
                case 2: return '<span class="text-gray-400 text-xl">ü•à</span>';
                case 3: return '<span class="text-orange-600 text-xl">ü•â</span>';
                default: return `<span class="text-gray-500">${rank}¬∞</span>`;
            }
        }

        // --- L√≥gica de CRUD Firestore ---
        window.addMission = async function() {
            if (!isWriterMode) return;
            // ... (L√≥gica de addMission)
            const name = document.getElementById('new-mission-name').value.trim();
            const rank = document.getElementById('new-mission-rank-select').value.trim();
            const cleanRank = cleanRankForLookup(rank);
            const points = RANK_POINTS[cleanRank] || 0;

            if (!name || !rank || missionsData[name]) {
                console.error('Nome, Rank e Miss√£o n√£o pode ser duplicada.');
                return;
            }

            try {
                const missionRef = doc(db, COLLECTIONS.MISSIONS, name); 
                
                await setDoc(missionRef, {
                    name: name,
                    baseRank: rank,
                    points: points,
                    id: name
                });
                document.getElementById('new-mission-name').value = '';
                console.log(`Miss√£o "${name}" (Rank ${rank}, ${points} Pts) adicionada com sucesso!`);
            } catch (error) {
                console.error("Erro ao adicionar miss√£o:", error);
            }
        }
        
        window.editMission = async function(encodedId, encodedName, encodedRank) {
            if (!isWriterMode) return; 
            const docId = decodeURIComponent(encodedId); 
            const currentName = decodeURIComponent(encodedName);
            const currentRank = decodeURIComponent(encodedRank);

            const result = await openCustomModal(
                `Editar Miss√£o: ${currentName}`,
                'Altere o nome e o rank da miss√£o abaixo.',
                'input',
                { name: currentName, rank: currentRank }
            );

            if (!result || result === false) return;
            
            const { name: finalName, rank: finalRank } = result;

            try {
                const cleanRank = cleanRankForLookup(finalRank);
                const newPoints = RANK_POINTS[cleanRank] || 0;
                const currentRef = doc(db, COLLECTIONS.MISSIONS, docId);
                
                if (finalName !== currentName) {
                    const newRef = doc(db, COLLECTIONS.MISSIONS, finalName);
                    
                    const newSnap = await getDoc(newRef);
                    if (newSnap.exists()) {
                         console.error(`Erro: O novo nome da miss√£o "${finalName}" j√° existe.`);
                         return;
                    }

                    await setDoc(newRef, {
                        name: finalName,
                        baseRank: finalRank,
                        points: newPoints,
                        id: finalName 
                    });
                    await deleteDoc(currentRef); 
                    console.log(`Miss√£o ${currentName} movida/editada para ${finalName}.`);

                } else {
                    await updateDoc(currentRef, {
                        baseRank: finalRank,
                        points: newPoints
                    });
                    console.log(`Miss√£o ${finalName} atualizada para Rank ${finalRank} (${newPoints} Pts).`);
                }
            } catch (error) {
                console.error("Erro ao editar miss√£o:", error);
            }
        }

        window.deleteMission = async function(encodedId) {
            if (!isWriterMode) return; 
            const id = decodeURIComponent(encodedId); 

            const shouldDelete = await openCustomModal(
                'Confirma√ß√£o de Exclus√£o',
                `Tem certeza que deseja EXCLUIR a miss√£o: "${id}"? Isso √© irrevers√≠vel.`,
                'confirm'
            );
            
            if (!shouldDelete) return;

            try {
                await deleteDoc(doc(db, COLLECTIONS.MISSIONS, id)); 
                console.log(`Miss√£o ${id} exclu√≠da.`);
            } catch (error) {
                console.error("Erro ao excluir miss√£o:", error);
            }
        }
        
        window.addNinja = async function() {
            if (!isMasterAdminMode) return; // Apenas Master Admin
            const newNinjaIdInput = document.getElementById('new-ninja-id');
            let ninjaId = newNinjaIdInput ? newNinjaIdInput.value.trim() : '';

            if (!ninjaId) {
                console.error('Por favor, digite o ID do Guardi√£o.');
                return; 
            }
            
            const normalizedId = normalizeId(ninjaId); 

            try {
                const ninjaRef = doc(db, COLLECTIONS.NINJAS, normalizedId);
                const ninjaSnap = await getDoc(ninjaRef);
                const currentNinja = ninjaSnap.exists() ? ninjaSnap.data() : { rankPoints: 0, missionsCompleted: 0 };

                await setDoc(ninjaRef, { 
                    id: normalizedId, 
                    isActive: true,
                    rankPoints: currentNinja.rankPoints,
                    missionsCompleted: currentNinja.missionsCompleted
                }, { merge: true });
                if (newNinjaIdInput) newNinjaIdInput.value = '';
                console.log(`Guardi√£o "${normalizedId}" adicionado/atualizado com sucesso!`);
            } catch (error) {
                console.error("Erro ao adicionar Guardi√£o:", error);
            }
        }
        
        window.deleteNinja = async function(encodedId) {
            if (!isMasterAdminMode) return; // Apenas Master Admin
            const id = decodeURIComponent(encodedId); 
            const normalizedId = normalizeId(id); 
            
            const shouldDelete = await openCustomModal(
                'Confirma√ß√£o de Exclus√£o de Guardi√£o',
                `Tem certeza que deseja EXCLUIR o Guardi√£o **${normalizedId}**? Isso o REMOVE do cadastro e do ranking.`,
                'confirm'
            );
            
            if (!shouldDelete) return;

            try {
                await deleteDoc(doc(db, COLLECTIONS.NINJAS, normalizedId)); 
                const auxRef = doc(db, COLLECTIONS.AUXILIARY_LOG, normalizedId); 
                await deleteDoc(auxRef).catch(() => {}); 
                console.log(`Guardi√£o ${normalizedId} exclu√≠do.`);
            } catch (error) {
                console.error("Erro ao excluir Guardi√£o:", error);
            }
        }
        
        window.editNinja = async function(encodedId) {
            if (!isMasterAdminMode) return; // Apenas Master Admin
            const id = decodeURIComponent(encodedId);
            const normalizedId = normalizeId(id); 
            const currentNinja = ninjasData[normalizedId];
            
            if (!currentNinja) return;
            
            const newStatus = await openCustomModal(
                `Alternar Status do Guardi√£o: ${normalizedId}`,
                '', 
                'ninjaEdit',
                { id: normalizedId, isActive: currentNinja.isActive }
            );

            if (!newStatus) return;

            try {
                const newIsActive = !currentNinja.isActive;
                await updateDoc(doc(db, COLLECTIONS.NINJAS, normalizedId), { 
                    isActive: newIsActive
                });
                console.log(`Status do Guardi√£o ${normalizedId} atualizado para ${newIsActive ? 'ATIVO' : 'INATIVO'}.`);
            } catch (error) {
                console.error("Erro ao editar Guardi√£o:", error);
            }
        }

        window.submitReport = async function() {
            if (!isWriterMode) {
                 document.getElementById('status').textContent = '‚ö†Ô∏è Erro: Voc√™ precisa de autoriza√ß√£o de escrita para registrar relat√≥rios.';
                 document.getElementById('status').className = 'text-yellow-400 p-4 bg-yellow-900/50 rounded-lg block';
                 setTimeout(() => document.getElementById('status').classList.add('hidden'), 7000);
                 return;
            }
            
            const { totalPointsRaw, finalReportRank, serviceNames, executorIds, supportIds } = calculateTotalPointsAndRank();

            if (executorIds.length === 0) {
                 document.getElementById('status').textContent = '‚ö†Ô∏è Erro: Por favor, selecione pelo menos um ID Ninja Executor.';
                 document.getElementById('status').className = 'text-yellow-400 p-4 bg-yellow-900/50 rounded-lg block';
                 setTimeout(() => document.getElementById('status').classList.add('hidden'), 7000);
                 return;
            }
            
            const clientsInput = document.getElementById('clients');
            const missionDetailsInput = document.getElementById('mission-details');
            
            const clients = clientsInput ? clientsInput.value.split(',').map(c => c.trim()).filter(c => c) : [];
            const missionDetails = missionDetailsInput ? missionDetailsInput.value.trim() : '';


            if (serviceNames.length === 0 || clients.length === 0 || !missionDetails) {
                document.getElementById('status').textContent = '‚ö†Ô∏è Erro: Por favor, selecione pelo menos uma miss√£o e preencha todos os campos de cabe√ßalho (Clientes e Detalhes da Miss√£o).';
                document.getElementById('status').className = 'text-yellow-400 p-4 bg-yellow-900/50 rounded-lg block';
                setTimeout(() => document.getElementById('status').classList.add('hidden'), 7000);
                return;
            }
            
            const description = document.getElementById('description-preview').textContent;
            const pointsToAward = totalPointsRaw; 

            try {
                const batch = writeBatch(db);

                // 1. Registro do Relat√≥rio
                const reportData = {
                    reportId: currentReportId,
                    serviceNames: serviceNames,
                    finalReportRank: finalReportRank,
                    clients: clients,
                    executorIds: executorIds,
                    supportIds: supportIds, 
                    description: description,
                    totalPointsRaw: totalPointsRaw,
                    timestamp: new Date().toISOString()
                };
                batch.set(doc(db, COLLECTIONS.REPORTS, currentReportId), reportData);

                // 2. Atualiza√ß√£o dos Ninjas Executores: Cada um recebe a pontua√ß√£o bruta total
                for (const executorId of executorIds) {
                    const ninjaRef = doc(db, COLLECTIONS.NINJAS, executorId); 
                    let ninja = ninjasData[executorId] || { id: executorId, rankPoints: 0, missionsCompleted: 0, isActive: true };
                    
                    batch.set(ninjaRef, {
                        rankPoints: (ninja.rankPoints || 0) + pointsToAward,
                        missionsCompleted: (ninja.missionsCompleted || 0) + serviceNames.length, 
                        id: executorId,
                        isActive: true
                    }, { merge: true });
                }
                
                // 3. Atualiza√ß√£o do Log de Aux√≠lio: Cada um recebe a pontua√ß√£o bruta total
                const currentTime = new Date().toISOString();
                for (const supportId of supportIds) {
                    const auxRef = doc(db, COLLECTIONS.AUXILIARY_LOG, supportId); 
                    let aux = auxiliaryData[supportId] || { id: supportId, rankPoints: 0, lastParticipation: currentTime };
                    
                    batch.set(auxRef, {
                        rankPoints: (aux.rankPoints || 0) + pointsToAward,
                        lastParticipation: currentTime,
                        id: supportId 
                    }, { merge: true });
                }

                await batch.commit();

                // Limpeza de UI
                selectedExecutors = [];
                document.querySelectorAll('#report-form-section input[type="text"]').forEach(input => {
                     if (input.id !== 'total-points' && input.id !== 'report-id-display') {
                         input.value = '';
                     }
                });

                document.getElementById('total-points').value = '0';
                document.getElementById('description-preview').textContent = 'A descri√ß√£o do relat√≥rio aparecer√° aqui ao preencher o formul√°rio.';
                document.getElementById('submit-report').disabled = true;
                
                document.getElementById('missions-entry-container').innerHTML = '';
                window.addMissionEntry(null, false);
                window.generateReportId(); 

                // Mensagem de sucesso
                document.getElementById('status').textContent = `‚úÖ Sucesso! Relat√≥rio "${currentReportId}" registrado. ${pointsToAward} pontos adicionados a cada participante.`;
                document.getElementById('status').className = 'text-green-400 p-4 bg-green-900/50 rounded-lg block';
                setTimeout(() => document.getElementById('status').classList.add('hidden'), 7000);
                
            } catch (error) {
                console.error("Erro fatal ao registrar no Firebase:", error);
                 document.getElementById('status').textContent = `‚ùå Erro fatal ao registrar no Firebase: ${error.message}`;
                 document.getElementById('status').className = 'text-red-400 p-4 bg-red-900/50 rounded-lg block';
                 setTimeout(() => document.getElementById('status').classList.add('hidden'), 7000);
            }
        }


        window.updateDescriptionPreview = function() {
            // VERIFICA√á√ÉO DE SEGURAN√áA para elementos de input
            const clientsInput = document.getElementById('clients');
            const missionDetailsInput = document.getElementById('mission-details');
            const descriptionPreview = document.getElementById('description-preview');
            const submitButton = document.getElementById('submit-report');
            const totalPointsInput = document.getElementById('total-points');
            
            if (!clientsInput || !missionDetailsInput || !descriptionPreview || !submitButton || !totalPointsInput) return;
            
            const clients = clientsInput.value.trim();
            const missionDetails = missionDetailsInput.value.trim();
            
            const { totalPointsRaw, finalReportRank, serviceNames, executorIds, supportIds } = calculateTotalPointsAndRank();

            totalPointsInput.value = totalPointsRaw;

            // CORRE√á√ÉO DE VALIDA√á√ÉO: Se o formul√°rio estiver limpo (estado de reset/primeira carga), apenas reseta a descri√ß√£o.
            if (executorIds.length === 0 && totalPointsRaw === 0 && !clients && !missionDetails) {
                 descriptionPreview.textContent = 'A descri√ß√£o do relat√≥rio aparecer√° aqui ao preencher o formul√°rio.';
                 submitButton.disabled = true;
                 return;
            }

            let description = 'Aguardando informa√ß√µes...';
            
            // Vari√°veis de descri√ß√£o inicializadas
            const clientsList = clients.split(',').map(c => c.trim()).filter(c => c).join(', ');
            const executorsText = executorIds.join(', ');
            const supportText = supportIds.length > 0 ? ` com o aux√≠lio de ${supportIds.join(', ')}` : '';
            const servicesText = serviceNames.length > 1 ? serviceNames.join(', ') : serviceNames[0]; 
            const pointsText = `(Total de ${totalPointsRaw} Pts). Rank Final: ${finalReportRank}.`;

            
            if (serviceNames.length > 0 && executorIds.length > 0 && clients && missionDetails) {
                // Descri√ß√£o Completa
                description = `O(s) Guardi√£o(√µes) executor(es) ${executorsText}${supportText} atendeu(eram) √† solicita√ß√£o dos clientes ${clientsList} concluindo o(s) servi√ßo(s): ${servicesText}. O objetivo prim√°rio era: "${missionDetails}". Pedido atendido com sucesso. ${pointsText} Relat√≥rio registrado e conclu√≠do.`;
                submitButton.disabled = false;
            } else {
                // Descri√ß√£o Incompleta / Guia de Erro
                 description = `Faltando informa√ß√µes para completar o relat√≥rio: ${executorIds.length === 0 ? '[Falta Executor]' : ''} ${serviceNames.length === 0 ? '[Falta Miss√£o]' : ''} ${!clients ? '[Falta Cliente]' : ''} ${!missionDetails ? '[Falta Detalhe]' : ''}`;
                 submitButton.disabled = true;
            }
            
            descriptionPreview.textContent = description;
        }

        function calculateTotalPointsAndRank() {
            const selects = document.querySelectorAll('.mission-select-dropdown');
            let totalPointsRaw = 0;
            let highestRank = '';
            const selectedMissionNames = [];

            const getRankIndex = (rankClean) => {
                return RANK_ORDER.findIndex(prefix => rankClean.startsWith(prefix));
            };

            selects.forEach(select => {
                const missionName = select.value;
                const mission = missionsData[missionName]; 
                
                if (mission) {
                    totalPointsRaw += mission.points;
                    selectedMissionNames.push(mission.name);
                    
                    const currentRankClean = cleanRankForLookup(mission.baseRank);
                    const highestRankClean = cleanRankForLookup(highestRank); 

                    const currentIndex = getRankIndex(currentRankClean);
                    const highestIndex = getRankIndex(highestRankClean); 

                    if (highestIndex === -1 || currentIndex < highestIndex) {
                        highestRank = mission.baseRank;
                    }
                }
            });
            
            const executorIds = selectedExecutors;
            const supportIds = document.getElementById('support-ids') ? 
                document.getElementById('support-ids').value.split(',').map(id => normalizeId(id)).filter(id => id) : [];
            
            if (highestRank === '') {
                highestRank = 'N/A';
            }
            
            return { 
                totalPointsRaw: totalPointsRaw, 
                finalReportRank: highestRank, 
                serviceNames: selectedMissionNames,
                executorIds: executorIds,
                supportIds: supportIds
            };
        }


        // --- Fun√ß√µes de Renderiza√ß√£o de Tabela de Dados (Chamadas pelo Roteador) ---
        
        window.renderScoreboard = function() {
            const scoreboardBody = document.getElementById('ninjas-scoreboard');
            if (!scoreboardBody) return; 
            
            const guardians = Object.values(ninjasData).filter(n => n.isActive); 
            guardians.sort((a, b) => b.rankPoints - a.rankPoints);
            
            scoreboardBody.innerHTML = '';

            guardians.forEach((ninja, index) => {
                const rankIcon = getRankIcon(index + 1);
                scoreboardBody.innerHTML += `
                    <tr class="hover:bg-gray-700/50">
                        <td class="px-6 py-2 whitespace-nowrap text-sm font-bold text-center">${rankIcon}</td>
                        <td class="px-6 py-2 whitespace-nowrap text-sm font-medium text-blue-300">${ninja.id}</td>
                        <td class="px-6 py-2 whitespace-nowrap text-sm font-bold text-green-400">${Math.round(ninja.rankPoints)} Pts</td>
                        <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-300">${ninja.missionsCompleted || 0}</td>
                    </tr>
                `;
            });
        }
        
        window.renderAuxilio = function() {
            const auxiliaryLogBody = document.getElementById('auxiliary-log');
            if (!auxiliaryLogBody) return;
            
            const sortedAuxiliaries = Object.values(auxiliaryData).sort((a, b) => b.rankPoints - a.rankPoints);
            
            auxiliaryLogBody.innerHTML = '';
            
            sortedAuxiliaries.forEach(data => {
                const lastParticipation = data.lastParticipation ? new Date(data.lastParticipation).toLocaleDateString('pt-BR') : 'N/A';
                
                auxiliaryLogBody.innerHTML += `
                    <tr class="hover:bg-gray-700/50">
                        <td class="px-6 py-2 whitespace-nowrap text-sm font-medium text-orange-300">${data.id}</td>
                        <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-400">${lastParticipation}</td>
                        <td class="px-6 py-2 whitespace-nowrap text-sm font-semibold text-green-400">${Math.round(data.rankPoints || 0)} Pts</td>
                    </tr>
                `;
            });
        }
        
        window.renderReportsLog = function() {
            window.renderReportsLogFiltered(null, 'reports-log');
        }

        window.renderNinjasTable = function() {
            const ninjasBody = document.getElementById('ninjas-cadastro');
            if (!ninjasBody) return; 
            
            const showActionColumn = isMasterAdminMode;

            const actionHeader = ninjasBody.closest('table').querySelector('th.admin-only');
            if (actionHeader) {
                if (showActionColumn) actionHeader.classList.remove('hidden');
                else actionHeader.classList.add('hidden');
            }

            const sortedNinjas = Object.values(ninjasData).sort((a, b) => a.id.localeCompare(b.id));
            
            ninjasBody.innerHTML = '';

            sortedNinjas.forEach(data => {
                
                const statusClass = data.isActive ? 'text-green-400' : 'text-red-400';
                const statusText = data.isActive ? 'Ativo' : 'Inativo';
                
                const actionCell = showActionColumn ? `
                    <td class="px-6 py-2 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="window.editNinja('${data.id}')" class="text-blue-500 hover:text-blue-700 transition duration-150 edit-btn mr-2">Editar Status</button>
                        <button onclick="window.deleteNinja('${data.id}')" class="text-red-500 hover:text-red-700 transition duration-150">Excluir</button>
                    </td>
                ` : '';

                ninjasBody.innerHTML += `
                    <tr class="hover:bg-gray-700/50">
                        <td class="px-6 py-2 whitespace-nowrap text-sm font-medium text-white">${data.id}</td>
                        <td class="px-6 py-2 whitespace-nowrap text-sm ${statusClass}">${statusText}</td>
                        ${actionCell}
                    </tr>
                `;
            });
            
            if (document.getElementById('add-ninja-form')) {
                if (isMasterAdminMode) {
                    document.getElementById('add-ninja-form').classList.remove('hidden');
                } else {
                    document.getElementById('add-ninja-form').classList.add('hidden');
                }
            }
        }
        
        window.renderMissionsDatabase = function() {
            const missionsBody = document.getElementById('missions-database');
            if (!missionsBody) return; 
            
            missionsBody.innerHTML = '';
            
            const showActionColumn = isWriterMode; // A√ß√£o de Quests liberada para Escritor/Admin
            const sortedMissions = Object.values(missionsData).sort((a, b) => a.name.localeCompare(b.name));

            const actionHeader = missionsBody.closest('table').querySelector('th.writer-only');
            if (actionHeader) {
                if (showActionColumn) actionHeader.classList.remove('hidden');
                else actionHeader.classList.add('hidden');
            }
            
            if (document.getElementById('add-mission-form')) {
                if (isWriterMode) {
                    document.getElementById('add-mission-form').classList.remove('hidden');
                } else {
                    document.getElementById('add-mission-form').classList.add('hidden');
                }
            }


            sortedMissions.forEach(data => {
                const encodedId = encodeURIComponent(data.id);
                const encodedName = encodeURIComponent(data.name);
                const encodedRank = encodeURIComponent(data.baseRank);
                
                const actionCell = showActionColumn ? `
                    <td class="px-6 py-2 whitespace-nowrap text-right text-sm font-medium flex gap-2">
                        <button onclick="window.editMission('${encodedId}', '${encodedName}', '${encodedRank}')" class="text-blue-500 hover:text-blue-700 transition duration-150 edit-btn">Editar</button>
                        <button onclick="window.deleteMission('${encodedId}')" class="text-red-500 hover:text-red-700 transition duration-150 remove-btn">Excluir</button>
                    </td>
                ` : '';

                missionsBody.innerHTML += `
                    <tr class="hover:bg-gray-700/50">
                        <td class="px-6 py-2 whitespace-nowrap text-sm font-medium text-white">${data.name}</td>
                        <td class="px-6 py-2 whitespace-nowrap text-sm text-yellow-400 font-semibold">${data.baseRank.replace('-Rank', '')}</td>
                        <td class="px-6 py-2 whitespace-nowrap text-sm text-green-400">${data.points}</td>
                        ${actionCell}
                    </tr>
                `;
            });
        }

        // --- Inicializa√ß√£o ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase(); 

            const content = document.getElementById('content');
            
            // Listeners delegados para os bot√µes que n√£o est√£o sempre no DOM
            content.addEventListener('click', (e) => {
                if (e.target.id === 'add-executor-btn') {
                    window.addExecutorEntry();
                } else if (e.target.id === 'add-mission-btn') {
                    window.addMissionEntry();
                } else if (e.target.id === 'submit-report') {
                    window.submitReport();
                } else if (e.target.id === 'set-access-key-btn') { // NOVO BOT√ÉO DE LOGIN
                    window.checkAccessKey();
                } else if (e.target.id === 'add-ninja') {
                    window.addNinja();
                } else if (e.target.id === 'add-mission') {
                    window.addMission();
                }
            });

            // Listeners para inputs no formul√°rio de relat√≥rio que requerem preview (devem ser delegados ou adicionados ap√≥s render)
            content.addEventListener('input', (e) => {
                if (['clients', 'mission-details', 'support-ids'].includes(e.target.id)) {
                    window.updateDescriptionPreview();
                }
            });
        });
    </script>
</body>
</html>
