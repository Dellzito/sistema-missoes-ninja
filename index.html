<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Registro de Miss√µes Ninja (ONLINE - FIREBASE)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 4px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        .remove-btn, .edit-btn, .admin-only, .writer-only { transition: all 0.1s ease-in-out; }
        /* Estilo para a lista de executores */
        .executor-list-container {
            min-height: 50px;
            padding: 8px;
            border: 1px solid #4b5563; /* gray-600 */
            border-radius: 8px;
            background-color: #374151; /* gray-700 */
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        .executor-tag {
            display: flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 9999px; /* full rounded */
            font-size: 0.875rem; /* text-sm */
            font-weight: 600;
            background-color: #3b82f6; /* blue-500 */
            color: #fff;
        }
        .executor-remove-btn {
            margin-left: 6px;
            cursor: pointer;
            color: #bfdbfe; /* blue-200 */
        }
        /* Estilo para a Navega√ß√£o */
        .nav-link {
            cursor: pointer;
            padding: 10px 15px;
            font-weight: 600;
            transition: all 0.2s;
        }
        .nav-link:hover:not(.active) {
            background-color: #1e293b; /* slate-800 */
        }
        .nav-link.active {
            color: #fcd34d; /* amber-300 */
            border-bottom: 2px solid #fcd34d;
        }
    </style>
</head>
<body class="p-4 sm:p-8 text-gray-100">

    <div id="app" class="max-w-6xl mx-auto space-y-8">
        
        <!-- HEADER e NAVEGA√á√ÉO -->
        <header class="pb-4 border-b border-blue-700/50">
            <h1 class="text-4xl font-bold text-blue-400 text-center mb-4">üìú Sistema de Registro de Miss√µes Ninja</h1>
            <!-- Reorganiza√ß√£o dos links de navega√ß√£o -->
            <nav class="flex justify-center bg-gray-900 rounded-xl shadow-lg p-1">
                <a class="nav-link" onclick="window.renderPage('home')" id="nav-home">Home</a>
                <a class="nav-link" onclick="window.renderPage('scoreboard')" id="nav-scoreboard">Ver Rank</a>
                <a class="nav-link" onclick="window.renderPage('reports_log')" id="nav-reports_log">Hist√≥rico</a>
                <a class="nav-link" onclick="window.renderPage('auxiliary_log')" id="nav-auxiliary_log">Aux√≠lio</a>
                <a class="nav-link" onclick="window.renderPage('ninja_panel')" id="nav-ninja_panel">Painel de Ninjas</a>
                <a class="nav-link" onclick="window.renderPage('report_form')" id="nav-report_form">Criar Relat√≥rio</a>
                <a class="nav-link" onclick="window.renderPage('admin_panel')" id="nav-admin_panel">Autoriza√ß√£o</a>
            </nav>
        </header>
        
        <!-- Conte√∫do principal de Roteamento -->
        <div id="content" class="min-h-[60vh]">
            <!-- O conte√∫do da p√°gina ativa ser√° injetado aqui -->
        </div>

        <!-- Loading and Error State -->
        <div id="status" class="text-center p-4 rounded-lg hidden"></div>
        
        <!-- Auth Info for Debugging/Sharing -->
        <div id="auth-info" class="text-sm text-center text-yellow-500">Conectando ao Firebase...</div>
    </div>

    <!-- MODAL DE CONFIRMA√á√ÉO/EDI√á√ÉO CUSTOMIZADO -->
    <div id="custom-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div id="modal-content" class="bg-gray-800 rounded-xl shadow-2xl p-6 w-full max-w-lg space-y-4 transform scale-95 transition-all">
            <h3 id="modal-title" class="text-xl font-bold text-blue-400">T√≠tulo do Modal</h3>
            <p id="modal-message" class="text-gray-300">Mensagem do Modal.</p>
            <div id="modal-input-container" class="space-y-3 hidden">
                <label id="input-label-1" for="modal-input-1" class="block text-sm font-medium text-gray-300">Input 1</label>
                <input type="text" id="modal-input-1" class="w-full p-2.5 rounded-lg bg-gray-700 border border-gray-600 text-white" />
                <label id="input-label-2" for="modal-input-2" class="block text-sm font-medium text-gray-300">Input 2 (Rank)</label>
                <select id="modal-input-2" class="w-full p-2.5 rounded-lg bg-gray-700 border border-gray-600 text-white">
                    <!-- Op√ß√µes de Rank ser√£o injetadas -->
                </select>
                <span id="modal-error" class="text-red-400 text-sm hidden"></span>
            </div>
            <div id="modal-actions" class="flex justify-end gap-3 pt-2">
                <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg transition duration-150">Cancelar</button>
                <button id="modal-confirm-btn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition duration-150">Confirmar</button>
            </div>
        </div>
    </div>
    <!-- FIM DO MODAL -->

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, setDoc, onSnapshot, collection, writeBatch, 
            updateDoc, getDoc, deleteDoc, setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ====================================================================
        // CONFIGURA√á√ïES FIREBASE & CHAVE MESTRA
        // ====================================================================
        
        // VARI√ÅVEIS DE CONFIGURA√á√ÉO DO FIREBASE (DEVE SER CONFIGURADO EM VERCEL/GITHUB SECRETS)
        // OBS: Se estiver no Canvas, a configura√ß√£o √© injetada automaticamente.
        const CUSTOM_FIREBASE_CONFIG = {
            apiKey: "AIzaSyC-QaPr7O6RkWR3vpXCg4zrnUWw3TzU9ss",
            authDomain: "g-2cb53.firebaseapp.com",
            projectId: "g-2cb53",
            storageBucket: "g-2cb53.firebasestorage.app",
            messagingSenderId: "292095146978",
            appId: "1:292095146978:web:836d833230907d081017bb",
            measurementId: "G-B2EXQ2Z75D"
        };
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : CUSTOM_FIREBASE_CONFIG.projectId || 'g-2cb53';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : CUSTOM_FIREBASE_CONFIG;
        
        // CHAVE MESTRA FIXA DO ADMIN MASTER (para o ID 'MASTER_ADMIN')
        const MASTER_ADMIN_ID = 'master_admin_key'; // Este ID √© reservado para o acesso Master
        const WRITER_MODE_ID = 'writer_mode_key'; // Este ID √© reservado para o acesso de Escritor

        let isMasterAdminMode = false; // Controle de acesso total
        let isWriterMode = false; // Controle de acesso para Criar Relat√≥rio / Editar Miss√µes
        let currentPage = 'home';
        
        // Firestore instances and IDs
        let app;
        let db;
        let auth;
        let userId = null;
        let currentReportId = ''; 
        let selectedExecutors = []; 
        
        // Cache de dados (ser√£o preenchidos por onSnapshot)
        let missionsData = {}; 
        let ninjasData = {}; 
        let auxiliaryData = {}; 
        let reportsData = []; 
        let accessKeysData = {}; // NOVO: Cache para IDs/Senhas de Guardi√µes
        
        // Estrutura de Cole√ß√µes (P√∫blica)
        const COLLECTIONS = {
            MISSIONS: `artifacts/${appId}/public/data/missions`,
            REPORTS: `artifacts/${appId}/public/data/reports`,
            NINJAS: `artifacts/${appId}/public/data/ninjas`, 
            AUXILIARY_LOG: `artifacts/${appId}/public/data/auxiliary_log`,
            ACCESS_KEYS: `artifacts/${appId}/public/data/access_keys` // NOVO
        };

        // Mapeamento de Rank para Pontos e Constantes (Mantidas)
        const RANK_POINTS = {
            'SRANK': 5, 'ARANK': 4, 'BRANK': 3, 'CRANK': 2, 'DRANK': 1,
            'DEFESARAID': 10, 'NPCQUEST': 0, 'STORYLINE': 0, 'ANYLEVEL': 0
        };
        const RANK_OPTIONS = [
            "S-Rank", "A-Rank", "B-Rank", "C-Rank", "D-Rank", 
            "Defesa/Raid", "NPC Quest", "Storyline"
        ];
        const RANK_ORDER = ['S', 'A', 'B', 'C', 'D', 'DEFESA'];

        setLogLevel('debug'); 

        // ====================================================================
        // FUN√á√ïES DE UTILIDADE E RENDERIZA√á√ÉO DE DADOS (Movidas para cima)
        // ====================================================================
        
        function getRankIcon(rank) {
            if (rank === 1) return 'ü•á';
            if (rank === 2) return 'ü•à';
            if (rank === 3) return 'ü•â';
            return `#${rank}`;
        }
        function getRankColor(rank) {
            if (rank.includes('S')) return 'text-red-500';
            if (rank.includes('A')) return 'text-orange-500';
            if (rank.includes('B')) return 'text-yellow-500';
            if (rank.includes('C')) return 'text-green-500';
            if (rank.includes('D')) return 'text-blue-500';
            return 'text-gray-400';
        }
        function cleanRankForLookup(rank) {
            return rank.toUpperCase().replace('-', '').replace('/', '');
        }
        function normalizeId(id) {
            return id.trim().toLowerCase();
        }
        
        // --- FUN√á√ïES DE L√ìGICA DO FORMUL√ÅRIO (Popula√ß√£o de Selects) ---

        window.updateExecutorSelect = function() {
            const select = document.getElementById('new-executor-id-select');
            if (!select) return;
            
            // Filtra apenas ninjas ativos para o select de execu√ß√£o
            const activeNinjas = Object.values(ninjasData).filter(n => n.isActive);

            select.innerHTML = '<option value="" disabled selected>Selecione um Guardi√£o Ativo</option>';
            activeNinjas.sort((a, b) => a.id.localeCompare(b.id)).forEach(ninja => {
                const option = document.createElement('option');
                option.value = ninja.id;
                option.textContent = ninja.id;
                select.appendChild(option);
            });
        }

        window.updateMissionSelects = function(resetMissionEntries = true) {
            // Esta fun√ß√£o preenche os selects de miss√£o em cada entrada do relat√≥rio
            const missionSelects = document.querySelectorAll('.mission-select');
            
            // Cria as op√ß√µes de miss√£o a partir dos dados do Firebase
            const missionOptions = Object.values(missionsData)
                .map(m => `<option value="${m.name}" data-rank="${m.baseRank}" data-points="${m.points}">${m.name} (${m.baseRank.replace('-Rank', '')} - ${m.points} Pts)</option>`)
                .sort((a, b) => a.localeCompare(b))
                .join('');

            missionSelects.forEach(select => {
                // Preserva o valor selecionado se houver, ou define um padr√£o
                const currentValue = select.value;
                select.innerHTML = `<option value="" disabled selected>Selecione a Miss√£o</option>` + missionOptions;
                if (currentValue) {
                    select.value = currentValue;
                }
            });
            
            if (resetMissionEntries) {
                // (Stub) L√≥gica futura para recalcular pontos ou adicionar entradas vazias
                // window.calculateTotalPoints();
            }
        }


        // Fun√ß√µes de CRUD (Stubs)
        window.addNinja = function() { console.log("addNinja called (stub)"); }
        window.editNinja = function(id) { console.log(`editNinja called for ${id} (stub)`); }
        window.deleteNinja = function(id) { console.log(`deleteNinja called for ${id} (stub)`); }
        window.addMission = function() { console.log("addMission called (stub)"); }
        window.editMission = function(id, name, rank) { console.log(`editMission called for ${id} (stub)`); }
        window.deleteMission = function(id) { console.log(`deleteMission called for ${id} (stub)`); }
        // window.updateMissionSelects = function() { console.log("updateMissionSelects called (stub)"); } // REMOVIDO STUB, AGORA √â REAL
        // window.updateExecutorSelect = function() { console.log("updateExecutorSelect called (stub)"); }   // REMOVIDO STUB, AGORA √â REAL
        window.updateExecutorTags = function() { console.log("updateExecutorTags called (stub)"); }
        window.generateReportId = function() { console.log("generateReportId called (stub)"); }
        window.addMissionEntry = function() { console.log("addMissionEntry called (stub)"); }
        window.updateDescriptionPreview = function() { console.log("updateDescriptionPreview called (stub)"); }
        window.copyReportId = function() { 
             const reportIdElement = document.getElementById('report-id-display');
             if (reportIdElement) {
                const textToCopy = reportIdElement.value;
                // Uso de execCommand('copy') como fallback para iframe/restri√ß√µes
                const tempInput = document.createElement('textarea');
                tempInput.value = textToCopy;
                document.body.appendChild(tempInput);
                tempInput.select();
                try {
                    document.execCommand('copy');
                    alert('ID do Relat√≥rio copiado para a √°rea de transfer√™ncia: ' + textToCopy);
                } catch (err) {
                    console.error('Falha ao copiar:', err);
                }
                document.body.removeChild(tempInput);
            }
        }
        window.submitReport = function() { console.log("submitReport called (stub)"); }
        // Fim das Fun√ß√µes de CRUD/Stubs

        window.renderScoreboard = function() {
            const scoreboardBody = document.getElementById('ninjas-scoreboard');
            if (!scoreboardBody) return; 
            
            const guardians = Object.values(ninjasData).filter(n => n.isActive); 
            guardians.sort((a, b) => b.rankPoints - a.rankPoints);
            
            scoreboardBody.innerHTML = '';

            guardians.forEach((ninja, index) => {
                const rankIcon = getRankIcon(index + 1);
                scoreboardBody.innerHTML += `
                    <tr class="hover:bg-gray-700/50">
                        <td class="px-6 py-2 whitespace-nowrap text-sm font-bold text-center">${rankIcon}</td>
                        <td class="px-6 py-2 whitespace-nowrap text-sm font-medium text-blue-300">${ninja.id}</td>
                        <td class="px-6 py-2 whitespace-nowrap text-sm font-bold text-green-400">${Math.round(ninja.rankPoints)} Pts</td>
                        <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-300">${ninja.missionsCompleted || 0}</td>
                    </tr>
                `;
            });
        }
        
        window.renderAuxiliaryData = function() {
            const auxiliaryLogBody = document.getElementById('auxiliary-log');
            if (!auxiliaryLogBody) return;
            
            const sortedAuxiliaries = Object.values(auxiliaryData).sort((a, b) => b.rankPoints - a.rankPoints);
            
            auxiliaryLogBody.innerHTML = '';
            
            sortedAuxiliaries.forEach(data => {
                const lastParticipation = data.lastParticipation ? new Date(data.lastParticipation).toLocaleDateString('pt-BR') : 'N/A';
                
                auxiliaryLogBody.innerHTML += `
                    <tr class="hover:bg-gray-700/50">
                        <td class="px-6 py-2 whitespace-nowrap text-sm font-medium text-orange-300">${data.id}</td>
                        <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-400">${lastParticipation}</td>
                        <td class="px-6 py-2 whitespace-nowrap text-sm font-semibold text-green-400">${Math.round(data.rankPoints || 0)} Pts</td>
                    </tr>
                `;
            });
        }

        window.renderReportsLog = function() {
            window.renderReportsLogFiltered(null, 'reports-log');
        }

        window.renderNinjasTable = function() {
            const ninjasBody = document.getElementById('ninjas-cadastro');
            if (!ninjasBody) return; 
            
            const showActionColumn = isMasterAdminMode;

            const actionHeader = ninjasBody.closest('table').querySelector('th.admin-only');
            if (actionHeader) {
                if (showActionColumn) actionHeader.classList.remove('hidden');
                else actionHeader.classList.add('hidden');
            }

            const sortedNinjas = Object.values(ninjasData).sort((a, b) => a.id.localeCompare(b.id));
            
            ninjasBody.innerHTML = '';

            sortedNinjas.forEach(data => {
                
                const statusClass = data.isActive ? 'text-green-400' : 'text-red-400';
                const statusText = data.isActive ? 'Ativo' : 'Inativo';
                
                const actionCell = showActionColumn ? `
                    <td class="px-6 py-2 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="window.editNinja('${data.id}')" class="text-blue-500 hover:text-blue-700 transition duration-150 edit-btn mr-2">Editar Status</button>
                        <button onclick="window.deleteNinja('${data.id}')" class="text-red-500 hover:text-red-700 transition duration-150">Excluir</button>
                    </td>
                ` : '';

                ninjasBody.innerHTML += `
                    <tr class="hover:bg-gray-700/50">
                        <td class="px-6 py-2 whitespace-nowrap text-sm font-medium text-white">${data.id}</td>
                        <td class="px-6 py-2 whitespace-nowrap text-sm ${statusClass}">${statusText}</td>
                        ${actionCell}
                    </tr>
                `;
            });
            
            if (document.getElementById('add-ninja-form')) {
                if (isMasterAdminMode) {
                    document.getElementById('add-ninja-form').classList.remove('hidden');
                } else {
                    document.getElementById('add-ninja-form').classList.add('hidden');
                }
            }
        }
        
        window.renderMissionsDatabase = function() {
            const missionsBody = document.getElementById('missions-database');
            if (!missionsBody) return; 
            
            missionsBody.innerHTML = '';
            
            const showActionColumn = isWriterMode; // A√ß√£o de Quests liberada para Escritor/Admin
            const sortedMissions = Object.values(missionsData).sort((a, b) => a.name.localeCompare(b.name));

            const actionHeader = missionsBody.closest('table').querySelector('th.writer-only');
            if (actionHeader) {
                if (showActionColumn) actionHeader.classList.remove('hidden');
                else actionHeader.classList.add('hidden');
            }
            
            if (document.getElementById('add-mission-form')) {
                if (isWriterMode) {
                    document.getElementById('add-mission-form').classList.remove('hidden');
                } else {
                    document.getElementById('add-mission-form').classList.add('hidden');
                }
            }


            sortedMissions.forEach(data => {
                const encodedId = encodeURIComponent(data.id);
                const encodedName = encodeURIComponent(data.name);
                const encodedRank = encodeURIComponent(data.baseRank);
                
                const actionCell = showActionColumn ? `
                    <td class="px-6 py-2 whitespace-nowrap text-right text-sm font-medium flex gap-2">
                        <button onclick="window.editMission('${encodedId}', '${encodedName}', '${encodedRank}')" class="text-blue-500 hover:text-blue-700 transition duration-150 edit-btn">Editar</button>
                        <button onclick="window.deleteMission('${encodedId}')" class="text-red-500 hover:text-red-700 transition duration-150 remove-btn">Excluir</button>
                    </td>
                ` : '';

                missionsBody.innerHTML += `
                    <tr class="hover:bg-gray-700/50">
                        <td class="px-6 py-2 whitespace-nowrap text-sm font-medium text-white">${data.name}</td>
                        <td class="px-6 py-2 whitespace-nowrap text-sm text-yellow-400 font-semibold">${data.baseRank.replace('-Rank', '')}</td>
                        <td class="px-6 py-2 whitespace-nowrap text-sm text-green-400">${data.points}</td>
                        ${actionCell}
                    </tr>
                `;
            });
        }

        window.renderReportsLogFiltered = function(filterId = null, targetId = 'filtered-reports-log') {
            
            const reportsLog = document.getElementById(targetId);
            const guardianSummaryDiv = document.getElementById('guardian-summary');

            if (!reportsLog) return;
            
            reportsLog.innerHTML = '';
            let filteredReports = reportsData;

            if (filterId) {
                // Filtra relat√≥rios onde o ID est√° como executor OU auxiliar
                filteredReports = reportsData.filter(report => {
                    const isExecutor = Array.isArray(report.executorIds) && report.executorIds.includes(filterId);
                    const isAuxiliary = Array.isArray(report.supportIds) && report.supportIds.includes(filterId);
                    return isExecutor || isAuxiliary;
                });
            }
            
            // Exibe o resumo do Ninja/Auxiliar se o filtro estiver ativo
            if (filterId && guardianSummaryDiv) {
                const ninjaData = ninjasData[filterId];
                const auxData = auxiliaryData[filterId];
                const isGuardian = !!ninjaData;
                
                let points = 0;
                let missions = 0;
                let type = 'ID Inativo';

                if (isGuardian) {
                    points = Math.round(ninjaData.rankPoints);
                    missions = ninjaData.missionsCompleted;
                    type = ninjaData.isActive ? 'Guardi√£o Ativo' : 'Guardi√£o Inativo';
                } else if (auxData) {
                    points = Math.round(auxData.rankPoints);
                    // Conta o n√∫mero de relat√≥rios em que o auxiliar participou
                    missions = reportsData.filter(r => r.supportIds && r.supportIds.includes(filterId)).length;
                    type = 'Auxiliar';
                }

                guardianSummaryDiv.innerHTML = `
                    <p class="text-xl font-bold text-yellow-400">${filterId.toUpperCase()}</p>
                    <p class="text-sm text-gray-300">${type}</p>
                    <p class="text-lg text-green-400">Total de Pontos: ${points} Pts</p>
                    <p class="text-gray-300">Total de Relat√≥rios Envolvidos: ${missions}</p>
                `;
                guardianSummaryDiv.classList.remove('hidden');
            } else if (guardianSummaryDiv) {
                guardianSummaryDiv.classList.add('hidden');
            }


            const sortedReports = filteredReports.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            if (sortedReports.length === 0) {
                 reportsLog.innerHTML = `<tr><td colspan="6" class="px-4 py-4 text-center italic text-gray-500">Nenhum relat√≥rio encontrado${filterId ? ` para o Ninja/Auxiliar "${filterId}"` : ''}.</td></tr>`;
                 return;
            }

            sortedReports.forEach(data => {
                const rankClass = data.finalReportRank ? getRankColor(data.finalReportRank) : 'text-gray-400';
                
                const formattedDate = new Date(data.timestamp).toLocaleDateString('pt-BR', {
                    day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'
                });
                
                const servicesList = data.serviceNames.map(name => 
                    `<span class="text-xs text-gray-400 block">${name}</span>`
                ).join('');
                
                const executorsText = Array.isArray(data.executorIds) ? data.executorIds.join(', ') : data.executorId;
                const finalRankDisplay = data.finalReportRank ? `(Rank ${data.finalReportRank.replace('-Rank', '')})` : '(N/A)';
                
                // Determina o papel do Ninja/Auxiliar para a tabela filtrada
                let role = '';
                if (filterId) {
                    const isExecutor = Array.isArray(data.executorIds) && data.executorIds.includes(filterId);
                    const isAuxiliary = Array.isArray(data.supportIds) && data.supportIds.includes(filterId);
                    if (isExecutor && isAuxiliary) role = 'Executor & Aux√≠lio';
                    else if (isExecutor) role = 'Executor';
                    else if (isAuxiliary) role = 'Aux√≠lio';
                }
                
                // Escolhe o target body correto (reports-log ou filtered-reports-log)
                const targetBody = document.getElementById(targetId);

                if (targetId === 'filtered-reports-log') {
                     // Renderiza a tabela do Painel de Ninjas
                     targetBody.innerHTML += `
                         <tr class="hover:bg-gray-700/50">
                             <td class="px-4 py-2 whitespace-nowrap text-xs text-gray-400 truncate w-1/12">${data.reportId}</td>
                             <td class="px-4 py-2 whitespace-normal text-sm text-white w-2/12">
                                 ${servicesList}
                                 <span class="text-sm ${rankClass} font-bold mt-1 block">${finalRankDisplay}</span>
                             </td>
                             <td class="px-4 py-2 whitespace-normal text-sm text-white w-2/12">
                                 <span class="font-bold text-yellow-300">${role}</span>
                             </td>
                             <td class="px-4 py-2 whitespace-normal text-sm text-green-400 w-2/12">${data.totalPointsRaw} Pts</td>
                             <td class="px-4 py-2 whitespace-normal text-sm italic text-gray-400 w-4/12">${data.description}</td>
                             <td class="px-4 py-2 whitespace-nowrap text-sm w-1/12">
                                 <span class="font-mono text-gray-400 text-xs">${formattedDate}</span>
                             </td>
                         </tr>
                     `;
                } else {
                    // Renderiza a tabela Hist√≥rico Completo
                    targetBody.innerHTML += `
                        <tr class="hover:bg-gray-700/50">
                            <td class="px-4 py-2 whitespace-nowrap text-xs text-gray-400 truncate w-1/12">${data.reportId}</td>
                            <td class="px-4 py-2 whitespace-normal text-sm text-white w-2/12">
                                ${servicesList}
                                <span class="text-sm ${rankClass} font-bold mt-1 block">${finalRankDisplay}</span>
                            </td>
                            <td class="px-4 py-2 whitespace-normal text-sm text-white w-2/12">
                                <span class="font-bold text-blue-300">${executorsText}</span><br>
                                ${data.supportIds && data.supportIds.length > 0 ? `<span class="text-xs text-gray-400">Aux√≠lio: ${data.supportIds.join(', ')}</span>` : '<span class="text-xs text-gray-500">Sem aux√≠lio</span>'}
                            </td>
                            <td class="px-4 py-2 whitespace-normal text-sm text-gray-300 w-2/12">${data.clients.join(', ')}</td>
                            <td class="px-4 py-2 whitespace-normal text-sm italic text-gray-400 w-3/12">${data.description}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm w-1/12">
                                <span class="font-mono text-gray-400 text-xs">${formattedDate}</span>
                            </td>
                        </tr>
                    `;
                }
            });
        }

        // ====================================================================
        // TEMPLATES HTML (Movidos para cima para acesso f√°cil no renderPage)
        // ====================================================================
        window.renderNinjaPanel = function() {
            // Combina IDs de Guardi√µes Ativos/Inativos e IDs de Aux√≠lio em uma √∫nica lista
            const allIdsMap = {};
            
            // Adiciona Guardi√µes (com status de ativo)
            Object.values(ninjasData).forEach(n => {
                allIdsMap[n.id] = { id: n.id, type: n.isActive ? 'Guardi√£o Ativo' : 'Guardi√£o Inativo' };
            });

            // Adiciona Auxiliares que n√£o s√£o Guardi√µes
            Object.values(auxiliaryData).forEach(a => {
                if (!allIdsMap[a.id]) {
                    allIdsMap[a.id] = { id: a.id, type: 'Auxiliar' };
                }
            });

            const allIdsSorted = Object.values(allIdsMap).sort((a, b) => a.id.localeCompare(b.id));

            const ninjaOptions = allIdsSorted.map(n => 
                `<option value="${n.id}" class="${n.type.includes('Inativo') ? 'text-red-400' : ''}">
                    ${n.id} (${n.type})
                </option>`
            ).join('');
            
            // REMOVIDA A OP√á√ÉO RESET_LS
            return `
                <section class="space-y-6 pt-4">
                    <h2 class="text-3xl font-bold text-purple-400 text-center flex justify-center items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                        Painel de Ninjas - Hist√≥rico Completo
                    </h2>
                    <p class="text-center text-gray-400">Selecione qualquer ID de Ninja (Guardi√£o ou Auxiliar) para ver seu hist√≥rico de relat√≥rios e pontos.</p>

                    <!-- Seletor de Ninja/Auxiliar -->
                    <div class="max-w-md mx-auto space-y-2">
                        <label for="ninja-filter-select" class="block text-sm font-medium text-gray-300">Selecionar Ninja</label>
                        <select id="ninja-filter-select" onchange="window.renderReportsLogFiltered(this.value)" class="w-full p-2.5 rounded-lg bg-gray-700 border border-gray-600 focus:ring-purple-500 focus:border-purple-500 text-white shadow-inner">
                            <option value="">-- Ver Todos os Relat√≥rios --</option>
                            ${ninjaOptions}
                        </select>
                    </div>

                    <!-- Informa√ß√µes do Ninja Selecionado (Pontos e Miss√µes) -->
                    <div id="guardian-summary" class="max-w-md mx-auto p-4 bg-gray-700 rounded-lg shadow-inner text-center hidden">
                        <!-- Summary will be injected here -->
                    </div>

                    <!-- Tabela de Relat√≥rios Filtrada -->
                    <div id="filtered-reports-container" class="bg-gray-800 p-4 rounded-xl shadow-xl overflow-x-auto">
                        <h3 class="text-xl font-medium text-gray-300 mb-4">Relat√≥rios Envolvidos:</h3>
                        <table class="min-w-full divide-y divide-gray-700">
                            <thead class="bg-gray-700">
                                <tr>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider w-1/12">ID Relat√≥rio</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider w-2/12">Servi√ßos/Rank</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider w-2/12">Fun√ß√£o</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider w-2/12">Total Pts</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider w-4/12">Descri√ß√£o</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider w-1/12">Data</th>
                                </tr>
                            </thead>
                            <tbody id="filtered-reports-log" class="bg-gray-800 divide-y divide-gray-700">
                                <!-- Report data will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </section>
            `;
        }


        // ====================================================================
        // FUN√á√ïES DE PERSIST√äNCIA E INICIALIZA√á√ÉO (FIREBASE)
        // ====================================================================

        async function initializeFirebase() {
            try {
                if (!firebaseConfig || !firebaseConfig.projectId) {
                    throw new Error("Configura√ß√£o do Firebase inv√°lida ou faltando.");
                }
                
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Login An√¥nimo para acesso B√ÅSICO (Leitura)
                const anonUser = await signInAnonymously(auth);
                userId = anonUser.user.uid;
                
                document.getElementById('auth-info').textContent = `Usu√°rio ID (Anon): ${userId} | App ID (DB Contexto): ${appId}`;
                setupFirestoreListeners(); // Inicia os listeners de dados
                window.renderPage(currentPage);
                window.generateReportId(); 
                

            } catch (error) {
                console.error("Erro na inicializa√ß√£o do Firebase:", error);
                const statusElement = document.getElementById('status');
                statusElement.className = 'text-red-400 p-4 bg-red-900/50 rounded-lg block';
                statusElement.textContent = `‚ùå Erro ao conectar: ${error.message}. Verifique sua chave de API e regras de seguran√ßa.`;
            }
        }
        
        function setupFirestoreListeners() {
            if (!db) return;

            // 0. Chaves de Acesso (Nova Cole√ß√£o)
            // Tenta se inscrever, mas lida com o erro de permiss√£o silenciosamente.
            onSnapshot(collection(db, COLLECTIONS.ACCESS_KEYS), (snapshot) => {
                accessKeysData = {};
                snapshot.forEach(doc => {
                    const data = doc.data();
                    accessKeysData[doc.id] = data; 
                });
                // Garante que o estado de permiss√£o seja atualizado se o login for feito
                if (currentPage === 'admin_panel' || currentPage === 'report_form') {
                    window.renderPage(currentPage);
                }
            }, (error) => { 
                console.warn("@firebase/firestore: Permiss√£o negada para ACCESS_KEYS (normal para usu√°rios an√¥nimos):", error.message);
            });

            // 1. Miss√µes / Quests
            onSnapshot(collection(db, COLLECTIONS.MISSIONS), (snapshot) => {
                missionsData = {};
                snapshot.forEach(doc => {
                    const data = doc.data();
                    missionsData[data.name] = data; 
                });
                if (Object.keys(missionsData).length === 0) {
                     seedInitialData(db);
                }
                if (['report_form', 'admin_panel'].includes(currentPage)) {
                    // Chamada essencial para popular o select de miss√µes na tela de relat√≥rio
                    window.updateMissionSelects && window.updateMissionSelects(false); 
                    window.renderMissionsDatabase && window.renderMissionsDatabase();
                } 
            }, (error) => {
                console.warn("@firebase/firestore: Permiss√£o negada para MISSIONS (normal para usu√°rios an√¥nimos):", error.message);
            });

            // 2. Ninjas / Cadastro e Scoreboard
            onSnapshot(collection(db, COLLECTIONS.NINJAS), (snapshot) => {
                ninjasData = {};
                snapshot.forEach(doc => {
                    const data = doc.data();
                    data.id = doc.id; 
                    ninjasData[data.id] = data;
                });
                if (['report_form', 'scoreboard', 'ninja_panel'].includes(currentPage)) {
                    // Chamada essencial para popular o select de ninjas na tela de relat√≥rio
                    window.updateExecutorSelect && window.updateExecutorSelect();
                    window.renderPage(currentPage);
                } else if (currentPage === 'admin_panel') {
                     window.renderNinjasTable && window.renderNinjasTable();
                }
            }, (error) => {
                console.warn("@firebase/firestore: Permiss√£o negada para NINJAS (normal para usu√°rios an√¥nimos):", error.message);
            });
            
            // 3. Log de Aux√≠lio
            onSnapshot(collection(db, COLLECTIONS.AUXILIARY_LOG), (snapshot) => {
                auxiliaryData = {};
                snapshot.forEach(doc => {
                    const data = doc.data();
                    auxiliaryData[doc.id] = data;
                });
                if (['auxiliary_log', 'ninja_panel'].includes(currentPage)) {
                    window.renderAuxiliaryData && window.renderAuxiliaryData(); 
                }
            }, (error) => {
                console.warn("@firebase/firestore: Permiss√£o negada para AUXILIARY_LOG (normal para usu√°rios an√¥nimos):", error.message);
            });

            // 4. Relat√≥rios / Logs
            onSnapshot(collection(db, COLLECTIONS.REPORTS), (snapshot) => {
                reportsData = [];
                snapshot.forEach(doc => reportsData.push(doc.data()));
                if (['reports_log', 'ninja_panel'].includes(currentPage)) window.renderPage(currentPage);
            }, (error) => {
                console.warn("@firebase/firestore: Permiss√£o negada para REPORTS (normal para usu√°rios an√¥nimos):", error.message);
            });
        }
        
        // Simula o seed de dados no Firestore
        async function seedInitialData(db) {
            // ... (L√≥gica de seed mantida)
            const newMissionsList = [
                { name: "Village's Most Wanted", rank: "S-Rank" },
                { name: "Glacier Bear Hunt", rank: "A-Rank" },
                { name: "Puppet Retirement", rank: "A-Rank" },
                { name: "Retrieve Compromised Documents", rank: "A-Rank" },
                { name: "Spy on Hokage/Kazekage/Mizukage Office", rank: "A-Rank" },
                { name: "Bounty Hunting", rank: "B-Rank" },
                { name: "Cold-Blooded Killer", rank: "B-Rank" },
                { name: "Guilty Pleasure", rank: "B-Rank" },
                { name: "Medical Supplies", rank: "B-Rank" },
                { name: "Antidotes Creation", rank: "C-Rank" },
                { name: "Bear Hunt", rank: "C-Rank" },
                { name: "Messenger Ninja", rank: "C-Rank" },
                { name: "Shark Attack", rank: "C-Rank" },
                { name: "Academy Scrolls", rank: "D-Rank" },
                { name: "Bad Larva", rank: "D-Rank" },
                { name: "Defeat Spiders", rank: "D-Rank" },
                { name: "Lost Puppy 'Giba'", rank: "D-Rank" },
                { name: "Defesa de Vila ou Raid", rank: "Defesa/Raid" },
                { name: "A Demon??", rank: "NPC Quest" },
                { name: "Land Of Waves", rank: "Storyline" },
            ];

            const batch = writeBatch(db);
            let ninjasAdded = 0;

            for (const mission of newMissionsList) {
                const docId = mission.name;
                const missionRef = doc(db, COLLECTIONS.MISSIONS, docId);
                const cleanRank = cleanRankForLookup(mission.rank);
                const points = RANK_POINTS[cleanRank] || 0; 
                batch.set(missionRef, {
                    name: mission.name,
                    baseRank: mission.rank,
                    points: points,
                    id: mission.name
                });
            }

            const exampleNinjas = ['dellzito', 'alnvctr'];
            for (const id of exampleNinjas) {
                const normalizedId = normalizeId(id); 
                const ninjaRef = doc(db, COLLECTIONS.NINJAS, normalizedId);
                const ninjaSnap = await getDoc(ninjaRef);
                if (!ninjaSnap.exists()) {
                    batch.set(ninjaRef, { id: normalizedId, isActive: true, rankPoints: 0, missionsCompleted: 0 });
                    ninjasAdded++;
                }
            }
            
            // NOVO: Adiciona uma chave de ADMIN MASTER para o primeiro uso
            const masterKeyRef = doc(db, COLLECTIONS.ACCESS_KEYS, 'MASTER_ADMIN');
            batch.set(masterKeyRef, {
                id: 'MASTER_ADMIN',
                key: 'MASTER_KEY_001', // Chave √∫nica e secreta para voc√™ (MUDE ESTE VALOR MANUALMENTE NO FIRESTORE)
                level: 'master_admin'
            }, { merge: true });

            // NOVO: Adiciona uma chave de ESCRITOR de exemplo
            const writerKeyRef = doc(db, COLLECTIONS.ACCESS_KEYS, 'Guardi√£o_Exemplo');
            batch.set(writerKeyRef, {
                id: 'GUARDIAN_1',
                key: 'report_123', // Chave para um Guardi√£o (MUDE ESTE VALOR MANUALMENTE NO FIRESTORE)
                level: 'report_writer'
            }, { merge: true });


            if (newMissionsList.length > 0 || ninjasAdded > 0) {
                try {
                    await batch.commit();
                } catch (e) {
                     console.error("Erro ao fazer seed inicial no Firestore:", e);
                }
            }
        }
        
        // ====================================================================
        // FUN√á√ïES DE CONTROLE DE ACESSO
        // ====================================================================

        window.toggleWriterUI = function(isAuthorized) {
            isWriterMode = isAuthorized;
            // Libera a aba Criar Relat√≥rio e o Gerenciamento de Miss√µes
            const writerElements = document.querySelectorAll('.writer-only');
            
            writerElements.forEach(el => {
                if (isAuthorized) {
                    el.classList.remove('hidden');
                } else {
                    el.classList.add('hidden');
                }
            });
            // Re-renderiza a p√°gina atual para aplicar as permiss√µes
            window.renderPage(currentPage);
        }

        window.toggleMasterAdminUI = function(isAuthorized) {
            isMasterAdminMode = isAuthorized;
            // Libera todas as funcionalidades de Admin
            const adminElements = document.querySelectorAll('.admin-only');
            
            adminElements.forEach(el => {
                if (isAuthorized) {
                    el.classList.remove('hidden');
                } else {
                    el.classList.add('hidden');
                }
            });
            // Re-renderiza a p√°gina atual para aplicar as permiss√µes
            window.renderPage(currentPage);
        }
        
        window.checkAccessKey = async function() {
            const idInput = document.getElementById('access-id-input');
            const keyInput = document.getElementById('access-key-input');
            const statusElement = document.getElementById('status');
            
            if (!idInput || !keyInput) return;

            const id = idInput.value.trim();
            const key = keyInput.value.trim();
            
            if (!id || !key) {
                statusElement.textContent = '‚ùå Preencha o ID e a Senha.';
                statusElement.className = 'text-red-400 p-4 bg-red-900/50 rounded-lg block';
                setTimeout(() => statusElement.classList.add('hidden'), 5000);
                return;
            }
            
            // 1. Procura a chave no cache do Firebase
            const accessData = accessKeysData[id];

            if (accessData && accessData.key === key) {
                
                if (accessData.level === 'master_admin') {
                    window.toggleMasterAdminUI(true);
                    window.toggleWriterUI(true);
                    statusElement.textContent = `‚úÖ Acesso MASTER LIBERADO. ID: ${id}`;
                } else if (accessData.level === 'report_writer') {
                    window.toggleWriterUI(true);
                    window.toggleMasterAdminUI(false);
                    statusElement.textContent = `‚úÖ Acesso ESCRITOR LIBERADO. ID: ${id}`;
                } else {
                    statusElement.textContent = '‚ùå ID/Senha v√°lidos, mas N√≠vel de Acesso n√£o reconhecido.';
                    statusElement.className = 'text-red-400 p-4 bg-red-900/50 rounded-lg block';
                    setTimeout(() => statusElement.classList.add('hidden'), 7000);
                    return;
                }
                
                keyInput.value = ''; 
                idInput.value = '';
                statusElement.className = 'text-green-400 p-4 bg-green-900/50 rounded-lg block';
                setTimeout(() => statusElement.classList.add('hidden'), 5000);
                
                // CORRE√á√ÉO: For√ßa a re-renderiza√ß√£o para aplicar as permiss√µes na p√°gina atual
                window.renderPage(currentPage);
                
            } else {
                window.toggleWriterUI(false);
                window.toggleMasterAdminUI(false);
                statusElement.textContent = '‚ùå Autoriza√ß√£o Negada. ID ou Senha Incorreta.';
                statusElement.className = 'text-red-400 p-4 bg-red-900/50 rounded-lg block';
                setTimeout(() => statusElement.classList.add('hidden'), 7000);
            }
        }
        
        // ====================================================================
        // FUN√á√ïES DE ROTEAMENTO E TEMPLATES
        // ====================================================================

        window.renderPage = function(pageName) {
            currentPage = pageName;
            const contentDiv = document.getElementById('content');
            
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            const activeLink = document.getElementById(`nav-${pageName}`);
            if (activeLink) activeLink.classList.add('active');

            contentDiv.innerHTML = '';

            switch (pageName) {
                case 'home':
                    contentDiv.innerHTML = window.renderHome();
                    break;
                case 'scoreboard':
                    contentDiv.innerHTML = window.renderRank();
                    window.renderScoreboard();
                    break;
                case 'reports_log':
                    contentDiv.innerHTML = window.renderRelatorios();
                    window.renderReportsLog();
                    break;
                case 'auxiliary_log':
                    contentDiv.innerHTML = window.renderAuxilio();
                    window.renderAuxiliaryData(); 
                    break;
                case 'ninja_panel':
                    contentDiv.innerHTML = window.renderNinjaPanel(); // Renderiza o template HTML
                    window.renderReportsLogFiltered(); // Preenche os dados
                    break;
                case 'report_form':
                    contentDiv.innerHTML = window.renderCriarRelatorio();
                    if (!isWriterMode) {
                        contentDiv.innerHTML += '<p class="text-center text-red-500 pt-8">Voc√™ precisa de autoriza√ß√£o (Login na aba Autoriza√ß√£o) para criar relat√≥rios.</p>';
                        break;
                    }
                    // Fun√ß√µes de inicializa√ß√£o espec√≠ficas para a p√°gina de relat√≥rio
                    window.updateMissionSelects(false); 
                    window.updateExecutorSelect();
                    window.updateExecutorTags(false); 
                    window.generateReportId();
                    window.addMissionEntry(null, false); 
                    window.updateDescriptionPreview();
                    break;
                case 'admin_panel':
                    contentDiv.innerHTML = window.renderAutorizacao();
                    window.renderNinjasTable();
                    window.renderMissionsDatabase();
                    break;
                default:
                    contentDiv.innerHTML = window.renderHome();
            }
        }

        // --- TEMPLATES ---
        window.renderHome = function() { return `
                <section class="text-center py-20 bg-gray-800 rounded-xl shadow-2xl space-y-8">
                    <h2 class="text-3xl font-bold text-green-400">Bem-vindo(a) √† Folha de Rosto Ninja!</h2>
                    <p class="text-lg text-gray-300 max-w-2xl mx-auto">
                        Este √© o painel central para o sistema de rastreamento de miss√µes e ranking dos Guardi√µes. 
                        Todos os dados s√£o sincronizados em tempo real via Firebase.
                    </p>
                    <div class="flex flex-col sm:flex-row justify-center gap-6 pt-4">
                        <button onclick="window.renderPage('report_form')" class="py-3 px-8 bg-blue-600 hover:bg-blue-700 rounded-lg font-bold text-white text-xl transition duration-200 shadow-lg shadow-blue-500/50">
                            Criar Novo Relat√≥rio
                        </button>
                        <button onclick="window.renderPage('scoreboard')" class="py-3 px-8 bg-red-600 hover:bg-red-700 rounded-lg font-bold text-white text-xl transition duration-200 shadow-lg shadow-red-500/50">
                            Ver Rank
                        </button>
                        <button onclick="window.renderPage('admin_panel')" class="py-3 px-8 bg-yellow-600 hover:bg-yellow-700 rounded-lg font-bold text-white text-xl transition duration-200 shadow-lg shadow-yellow-500/50">
                            Autoriza√ß√£o
                        </button>
                    </div>
                </section>
            `; }

        window.renderCriarRelatorio = function() { return `
                <section id="report-form-section" class="bg-gray-800 p-6 rounded-xl shadow-2xl space-y-6">
                    <h2 class="text-3xl font-semibold border-b pb-3 border-gray-700 text-blue-300 text-center">Formul√°rio de Registro de Miss√£o</h2>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        
                        <!-- ID Ninja (Quem Realizou) - AGORA COM SELECT -->
                        <div class="space-y-2 lg:col-span-3">
                            <label class="block text-sm font-medium text-gray-300">IDs Ninja (Quem Realizou - Membros Cadastrados)</label>
                            
                            <!-- Select e bot√£o para adicionar -->
                            <div class="flex gap-2">
                                <select id="new-executor-id-select" class="flex-grow p-2.5 rounded-lg bg-gray-700 border border-gray-600 focus:ring-blue-500 focus:border-blue-500 text-white shadow-inner">
                                    <option value="" disabled selected>Selecione um Guardi√£o Ativo</option>
                                    <!-- Options preenchidas dinamicamente por updateExecutorSelect -->
                                </select>
                                <button type="button" id="add-executor-btn" class="py-2.5 px-4 bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg transition duration-200 font-semibold">
                                    Adicionar Executor
                                </button>
                            </div>

                            <!-- Tags de Executores Selecionados -->
                            <div id="executors-tag-container" class="executor-list-container">
                                <!-- Tags ser√£o injetadas aqui -->
                                <span id="no-executor-message" class="text-gray-400 text-sm italic">Nenhum executor selecionado.</span>
                            </div>
                        </div>
                        
                        <!-- ID Cliente (Requisitantes) -->
                        <div class="space-y-2">
                            <label for="clients" class="block text-sm font-medium text-gray-300">Clientes (Requisitantes, separados por v√≠rgula)</label>
                            <input id="clients" type="text" placeholder="lukfault, logagault" class="w-full p-2.5 rounded-lg bg-gray-700 border border-gray-600 focus:ring-blue-500 focus:border-blue-500 text-white shadow-inner" oninput="window.updateDescriptionPreview()">
                        </div>

                        <!-- Aux√≠lio (Quem Ajudou - Rastreamento Separado) -->
                        <div class="space-y-2">
                            <label for="support-ids" class="block text-sm font-medium text-gray-300">Aux√≠lio (IDs, separados por v√≠rgula, Opcional)</label>
                            <input id="support-ids" type="text" placeholder="AlnVctr, Yakuza" class="w-full p-2.5 rounded-lg bg-gray-700 border border-gray-600 focus:ring-blue-500 focus:border-blue-500 text-white shadow-inner" oninput="window.updateDescriptionPreview()">
                        </div>
                        
                        <!-- Detalhes da Miss√£o (Para a Descri√ß√£o) -->
                        <div class="space-y-2 lg:col-span-3">
                            <label for="mission-details" class="block text-sm font-medium text-gray-300">Detalhes para a Descri√ß√£o (Ex: "60 DNAs para o Arco do 30")</label>
                            <input id="mission-details" type="text" placeholder="Descri√ß√£o curta do objetivo da miss√£o" class="w-full p-2.5 rounded-lg bg-gray-700 border border-gray-600 focus:ring-blue-500 focus:border-blue-500 text-white shadow-inner" oninput="window.updateDescriptionPreview()">
                        </div>

                        <!-- ID Relat√≥rio (C√≥digo de Registro) -->
                        <div class="space-y-2 lg:col-span-3">
                            <label for="report-id-display" class="block text-sm font-medium text-gray-300">ID √önico do Relat√≥rio (C√≥digo de Registro)</label>
                            <div class="flex gap-2">
                                <input id="report-id-display" type="text" readonly class="w-full p-2.5 rounded-lg bg-gray-600/50 border border-gray-600 text-purple-300 font-mono shadow-inner cursor-not-allowed" value="Gerado Automaticamente">
                                <button type="button" onclick="window.copyReportId()" class="p-2.5 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition duration-200" title="Copiar ID para o Discord">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M7 9a1 1 0 011-1h4a1 1 0 110 2H8a1 1 0 01-1-1zm0 4a1 1 0 011-1h4a1 1 0 110 2H8a1 1 0 01-1-1z" /><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-5a1 1 0 00-1 1v2a1 1 0 102 0V6a1 1 0 00-1-1zm2 13a1 1 0 001-1v-2a1 1 0 10-2 0v2a1 1 0 001 1z" clip-rule="evenodd" /></svg>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="pt-4 space-y-4 border-t border-gray-700/50">
                        <h3 class="text-xl font-medium text-gray-300 flex justify-between items-center">
                            Miss√µes Conclu√≠das Neste Relat√≥rio
                            <button id="add-mission-btn" class="py-1 px-3 bg-green-600 hover:bg-green-700 text-white text-sm rounded-lg transition duration-200 shadow-md flex items-center gap-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                                Adicionar Miss√£o
                            </button>
                        </h3>

                        <!-- Cont√™iner de Entrada de Miss√µes -->
                        <div id="missions-entry-container" class="space-y-3">
                            <!-- Mission entries will be added here -->
                        </div>

                        <!-- Resumo de Pontos e Rank -->
                        <div class="grid grid-cols-2 gap-4 pt-4">
                            <div class="space-y-2 lg:col-span-2">
                                <label class="block text-sm font-medium text-gray-300">Total de Pontos (Pontos Brutos da Miss√£o)</label>
                                <input id="total-points" type="text" readonly class="w-full p-2.5 rounded-lg bg-gray-600/50 border border-gray-600 text-green-400 font-bold shadow-inner cursor-not-allowed" value="0">
                            </div>
                            <!-- REMOVIDO: Pontos p/ Pessoa (Estimado) -->
                        </div>
                    </div>

                    <!-- Preview da Descri√ß√£o -->
                    <div class="pt-4 space-y-2 border-t border-gray-700/50">
                        <h3 class="text-xl font-medium text-gray-300">Preview da Descri√ß√£o do Relat√≥rio:</h3>
                        <div id="description-preview" class="p-4 bg-gray-700 rounded-lg text-gray-300 italic min-h-[50px]">
                            A descri√ß√£o do relat√≥rio aparecer√° aqui ao preencher o formul√°rio.
                        </div>
                    </div>

                    <button id="submit-report" class="w-full py-3 mt-4 bg-blue-600 hover:bg-blue-700 rounded-lg font-bold text-white text-lg transition duration-200 shadow-lg shadow-blue-500/50" disabled onclick="window.submitReport()">
                        Registrar Miss√£o(√µes) e Atualizar Ranking
                    </button>
                </section>
            `;
        }
        
        window.renderRank = function() {
            return `
                <section class="space-y-4 pt-8">
                    <h2 class="text-3xl font-bold text-red-400 text-center flex justify-center items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 8a1 1 0 000 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /><path fill-rule="evenodd" d="M10 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zM5 10a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
                        Rank dos Guardi√µes (Membros Cadastrados)
                    </h2>
                    <div class="bg-gray-800 p-4 rounded-xl shadow-xl overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-700">
                            <thead class="bg-gray-700">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Rank</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">ID Guardi√£o</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Total de Pontos</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Miss√µes Conclu√≠das</th>
                                </tr>
                            </thead>
                            <tbody id="ninjas-scoreboard" class="bg-gray-800 divide-y divide-gray-700">
                                <!-- Scoreboard data will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </section>
            `;
        }

        window.renderRelatorios = function() {
            return `
                <section class="space-y-4 pt-8">
                    <h2 class="text-3xl font-bold text-blue-400 text-center">Registro Completo de Relat√≥rios</h2>
                    <div class="bg-gray-800 p-4 rounded-xl shadow-xl overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-700">
                            <thead class="bg-gray-700">
                                <tr>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider w-1/12">ID Relat√≥rio</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider w-2/12">Servi√ßos/Rank</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider w-2/12">Executor/Aux√≠lio</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider w-2/12">Clientes</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider w-3/12">Descri√ß√£o</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider w-1/12">Data</th>
                                </tr>
                            </thead>
                            <tbody id="reports-log" class="bg-gray-800 divide-y divide-gray-700">
                                <!-- Report data will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </section>
            `;
        }

        // Template HTML para a p√°gina de aux√≠lio
        window.renderAuxilio = function() {
            return `
                <section class="space-y-4 pt-8">
                    <h2 class="text-3xl font-bold text-orange-400 text-center flex justify-center items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm4.5-9.5c0 .83-.67 1.5-1.5 1.5s-1.5-.67-1.5-1.5.67-1.5 1.5-1.5 1.5.67 1.5 1.5zM9 9c0-.83-.67-1.5-1.5-1.5S6 8.17 6 9s.67 1.5 1.5 1.5S9 9.83 9 9zm3 2.5c-2.33 0-4.38 1.15-5.69 2.84.03-.02.06-.04.09-.07C6.67 13.92 9.07 15 12 15s5.33-1.08 7.6-2.73c.03.03.06.05.09.07-1.31-1.69-3.36-2.84-5.69-2.84z"/></svg>
                        Log de Aux√≠lio (Potenciais Membros)
                    </h2>
                    <p class="text-center text-gray-400">Pessoas que participaram como aux√≠lio e acumulam pontos separadamente.</p>
                    <div class="bg-gray-800 p-4 rounded-xl shadow-xl overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-700">
                            <thead class="bg-gray-700">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">ID Auxiliar</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">√öltima Participa√ß√£o</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Pontos Acumulados</th>
                                </tr>
                            </thead>
                            <tbody id="auxiliary-log" class="bg-gray-800 divide-y divide-gray-700">
                                <!-- Auxiliary data will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </section>
            `;
        }

        window.renderAutorizacao = function() {
             const accessStatus = isMasterAdminMode ? 
                `<div class="text-center text-green-400 font-bold text-lg p-2">‚úÖ MASTER ADMIN ATIVO</div>` : 
                (isWriterMode ? `<div class="text-yellow-400 font-bold text-lg p-2">‚úÖ ESCRITOR DE RELAT√ìRIO ATIVO</div>` :
                `<div class="text-center text-red-400 font-bold text-lg p-2">‚ùå ACESSO INATIVO</div>`);

            return `
                <!-- PAINEL DE AUTORIZA√á√ÉO (Login Customizado) -->
                <section class="space-y-4 pt-4 pb-4 bg-gray-900 p-6 rounded-xl shadow-inner border border-blue-500/50">
                     <h2 class="text-2xl font-bold text-blue-400 text-center flex justify-center items-center gap-2">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M10 2a5 5 0 00-5 5v2a2 2 0 00-2 2v5a2 2 0 002 2h10a2 2 0 002-2v-5a2 2 0 00-2-2V7a5 5 0 00-5-5zm2 5v2h-4V7a3 3 0 016 0z"/></svg>
                         Autoriza√ß√£o de Escrita (ID & Senha √önica)
                     </h2>
                     <p class="text-center text-gray-400">Insira seu ID e Senha fornecidos para liberar as fun√ß√µes de escrita e edi√ß√£o.</p>
                     
                     <div id="admin-status-display">${accessStatus}</div>

                     <div class="flex flex-col md:flex-row gap-4 max-w-lg mx-auto">
                         <input id="access-id-input" type="text" placeholder="Seu ID de Guardi√£o/Admin" class="flex-grow p-2 rounded-lg bg-gray-700 border border-gray-600 text-white shadow-inner">
                         <input id="access-key-input" type="password" placeholder="Sua Senha √önica" class="flex-grow p-2 rounded-lg bg-gray-700 border border-gray-600 text-white shadow-inner">
                         <!-- CORRE√á√ÉO: Adicionado onclick para a fun√ß√£o de verifica√ß√£o de acesso -->
                         <button id="set-access-key-btn" class="w-full md:w-auto py-2 px-4 bg-blue-600 hover:bg-blue-700 rounded-lg font-bold text-white transition duration-200" onclick="window.checkAccessKey()">
                             Verificar Acesso
                         </button>
                     </div>
                </section>
                
                <!-- 5. CADASTRO: GUARDI√ïES (MASTER ADMIN ONLY) -->
                <section class="space-y-4 pt-8 pb-16">
                    <h2 class="text-3xl font-bold text-yellow-400 text-center">Cadastro: Guardi√µes (Membros da Organiza√ß√£o)</h2>
                    <p class="text-center text-gray-400">Pessoas que pontuam no Rank dos Guardi√µes. <span class="text-red-400">Master Admin Apenas.</span></p>

                    <!-- Add New Ninja Form (ADMIN ONLY) -->
                    <div id="add-ninja-form" class="bg-gray-700 p-4 rounded-lg shadow-inner flex flex-col sm:flex-row gap-4 admin-only ${isMasterAdminMode ? '' : 'hidden'}">
                        <input id="new-ninja-id" type="text" placeholder="ID do Novo Guardi√£o (Ex: Dellzito)" class="flex-grow p-2 rounded-lg bg-gray-800 border border-gray-600 text-white">
                        <button id="add-ninja" class="w-full sm:w-auto py-2 px-4 bg-yellow-600 hover:bg-yellow-700 rounded-lg font-bold text-white transition duration-200" onclick="window.addNinja()">Adicionar Guardi√£o</button>
                    </div>

                    <div class="bg-gray-800 p-4 rounded-xl shadow-xl overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-700">
                            <thead class="bg-gray-700">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">ID Guardi√£o</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Status</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider admin-only ${isMasterAdminMode ? '' : 'hidden'}">A√ß√£o</th>
                                </tr>
                            </thead>
                            <tbody id="ninjas-cadastro" class="bg-gray-800 divide-y divide-gray-700">
                                <!-- Ninja data will be inserted here by renderNinjasTable() -->
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- 6. BANCO DE DADOS: MISS√ïES E RANKS (MASTER ADMIN / WRITER MODE) -->
                <section class="space-y-4 pt-8">
                    <h2 class="text-3xl font-bold text-green-400 text-center">Gerenciamento de Miss√µes (Quests)</h2>
                    <p class="text-center text-gray-400">Adicione, edite ou exclua as quests dispon√≠veis. <span class="${isWriterMode ? 'text-green-400' : 'text-red-400'}">Requer Autoriza√ß√£o de Escrita.</span></p>
                    
                    <!-- Add New Mission Form (WRITER ONLY) -->
                    <div id="add-mission-form" class="bg-gray-700 p-4 rounded-lg shadow-inner flex flex-col sm:flex-row gap-4 writer-only ${isWriterMode ? '' : 'hidden'}">
                        <input id="new-mission-name" type="text" placeholder="Novo Nome da Miss√£o" class="flex-grow p-2 rounded-lg bg-gray-800 border border-gray-600 text-white">
                        <select id="new-mission-rank-select" class="w-full sm:w-32 p-2 rounded-lg bg-gray-800 border border-gray-600 text-white">
                             <option value="S-Rank">S-Rank (5 Pts)</option>
                             <option value="A-Rank">A-Rank (4 Pts)</option>
                             <option value="B-Rank" selected>B-Rank (3 Pts)</option>
                             <option value="C-Rank">C-Rank (2 Pts)</option>
                             <option value="D-Rank">D-Rank (1 Pt)</option>
                             <option value="Defesa/Raid">Defesa/Raid (10 Pts)</option>
                             <option value="NPC Quest">NPC Quest (0 Pts)</option>
                             <option value="Storyline">Storyline (0 Pts)</option>
                        </select>
                        <button id="add-mission" class="w-full sm:w-auto py-2 px-4 bg-green-600 hover:bg-green-700 rounded-lg font-bold text-white transition duration-200" onclick="window.addMission()">Adicionar Miss√£o</button>
                    </div>
                    
                    <div class="bg-gray-800 p-4 rounded-xl shadow-xl overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-700">
                            <thead class="bg-gray-700">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Nome da Miss√£o</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Rank Base</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Pontos</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider writer-only ${isWriterMode ? '' : 'hidden'}">A√ß√£o</th>
                                </tr>
                            </thead>
                            <tbody id="missions-database" class="bg-gray-800 divide-y divide-gray-700">
                                <!-- Mission data will be inserted here by renderMissionsDatabase() -->
                            </tbody>
                        </table>
                    </div>
                </section>
            `;
        }
        
        // Start application on load
        window.onload = function() {
            initializeFirebase();
        }
    </script>
</body>
</html>
