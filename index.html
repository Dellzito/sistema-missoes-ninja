<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sistema Ninja ‚Äî Offline (SPA)</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #0b1220;      /* fundo */
      --panel: #0f1724;   /* painel */
      --muted: #9ca3af;
      --accent: #3b82f6;  /* azul */
      --accent-2: #f59e0b;/* amarelo */
      --success: #10b981;
      --danger: #ef4444;
    }
    body { font-family: 'Inter', sans-serif; background: var(--bg); color: #e6eef8; }
    /* scrollbar */
    ::-webkit-scrollbar { height: 10px; width: 10px; }
    ::-webkit-scrollbar-thumb { background: #1f2937; border-radius: 999px; }
    .tab-active { border-bottom: 3px solid var(--accent); }
    .hidden-section { display: none; }
    .tag { padding: .25rem .5rem; border-radius: 999px; background: #1f2937; color: #e6eef8; font-weight:600; }
    /* small helper for tables */
    table th, table td { border-bottom: 1px solid rgba(255,255,255,0.03); }
    .btn { transition: all .12s ease; }
  </style>
</head>
<body class="antialiased p-6">
  <div class="max-w-6xl mx-auto space-y-6">

    <!-- HEADER -->
    <header class="flex items-center justify-between gap-4">
      <div>
        <h1 class="text-2xl font-bold text-blue-300">üìú Sistema Ninja ‚Äî Offline</h1>
        <p class="text-sm text-gray-400">SPA leve ‚Äî cadastre miss√µes, registre relat√≥rios, atualize ranking. Dados locais (LocalStorage).</p>
      </div>
      <div class="flex items-center gap-3">
        <span id="status-pill" class="px-3 py-1 rounded-full text-sm bg-gray-800 text-yellow-300">Modo Offline</span>
        <button id="download-backup" class="btn px-3 py-1 rounded bg-gray-800 text-sm text-gray-200 hover:bg-gray-700">Backup</button>
      </div>
    </header>

    <!-- NAV -->
    <nav class="bg-gradient-to-r from-[#071226] to-[#0d1320] rounded p-2 flex gap-2 overflow-x-auto">
      <button data-tab="home" class="tab btn px-4 py-2 rounded text-sm">Home</button>
      <button data-tab="create" class="tab btn px-4 py-2 rounded text-sm">Criar Relat√≥rio</button>
      <button data-tab="rank" class="tab btn px-4 py-2 rounded text-sm">Rank</button>
      <button data-tab="reports" class="tab btn px-4 py-2 rounded text-sm">Relat√≥rios</button>
      <button data-tab="aux" class="tab btn px-4 py-2 rounded text-sm">Aux√≠lio</button>
      <button data-tab="admin" class="tab btn px-4 py-2 rounded text-sm">Administra√ß√£o</button>
      <button data-tab="config" class="tab btn px-4 py-2 rounded text-sm">Configura√ß√µes</button>
    </nav>

    <!-- MAIN (todas as se√ß√µes da SPA) -->
    <main class="space-y-8">
      <!-- HOME -->
      <section id="home" class="section">
        <div class="bg-panel bg-[#0f1724] p-6 rounded-xl shadow">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
              <h2 class="text-xl font-semibold text-blue-300">Bem-vindo, Guardi√£o</h2>
              <p class="text-sm text-gray-400 max-w-xl">Use o bot√£o abaixo para come√ßar um novo relat√≥rio, consultar o rank ou acessar o painel administrativo (chave necess√°ria).</p>
            </div>
            <div class="flex gap-3">
              <button class="btn bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded" data-tab-action="create">‚ûï Criar Relat√≥rio</button>
              <button class="btn bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded" data-tab-action="rank">üìä Ver Rank</button>
            </div>
          </div>

          <!-- quick stats -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
            <div class="p-4 rounded bg-[#08101b]">
              <div class="text-sm text-gray-400">Guardi√£o(s) Cadastrado(s)</div>
              <div id="stat-ninjas" class="text-2xl font-bold text-yellow-300">0</div>
            </div>
            <div class="p-4 rounded bg-[#08101b]">
              <div class="text-sm text-gray-400">Miss√µes no Banco</div>
              <div id="stat-missions" class="text-2xl font-bold text-blue-300">0</div>
            </div>
            <div class="p-4 rounded bg-[#08101b]">
              <div class="text-sm text-gray-400">Relat√≥rios Registrados</div>
              <div id="stat-reports" class="text-2xl font-bold text-green-300">0</div>
            </div>
          </div>
        </div>
      </section>

      <!-- CRIAR RELAT√ìRIO -->
      <section id="create" class="section hidden-section">
        <div class="bg-panel p-6 rounded-xl shadow">
          <h2 class="text-lg font-semibold text-blue-300 flex items-center gap-2">üìã Criar Relat√≥rio</h2>
          <p class="text-sm text-gray-400 mt-1">Selecione executores, miss√µes, clientes e registre.</p>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
            <!-- executors -->
            <div class="col-span-1 md:col-span-1 space-y-2">
              <label class="text-sm text-gray-300">Executores (selecionar)</label>
              <div class="flex gap-2">
                <select id="executor-select" class="flex-grow p-2 rounded bg-[#0b1220] text-white border border-gray-700"></select>
                <button id="add-executor-btn" class="px-3 py-2 rounded bg-yellow-600 hover:bg-yellow-700">Adicionar</button>
              </div>
              <div id="executors-tags" class="mt-3 flex flex-wrap gap-2"></div>
            </div>

            <!-- clientes -->
            <div class="col-span-1 md:col-span-1 space-y-2">
              <label class="text-sm text-gray-300">Clientes (v√≠rgula)</label>
              <input id="clients-input" class="w-full p-2 rounded bg-[#0b1220] border border-gray-700" placeholder="lukfault, logagault">
              <label class="text-sm text-gray-300 mt-2">Aux√≠lio (opcional)</label>
              <input id="support-input" class="w-full p-2 rounded bg-[#0b1220] border border-gray-700" placeholder="alnvctr, yakuza">
            </div>

            <!-- mission details -->
            <div class="col-span-1 md:col-span-1 space-y-2">
              <label class="text-sm text-gray-300">Detalhes da Miss√£o</label>
              <input id="mission-details-input" class="w-full p-2 rounded bg-[#0b1220] border border-gray-700" placeholder='Ex: "60 DNAs para arco 30"'>
              <label class="text-sm text-gray-300 mt-2">ID do relat√≥rio</label>
              <div class="flex gap-2">
                <input id="report-id" readonly class="flex-grow p-2 rounded bg-[#081018] border border-gray-700 font-mono text-sm" />
                <button id="copy-id" class="px-3 py-2 rounded bg-gray-800 hover:bg-gray-700">Copiar</button>
                <button id="regen-id" class="px-3 py-2 rounded bg-gray-800 hover:bg-gray-700">Novo</button>
              </div>
            </div>
          </div>

          <!-- lista de miss√µes -->
          <div class="mt-6">
            <div class="flex justify-between items-center">
              <h3 class="text-sm text-gray-300">Miss√µes (adicione 1 ou mais)</h3>
              <button id="add-mission-row" class="px-3 py-1 rounded bg-green-600 hover:bg-green-700 text-sm">Adicionar Miss√£o</button>
            </div>
            <div id="missions-rows" class="mt-3 space-y-2"></div>

            <!-- resumo -->
            <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-3">
              <div class="p-3 rounded bg-[#081018]">
                <div class="text-xs text-gray-400">Total de Pontos</div>
                <div id="total-points" class="text-lg font-bold text-green-300">0</div>
              </div>
              <div class="p-3 rounded bg-[#081018]">
                <div class="text-xs text-gray-400">Pontos por Pessoa</div>
                <div id="points-per-person" class="text-lg font-bold text-yellow-300">0</div>
              </div>
              <div class="p-3 rounded bg-[#081018]">
                <div class="text-xs text-gray-400">Rank Final (maior)</div>
                <div id="final-rank" class="text-lg font-bold text-blue-300">N/A</div>
              </div>
            </div>

            <!-- preview + submit -->
            <div class="mt-4">
              <label class="text-sm text-gray-300">Preview da Descri√ß√£o</label>
              <div id="description-preview" class="mt-2 p-3 rounded bg-[#07101a] text-gray-300 italic min-h-[54px]">Preencha os campos...</div>
              <div class="mt-3 flex gap-3">
                <button id="submit-report" class="px-4 py-2 rounded bg-blue-600 hover:bg-blue-700">Registrar Relat√≥rio</button>
                <button id="clear-form" class="px-4 py-2 rounded bg-gray-800 hover:bg-gray-700">Limpar Formul√°rio</button>
                <span id="create-status" class="text-sm text-gray-400 self-center"></span>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- RANK -->
      <section id="rank" class="section hidden-section">
        <div class="bg-panel p-6 rounded-xl shadow">
          <h2 class="text-lg font-semibold text-blue-300">üèÜ Rank dos Guardi√µes</h2>
          <p class="text-sm text-gray-400 mt-1">Lista ordenada por pontos.</p>

          <div class="mt-4 overflow-x-auto">
            <table class="w-full text-left text-sm">
              <thead class="text-gray-400">
                <tr>
                  <th class="px-4 py-2">Pos</th>
                  <th class="px-4 py-2">ID</th>
                  <th class="px-4 py-2">Pontos</th>
                  <th class="px-4 py-2">Miss√µes</th>
                </tr>
              </thead>
              <tbody id="rank-body" class="align-top"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- RELAT√ìRIOS -->
      <section id="reports" class="section hidden-section">
        <div class="bg-panel p-6 rounded-xl shadow">
          <h2 class="text-lg font-semibold text-blue-300">üìö Relat√≥rios Registrados</h2>
          <p class="text-sm text-gray-400 mt-1">Hist√≥rico completo. Use configura√ß√µes para exportar/importar.</p>

          <div class="mt-4 overflow-x-auto">
            <table class="w-full text-left text-sm">
              <thead class="text-gray-400">
                <tr>
                  <th class="px-3 py-2">ID</th>
                  <th class="px-3 py-2">Servi√ßos</th>
                  <th class="px-3 py-2">Executores / Aux√≠lio</th>
                  <th class="px-3 py-2">Clientes</th>
                  <th class="px-3 py-2">Descri√ß√£o</th>
                  <th class="px-3 py-2">Data</th>
                </tr>
              </thead>
              <tbody id="reports-body"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- AUX√çLIO -->
      <section id="aux" class="section hidden-section">
        <div class="bg-panel p-6 rounded-xl shadow">
          <h2 class="text-lg font-semibold text-orange-300">üõ°Ô∏è Log de Aux√≠lio</h2>
          <p class="text-sm text-gray-400 mt-1">Quem ajudou e pontos acumulados como suporte.</p>

          <div class="mt-4 overflow-x-auto">
            <table class="w-full text-left text-sm">
              <thead class="text-gray-400">
                <tr>
                  <th class="px-3 py-2">ID</th>
                  <th class="px-3 py-2">√öltima</th>
                  <th class="px-3 py-2">Pontos</th>
                </tr>
              </thead>
              <tbody id="aux-body"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- ADMIN -->
      <section id="admin" class="section hidden-section">
        <div class="bg-panel p-6 rounded-xl shadow">
          <h2 class="text-lg font-semibold text-yellow-300">üîê Administra√ß√£o</h2>
          <p class="text-sm text-gray-400">√Årea administrativa ‚Äî insira a chave para ativar (devkey2024).</p>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
            <div>
              <label class="text-sm text-gray-300">Seu ID (opcional)</label>
              <input id="admin-id" class="w-full p-2 rounded bg-[#0b1220] border border-gray-700" placeholder="Seu ID">
            </div>
            <div>
              <label class="text-sm text-gray-300">Chave Mestra</label>
              <div class="flex gap-2">
                <input id="admin-key" type="password" class="flex-grow p-2 rounded bg-[#0b1220] border border-gray-700" placeholder="Chave">
                <button id="btn-admin" class="px-3 py-2 rounded bg-yellow-600 hover:bg-yellow-700">Verificar</button>
              </div>
            </div>
          </div>

          <!-- ADMIN UI -->
          <div id="admin-ui" class="mt-6 space-y-4 hidden">
            <!-- GUARDI√ïES -->
            <div class="p-4 rounded bg-[#071018]">
              <div class="flex justify-between items-center">
                <h3 class="text-sm text-yellow-300 font-semibold">Cadastro ‚Äî Guardi√µes</h3>
                <div class="flex gap-2">
                  <input id="new-ninja" placeholder="novo id" class="p-2 rounded bg-[#0b1220] border border-gray-700">
                  <button id="add-ninja" class="px-3 py-2 rounded bg-yellow-600 hover:bg-yellow-700">Adicionar</button>
                </div>
              </div>
              <div class="mt-3 overflow-x-auto">
                <table class="w-full text-sm">
                  <thead class="text-gray-400">
                    <tr><th class="px-3 py-2">ID</th><th class="px-3 py-2">Status</th><th class="px-3 py-2">A√ß√µes</th></tr>
                  </thead>
                  <tbody id="ninjas-body"></tbody>
                </table>
              </div>
            </div>

            <!-- MISS√ïES -->
            <div class="p-4 rounded bg-[#071018]">
              <div class="flex justify-between items-center">
                <h3 class="text-sm text-green-300 font-semibold">Banco de Miss√µes</h3>
                <div class="flex gap-2">
                  <input id="new-mission-name" placeholder="nome da miss√£o" class="p-2 rounded bg-[#0b1220] border border-gray-700">
                  <select id="new-mission-rank" class="p-2 rounded bg-[#0b1220] border border-gray-700">
                    <option>S-Rank</option><option>A-Rank</option><option>B-Rank selected>B-Rank</option>
                    <option>C-Rank</option><option>D-Rank</option><option>Defesa/Raid</option><option>NPC Quest</option><option>Storyline</option>
                  </select>
                  <button id="add-mission-admin" class="px-3 py-2 rounded bg-green-600 hover:bg-green-700">Adicionar</button>
                </div>
              </div>
              <div class="mt-3 overflow-x-auto">
                <table class="w-full text-sm">
                  <thead class="text-gray-400"><tr><th class="px-3 py-2">Nome</th><th class="px-3 py-2">Rank</th><th class="px-3 py-2">Pontos</th><th class="px-3 py-2">A√ß√µes</th></tr></thead>
                  <tbody id="missions-body-admin"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- CONFIG -->
      <section id="config" class="section hidden-section">
        <div class="bg-panel p-6 rounded-xl shadow">
          <h2 class="text-lg font-semibold text-green-300">‚öôÔ∏è Configura√ß√µes e Backup</h2>
          <p class="text-sm text-gray-400">Exportar/Importar seus dados locais (JSON) ou resetar localStorage.</p>

          <div class="mt-4 flex gap-3">
            <button id="export-data" class="px-3 py-2 rounded bg-gray-800 hover:bg-gray-700">Exportar JSON</button>
            <input id="import-file" type="file" accept=".json" class="hidden">
            <button id="btn-import" class="px-3 py-2 rounded bg-gray-800 hover:bg-gray-700">Importar JSON</button>
            <button id="reset-db" class="px-3 py-2 rounded bg-red-600 hover:bg-red-700">Resetar Dados</button>
            <span id="config-status" class="text-sm text-gray-400 self-center"></span>
          </div>
        </div>
      </section>
    </main>

    <footer class="text-center text-xs text-gray-500 py-6">Feito pra uso offline ‚Äî copie para o seu GitHub Pages. Tema: Escuro Ninja.</footer>
  </div>

  <!-- SCRIPT (l√≥gica) -->
  <script>
  /* ------------------------------------------------------------
     Config & Estado
  ------------------------------------------------------------ */
  const STORAGE_KEY = 'ninjaGuildSPA_v1';
  const ADMIN_KEY = 'devkey2024';

  let state = {
    missions: {},    // { name: {name, baseRank, points, id} }
    ninjas: {},      // { id: {id, rankPoints, missionsCompleted, isActive} }
    auxiliary: {},   // { id: {id, rankPoints, lastParticipation} }
    reports: [],     // array de relat√≥rios
  };

  let ui = {
    activeTab: 'home',
    selectedExecutors: [],
  };

  /* ------------------------------------------------------------
     RANK -> pontos por rank (lookup)
  ------------------------------------------------------------ */
  const RANK_POINTS = {
    'SRANK': 5, 'ARANK': 4, 'BRANK': 3, 'CRANK': 2, 'DRANK': 1,
    'DEFESA/RAID': 10, 'NPCQUEST': 0, 'STORYLINE': 0
  };

  // Ordens simples para escolher maior prioridade (S > A > B ...)
  const RANK_ORDER_PREFIX = ['S','A','B','C','D','DEFESA'];

  /* ------------------------------------------------------------
     UTILIT√ÅRIOS
  ------------------------------------------------------------ */
  function normalizeId(id) { return String(id || '').trim().toLowerCase(); }
  function formatDate(iso) {
    if(!iso) return '-';
    const d = new Date(iso);
    return d.toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour:'2-digit', minute:'2-digit' });
  }
  function cleanRankForLookup(rank) {
    if (!rank) return '';
    return rank.toString().toUpperCase().replace(/[\s\-\/]/g,'');
  }
  function seedDefaults() {
    if (Object.keys(state.missions).length) return;
    const list = [
      {name: "Village's Most Wanted", rank:'S-Rank'},
      {name: "Glacier Bear Hunt", rank:'A-Rank'},
      {name: "Bounty Hunting", rank:'B-Rank'},
      {name: "Medical Supplies", rank:'B-Rank'},
      {name: "Academy Scrolls", rank:'D-Rank'},
      {name: "Defesa de Vila ou Raid", rank:'Defesa/Raid'},
      {name: "A Demon??", rank:'NPC Quest'},
      {name: "Land Of Waves", rank:'Storyline'}
    ];
    list.forEach(m => {
      const key = m.name;
      const clean = cleanRankForLookup(m.rank);
      state.missions[key] = { name: key, baseRank: m.rank, points: RANK_POINTS[clean] || 0, id: key };
    });
    // exemplo de ninjas
    ['dellzito','alnvctr'].forEach(id=>{
      const nid = normalizeId(id);
      state.ninjas[nid] = { id:nid, rankPoints:0, missionsCompleted:0, isActive:true };
    });
  }

  /* ------------------------------------------------------------
     PERSIST√äNCIA
  ------------------------------------------------------------ */
  function saveState() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    updateAllViews();
  }
  function loadState() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) state = JSON.parse(raw);
    } catch(e){ console.error('load error',e); }
    seedDefaults();
    updateAllViews();
  }
  function exportJSON() {
    const data = JSON.stringify(state, null, 2);
    const blob = new Blob([data], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'ninja-data-backup.json'; a.click();
    URL.revokeObjectURL(url);
  }
  function importJSON(file) {
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const parsed = JSON.parse(e.target.result);
        state = parsed;
        saveState();
        setConfigStatus('Importado com sucesso', 3000);
      } catch(err) {
        setConfigStatus('Arquivo inv√°lido', 4000);
      }
    };
    reader.readAsText(file);
  }
  function resetData() {
    localStorage.removeItem(STORAGE_KEY);
    state = { missions:{}, ninjas:{}, auxiliary:{}, reports:[] };
    seedDefaults();
    saveState();
  }

  /* ------------------------------------------------------------
     UI Helpers & Tabs
  ------------------------------------------------------------ */
  function setActiveTab(tab) {
    ui.activeTab = tab;
    document.querySelectorAll('.tab').forEach(b => {
      b.classList.remove('tab-active','text-white','bg-[#071224]');
      if (b.dataset.tab === tab) b.classList.add('tab-active','text-white','bg-[#071224]');
    });
    // sections
    document.querySelectorAll('main .section').forEach(sec => sec.classList.add('hidden-section'));
    const sel = document.getElementById(tab);
    if (sel) sel.classList.remove('hidden-section');
    // small focus adjustments
    if (tab === 'create') document.getElementById('clients-input').focus();
  }

  /* ------------------------------------------------------------
     Renderers (tabelas, selects, cards)
  ------------------------------------------------------------ */
  function updateAllViews() {
    // stats
    document.getElementById('stat-ninjas').textContent = Object.keys(state.ninjas).length;
    document.getElementById('stat-missions').textContent = Object.keys(state.missions).length;
    document.getElementById('stat-reports').textContent = state.reports.length;

    // executor select (ativos)
    const execSel = document.getElementById('executor-select');
    execSel.innerHTML = '<option value="">-- selecione --</option>';
    Object.values(state.ninjas).filter(n => n.isActive).sort((a,b)=>a.id.localeCompare(b.id)).forEach(n=>{
      const opt = document.createElement('option');
      opt.value = n.id; opt.textContent = n.id;
      execSel.appendChild(opt);
    });

    // missions rows selects content
    const missionsHtml = Object.values(state.missions).sort((a,b)=>{
      const ra = cleanRankForLookup(a.baseRank), rb = cleanRankForLookup(b.baseRank);
      const ia = RANK_ORDER_PREFIX.findIndex(p=>ra.startsWith(p));
      const ib = RANK_ORDER_PREFIX.findIndex(p=>rb.startsWith(p));
      if (ia!==ib) return ia-ib;
      return a.name.localeCompare(b.name);
    }).map(m => `<option value="${escapeHtml(m.name)}" data-points="${m.points}">${escapeHtml(m.name)} (${m.baseRank.replace('-Rank','')}, ${m.points} pts)</option>`).join('');
    document.querySelectorAll('.mission-row-select').forEach(s => {
      const cur = s.value;
      s.innerHTML = '<option value="">-- selecione --</option>' + missionsHtml;
      if (cur) s.value = cur;
    });

    // rank table
    const rankBody = document.getElementById('rank-body');
    rankBody.innerHTML = '';
    Object.values(state.ninjas).sort((a,b)=>b.rankPoints - a.rankPoints).forEach((n,i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td class="px-4 py-2">${i+1}¬∞</td>
                      <td class="px-4 py-2 font-medium text-blue-200">${escapeHtml(n.id)}</td>
                      <td class="px-4 py-2 text-green-300">${Math.round(n.rankPoints)}</td>
                      <td class="px-4 py-2">${n.missionsCompleted || 0}</td>`;
      rankBody.appendChild(tr);
    });

    // reports table
    const repBody = document.getElementById('reports-body');
    repBody.innerHTML = '';
    state.reports.slice().reverse().forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td class="px-3 py-2 font-mono text-xs">${escapeHtml(r.reportId)}</td>
                      <td class="px-3 py-2">${r.serviceNames.map(s=>`<div class="text-xs text-gray-400">${escapeHtml(s)}</div>`).join('')}</td>
                      <td class="px-3 py-2"><div class="font-medium text-blue-200">${escapeHtml((r.executorIds||[]).join(', '))}</div>${(r.supportIds?.length?'<div class="text-xs text-gray-400">Aux: '+escapeHtml(r.supportIds.join(', '))+'</div>':'')}</td>
                      <td class="px-3 py-2">${escapeHtml((r.clients||[]).join(', '))}</td>
                      <td class="px-3 py-2 italic text-gray-300">${escapeHtml(r.description)}</td>
                      <td class="px-3 py-2 text-xs text-gray-400">${formatDate(r.timestamp)}</td>`;
      repBody.appendChild(tr);
    });

    // aux table
    const auxBody = document.getElementById('aux-body');
    auxBody.innerHTML = '';
    Object.values(state.auxiliary).sort((a,b)=>b.rankPoints - a.rankPoints).forEach(a=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td class="px-3 py-2">${escapeHtml(a.id)}</td>
                      <td class="px-3 py-2 text-sm text-gray-400">${formatDate(a.lastParticipation)}</td>
                      <td class="px-3 py-2 text-green-300">${Math.round(a.rankPoints)}</td>`;
      auxBody.appendChild(tr);
    });

    // admin: ninjas table
    const ninjasBody = document.getElementById('ninjas-body');
    ninjasBody.innerHTML = '';
    Object.values(state.ninjas).sort((a,b)=>a.id.localeCompare(b.id)).forEach(n=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td class="px-3 py-2">${escapeHtml(n.id)}</td>
                      <td class="px-3 py-2">${n.isActive?'<span class="text-green-300">Ativo</span>':'<span class="text-red-400">Inativo</span>'}</td>
                      <td class="px-3 py-2">
                        <button class="px-2 py-1 text-xs rounded bg-gray-800 mr-2" onclick="toggleNinja('${encodeURIComponent(n.id)}')">Alternar</button>
                        <button class="px-2 py-1 text-xs rounded bg-red-600" onclick="deleteNinja('${encodeURIComponent(n.id)}')">Excluir</button>
                      </td>`;
      ninjasBody.appendChild(tr);
    });

    // admin: missions table
    const missionsAdmin = document.getElementById('missions-body-admin');
    missionsAdmin.innerHTML = '';
    Object.values(state.missions).sort((a,b)=>a.name.localeCompare(b.name)).forEach(m=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td class="px-3 py-2">${escapeHtml(m.name)}</td>
                      <td class="px-3 py-2">${escapeHtml(m.baseRank)}</td>
                      <td class="px-3 py-2">${m.points}</td>
                      <td class="px-3 py-2">
                        <button class="px-2 py-1 text-xs rounded bg-blue-600 mr-2" onclick="editMission('${encodeURIComponent(m.id)}')">Editar</button>
                        <button class="px-2 py-1 text-xs rounded bg-red-600" onclick="deleteMission('${encodeURIComponent(m.id)}')">Excluir</button>
                      </td>`;
      missionsAdmin.appendChild(tr);
    });

    // mission selects content updated above
  }

  /* ------------------------------------------------------------
     Small safe-escape helper
  ------------------------------------------------------------ */
  function escapeHtml(text) {
    if (text === undefined || text === null) return '';
    return String(text).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
  }

  /* ------------------------------------------------------------
     Form: CREATE REPORT (rows, preview, submit)
  ------------------------------------------------------------ */
  function generateReportId() {
    const id = Math.random().toString(36).slice(2,10).toUpperCase();
    document.getElementById('report-id').value = id;
  }
  function addMissionRow(initial = '') {
    const container = document.getElementById('missions-rows');
    const idx = container.children.length;
    const row = document.createElement('div');
    row.className = 'flex gap-2 items-center';
    row.innerHTML = `
      <select class="mission-row-select flex-grow p-2 rounded bg-[#0b1220] border border-gray-700"></select>
      <button class="px-3 py-2 rounded bg-red-600 remove-row">‚úñ</button>
    `;
    container.appendChild(row);

    // fill selects
    updateAllViews(); // ensures options generated above
    const select = row.querySelector('select');
    select.classList.add('mission-row-select');
    select.value = initial || '';
    // hook remove
    row.querySelector('.remove-row').addEventListener('click', () => {
      row.remove();
      updateCreatePreview();
    });
    // onchange
    select.addEventListener('change', updateCreatePreview);
  }
  function clearCreateForm() {
    ui.selectedExecutors = [];
    document.getElementById('executors-tags').innerHTML = '';
    document.getElementById('clients-input').value = '';
    document.getElementById('support-input').value = '';
    document.getElementById('mission-details-input').value = '';
    document.getElementById('missions-rows').innerHTML = '';
    addMissionRow();
    generateReportId();
    updateCreatePreview();
  }

  function updateCreatePreview() {
    // collect missions
    const selects = Array.from(document.querySelectorAll('.mission-row-select'));
    const serviceNames = selects.map(s => s.value).filter(Boolean);
    // executors
    const executors = ui.selectedExecutors.slice();
    const clients = (document.getElementById('clients-input').value || '').split(',').map(s=>s.trim()).filter(Boolean);
    const supports = (document.getElementById('support-input').value || '').split(',').map(s=>normalizeId(s)).filter(Boolean);
    const missionDetails = document.getElementById('mission-details-input').value.trim();

    // calculate points
    let totalPoints = 0;
    let highestRank = '';
    serviceNames.forEach(name => {
      const m = state.missions[name];
      if (m) {
        totalPoints += (m.points||0);
        const cr = cleanRankForLookup(m.baseRank);
        const currentIdx = RANK_ORDER_PREFIX.findIndex(p => cr.startsWith(p));
        const highestIdx = highestRank ? RANK_ORDER_PREFIX.findIndex(p => cleanRankForLookup(highestRank).startsWith(p)) : 999;
        if (currentIdx >=0 && currentIdx < highestIdx) highestRank = m.baseRank;
      }
    });

    const totalParticipants = executors.length + supports.length;
    const perPerson = totalParticipants ? totalPoints / totalParticipants : 0;

    document.getElementById('total-points').textContent = Math.round(totalPoints);
    document.getElementById('points-per-person').textContent = perPerson ? perPerson.toFixed(2) : '0';
    document.getElementById('final-rank').textContent = highestRank || 'N/A';

    // preview text
    let desc = 'Preencha miss√µes, executores e detalhes para gerar a descri√ß√£o.';
    if (serviceNames.length && executors.length && clients.length && missionDetails) {
      const clientsText = clients.join(', ');
      const execText = executors.join(', ');
      const supportText = supports.length ? ` com aux√≠lio de ${supports.join(', ')}` : '';
      desc = `O(s) Guardi√£o(√µes) ${execText}${supportText} atendeu(aram) a solicita√ß√£o dos clientes ${clientsText} realizando: ${serviceNames.join(', ')}. Objetivo: "${missionDetails}". (Total ${totalPoints} pts, ${perPerson.toFixed(2)} pts/pessoa).`;
    } else if (executors.length) {
      desc = `Executores selecionados: ${executors.join(', ')}. Complete miss√µes/cliente/detalhes.`;
    }
    document.getElementById('description-preview').textContent = desc;

    // enable submit
    document.getElementById('submit-report').disabled = !(serviceNames.length && executors.length && clients.length && missionDetails);
  }

  /* submit report */
  function submitReport() {
    const selects = Array.from(document.querySelectorAll('.mission-row-select'));
    const serviceNames = selects.map(s=>s.value).filter(Boolean);
    const executors = ui.selectedExecutors.slice();
    const supports = (document.getElementById('support-input').value || '').split(',').map(s=>normalizeId(s)).filter(Boolean);
    const clients = (document.getElementById('clients-input').value || '').split(',').map(s=>s.trim()).filter(Boolean);
    const missionDetails = document.getElementById('mission-details-input').value.trim();
    const reportId = document.getElementById('report-id').value || generateReportId();
    if (!serviceNames.length || !executors.length || !clients.length || !missionDetails) {
      setCreateStatus('Preencha todos os campos obrigat√≥rios', 4000);
      return;
    }

    // calcula pontos
    let totalPoints = 0;
    serviceNames.forEach(name => totalPoints += (state.missions[name]?.points || 0));
    const perPerson = (executors.length + supports.length) ? totalPoints / (executors.length+supports.length) : 0;

    const report = {
      reportId, serviceNames, executorIds: executors, supportIds: supports,
      clients, description: document.getElementById('description-preview').textContent,
      totalPointsRaw: totalPoints, pointsPerPerson: perPerson, timestamp: new Date().toISOString(),
      finalReportRank: document.getElementById('final-rank').textContent
    };
    state.reports.push(report);

    // atualiza ninjas executores
    executors.forEach(id => {
      const nid = normalizeId(id);
      if (!state.ninjas[nid]) state.ninjas[nid] = { id:nid, rankPoints:0, missionsCompleted:0, isActive:true };
      state.ninjas[nid].rankPoints += perPerson;
      state.ninjas[nid].missionsCompleted = (state.ninjas[nid].missionsCompleted || 0) + serviceNames.length;
    });

    // atualiza auxiliares
    const now = new Date().toISOString();
    supports.forEach(id => {
      const aid = normalizeId(id);
      if (!state.auxiliary[aid]) state.auxiliary[aid] = { id:aid, rankPoints:0, lastParticipation:null };
      state.auxiliary[aid].rankPoints += perPerson;
      state.auxiliary[aid].lastParticipation = now;
    });

    saveState();
    clearCreateForm();
    setCreateStatus(`‚úÖ Relat√≥rio ${reportId} registrado.`, 5000);
  }

  /* ------------------------------------------------------------
     Admin actions (add/delete/edit)
  ------------------------------------------------------------ */
  function activateAdminUI() {
    document.getElementById('admin-ui').classList.remove('hidden');
  }
  function deactivateAdminUI() {
    document.getElementById('admin-ui').classList.add('hidden');
  }

  function addNinja() {
    const val = document.getElementById('new-ninja').value.trim();
    if (!val) return setAdminStatus('Digite um ID', 3000);
    const id = normalizeId(val);
    if (state.ninjas[id]) return setAdminStatus('J√° existe', 3000);
    state.ninjas[id] = { id, rankPoints:0, missionsCompleted:0, isActive:true };
    document.getElementById('new-ninja').value = '';
    saveState();
    setAdminStatus('Guardi√£o adicionado', 2500);
  }
  function toggleNinja(encodedId) {
    const id = decodeURIComponent(encodedId);
    if (!state.ninjas[id]) return;
    state.ninjas[id].isActive = !state.ninjas[id].isActive;
    saveState();
  }
  function deleteNinja(encodedId) {
    const id = decodeURIComponent(encodedId);
    if (!confirm('Excluir guardi√£o?')) return;
    delete state.ninjas[id];
    delete state.auxiliary[id];
    // remove from selected executors if present
    ui.selectedExecutors = ui.selectedExecutors.filter(x => x !== id);
    saveState();
  }

  function addMissionAdmin() {
    const name = document.getElementById('new-mission-name').value.trim();
    const rank = document.getElementById('new-mission-rank').value;
    if (!name) return setAdminStatus('Nome obrigat√≥rio', 3000);
    if (state.missions[name]) return setAdminStatus('Miss√£o j√° existe', 3000);
    const points = RANK_POINTS[cleanRankForLookup(rank)] || 0;
    state.missions[name] = { name, baseRank: rank, points, id: name };
    document.getElementById('new-mission-name').value = '';
    saveState();
    setAdminStatus('Miss√£o adicionada', 2500);
  }
  function deleteMission(encodedId) {
    const id = decodeURIComponent(encodedId);
    if (!confirm('Excluir miss√£o?')) return;
    delete state.missions[id];
    saveState();
  }
  function editMission(encodedId) {
    const id = decodeURIComponent(encodedId);
    const m = state.missions[id];
    if (!m) return;
    const newName = prompt('Novo nome (deixe igual para manter):', m.name) || m.name;
    const newRank = prompt('Novo rank (S-Rank / A-Rank / ...):', m.baseRank) || m.baseRank;
    // if renaming to existing name, abort
    if (newName !== id && state.missions[newName]) return alert('J√° existe miss√£o com esse nome');
    delete state.missions[id];
    state.missions[newName] = { name:newName, baseRank:newRank, points: RANK_POINTS[cleanRankForLookup(newRank)] || 0, id:newName };
    saveState();
  }

  /* ------------------------------------------------------------
     small UI status helpers
  ------------------------------------------------------------ */
  let createTimeout, adminTimeout, configTimeout;
  function setCreateStatus(msg, ms=2000){ clearTimeout(createTimeout); document.getElementById('create-status').textContent = msg; if(ms) createTimeout = setTimeout(()=>document.getElementById('create-status').textContent='', ms); }
  function setAdminStatus(msg, ms=2000){ clearTimeout(adminTimeout); const s = document.getElementById('status-pill'); s.textContent = msg; s.classList.remove('bg-gray-800'); s.classList.add('bg-[#16221a]'); if(ms) adminTimeout = setTimeout(()=>s.textContent='Modo Offline', ms); }
  function setConfigStatus(msg, ms=2000){ clearTimeout(configTimeout); document.getElementById('config-status').textContent = msg; if(ms) configTimeout = setTimeout(()=>document.getElementById('config-status').textContent = '', ms); }

  /* ------------------------------------------------------------
     small DOM wiring & events
  ------------------------------------------------------------ */
  document.addEventListener('click', (e)=>{
    // nav tabs
    const t = e.target.closest('[data-tab]');
    if (t) { setActiveTab(t.dataset.tab); return; }
    const t2 = e.target.closest('[data-tab-action]');
    if (t2) setActiveTab(t2.dataset.tabAction || t2.getAttribute('data-tab-action'));
  });

  // initial setup
  loadState();
  setActiveTab('home');
  generateReportId();

  // create: add executor
  document.getElementById('add-executor-btn').addEventListener('click', ()=>{
    const sel = document.getElementById('executor-select');
    const val = sel.value;
    if (!val) return setCreateStatus('Selecione um executor', 3000);
    if (ui.selectedExecutors.includes(val)) return setCreateStatus('Executor j√° adicionado', 3000);
    ui.selectedExecutors.push(val);
    renderExecutorTags();
    updateCreatePreview();
  });

  function renderExecutorTags() {
    const container = document.getElementById('executors-tags');
    container.innerHTML = '';
    ui.selectedExecutors.forEach(id=>{
      const span = document.createElement('span');
      span.className = 'tag flex items-center gap-2';
      span.innerHTML = `${escapeHtml(id)} <button class="px-1" onclick="removeExecutor('${encodeURIComponent(id)}')">‚úñ</button>`;
      container.appendChild(span);
    });
  }
  window.removeExecutor = function(encodedId){
    const id = decodeURIComponent(encodedId);
    ui.selectedExecutors = ui.selectedExecutors.filter(x=>x!==id);
    renderExecutorTags();
    updateCreatePreview();
  };

  // create: mission rows
  document.getElementById('add-mission-row').addEventListener('click', ()=>{ addMissionRow(); updateCreatePreview(); });
  addMissionRow(); // start with one

  // create: inputs update preview
  ['clients-input','support-input','mission-details-input'].forEach(id=>{
    document.getElementById(id).addEventListener('input', updateCreatePreview);
  });

  document.getElementById('regen-id').addEventListener('click', ()=>generateReportId());
  document.getElementById('copy-id').addEventListener('click', ()=>{
    const id = document.getElementById('report-id').value;
    navigator.clipboard?.writeText(id).then(()=>setCreateStatus('ID copiado',2000));
  });

  document.getElementById('submit-report').addEventListener('click', submitReport);
  document.getElementById('clear-form').addEventListener('click', clearCreateForm);

  // admin: auth
  document.getElementById('btn-admin').addEventListener('click', ()=>{
    const key = document.getElementById('admin-key').value.trim();
    if (key === ADMIN_KEY) {
      activateAdminUI();
      setAdminStatus('Admin ativado', 3000);
    } else {
      deactivateAdminUI();
      setAdminStatus('Chave incorreta', 3000);
    }
  });

  // admin: add ninja
  document.getElementById('add-ninja').addEventListener('click', addNinja);

  // admin: add mission
  document.getElementById('add-mission-admin').addEventListener('click', addMissionAdmin);

  // admin: edit/delete handled by functions attached to buttons

  // export/import/reset
  document.getElementById('export-data').addEventListener('click', exportJSON);
  document.getElementById('btn-import').addEventListener('click', ()=>document.getElementById('import-file').click());
  document.getElementById('import-file').addEventListener('change', (e)=>{
    const file = e.target.files[0];
    if (!file) return;
    importJSON(file);
    e.target.value = '';
  });
  document.getElementById('reset-db').addEventListener('click', ()=>{
    if (!confirm('Resetar todos os dados locais?')) return;
    resetData();
    setConfigStatus('Dados resetados', 3000);
  });

  // backup button quick
  document.getElementById('download-backup').addEventListener('click', exportJSON);

  // admin deletes (exposed to window for inline onclicks)
  window.deleteMission = function(encodedId){ deleteMission(encodedId); };
  window.editMission = function(encodedId){ editMission(encodedId); };
  window.deleteNinja = function(encodedId){ deleteNinja(encodedId); };
  window.toggleNinja = function(encodedId){ toggleNinja(encodedId); };

  // when data changes, update mission row selects
  const missionObserver = new MutationObserver(()=> updateAllViews());
  missionObserver.observe(document.getElementById('missions-rows'), {childList:true, subtree:true});

  // periodically update UI (in case of edits)
  setInterval(()=>updateAllViews(), 2000);

  // first render
  updateAllViews();
  updateCreatePreview();

  </script>
</body>
</html>
