<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Registro de Miss√µes Ninja (ONLINE - FIREBASE)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 4px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        .remove-btn, .edit-btn, .admin-only, .writer-only { transition: all 0.1s ease-in-out; }
        /* Estilo para a lista de executores */
        .executor-list-container {
            min-height: 50px;
            padding: 8px;
            border: 1px solid #4b5563; /* gray-600 */
            border-radius: 8px;
            background-color: #374151; /* gray-700 */
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        .executor-tag {
            display: flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 9999px; /* full rounded */
            font-size: 0.875rem; /* text-sm */
            font-weight: 600;
            background-color: #3b82f6; /* blue-500 */
            color: #fff;
        }
        .executor-remove-btn {
            margin-left: 6px;
            cursor: pointer;
            color: #bfdbfe; /* blue-200 */
        }
        /* Estilo para a Navega√ß√£o */
        .nav-link {
            cursor: pointer;
            padding: 10px 15px;
            font-weight: 600;
            transition: all 0.2s;
        }
        .nav-link:hover:not(.active) {
            background-color: #1e293b; /* slate-800 */
        }
        .nav-link.active {
            color: #fcd34d; /* amber-300 */
            border-bottom: 2px solid #fcd34d;
        }
    </style>
</head>
<body class="p-4 sm:p-8 text-gray-100">

    <div id="app" class="max-w-6xl mx-auto space-y-8">
        
        <!-- HEADER e NAVEGA√á√ÉO -->
        <header class="pb-4 border-b border-blue-700/50">
            <h1 class="text-4xl font-bold text-blue-400 text-center mb-4">üìú Sistema de Registro de Miss√µes Ninja</h1>
            <nav class="flex justify-center bg-gray-900 rounded-xl shadow-lg p-1">
                <a class="nav-link" onclick="window.renderPage('home')" id="nav-home">Home</a>
                <a class="nav-link" onclick="window.renderPage('report_form')" id="nav-report_form">Criar Relat√≥rio</a>
                <a class="nav-link" onclick="window.renderPage('scoreboard')" id="nav-scoreboard">Ver Rank</a>
                <a class="nav-link" onclick="window.renderPage('reports_log')" id="nav-reports_log">Hist√≥rico</a>
                <a class="nav-link" onclick="window.renderPage('auxiliary_log')" id="nav-auxiliary_log">Aux√≠lio</a>
                <a class="nav-link" onclick="window.renderPage('admin_panel')" id="nav-admin_panel">Autoriza√ß√£o</a>
                <a class="nav-link" onclick="window.renderPage('ninja_panel')" id="nav-ninja_panel">Painel de Ninjas</a>
            </nav>
        </header>
        
        <!-- Conte√∫do principal de Roteamento -->
        <div id="content" class="min-h-[60vh]">
            <!-- O conte√∫do da p√°gina ativa ser√° injetado aqui -->
        </div>

        <!-- Loading and Error State -->
        <div id="status" class="text-center p-4 rounded-lg hidden"></div>
        
        <!-- Auth Info for Debugging/Sharing -->
        <div id="auth-info" class="text-sm text-center text-yellow-500">Conectando ao Firebase...</div>
    </div>

    <!-- MODAL DE CONFIRMA√á√ÉO/EDI√á√ÉO CUSTOMIZADO -->
    <div id="custom-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div id="modal-content" class="bg-gray-800 rounded-xl shadow-2xl p-6 w-full max-w-lg space-y-4 transform scale-95 transition-all">
            <h3 id="modal-title" class="text-xl font-bold text-blue-400">T√≠tulo do Modal</h3>
            <p id="modal-message" class="text-gray-300">Mensagem do Modal.</p>
            <div id="modal-input-container" class="space-y-3 hidden">
                <label id="input-label-1" for="modal-input-1" class="block text-sm font-medium text-gray-300">Input 1</label>
                <input type="text" id="modal-input-1" class="w-full p-2.5 rounded-lg bg-gray-700 border border-gray-600 text-white" />
                <label id="input-label-2" for="modal-input-2" class="block text-sm font-medium text-gray-300">Input 2 (Rank)</label>
                <select id="modal-input-2" class="w-full p-2.5 rounded-lg bg-gray-700 border border-gray-600 text-white">
                    <!-- Op√ß√µes de Rank ser√£o injetadas -->
                </select>
                <span id="modal-error" class="text-red-400 text-sm hidden"></span>
            </div>
            <div id="modal-actions" class="flex justify-end gap-3 pt-2">
                <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg transition duration-150">Cancelar</button>
                <button id="modal-confirm-btn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition duration-150">Confirmar</button>
            </div>
        </div>
    </div>
    <!-- FIM DO MODAL -->

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, setDoc, onSnapshot, collection, writeBatch, 
            updateDoc, getDoc, deleteDoc, setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ====================================================================
        // CONFIGURA√á√ïES FIREBASE & CHAVE MESTRA
        // ====================================================================
        
        // VARI√ÅVEIS DE CONFIGURA√á√ÉO DO FIREBASE (DEVE SER CONFIGURADO EM VERCEL/GITHUB SECRETS)
        // OBS: Se estiver no Canvas, a configura√ß√£o √© injetada automaticamente.
        const CUSTOM_FIREBASE_CONFIG = {
            apiKey: "AIzaSyC-QaPr7O6RkWR3vpXCg4zrnUWw3TzU9ss",
            authDomain: "g-2cb53.firebaseapp.com",
            projectId: "g-2cb53",
            storageBucket: "g-2cb53.firebasestorage.app",
            messagingSenderId: "292095146978",
            appId: "1:292095146978:web:836d833230907d081017bb",
            measurementId: "G-B2EXQ2Z75D"
        };
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : CUSTOM_FIREBASE_CONFIG.projectId || 'g-2cb53';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : CUSTOM_FIREBASE_CONFIG;
        
        // CHAVE MESTRA FIXA DO ADMIN MASTER (para o ID 'MASTER_ADMIN')
        const MASTER_ADMIN_ID = 'master_admin_key'; // Este ID √© reservado para o acesso Master
        const WRITER_MODE_ID = 'writer_mode_key'; // Este ID √© reservado para o acesso de Escritor

        let isMasterAdminMode = false; // Controle de acesso total
        let isWriterMode = false; // Controle de acesso para Criar Relat√≥rio / Editar Miss√µes
        let currentPage = 'home';
        
        // Firestore instances and IDs
        let app;
        let db;
        let auth;
        let userId = null;
        let currentReportId = ''; 
        let selectedExecutors = []; 
        
        // Cache de dados (ser√£o preenchidos por onSnapshot)
        let missionsData = {}; 
        let ninjasData = {}; 
        let auxiliaryData = {}; 
        let reportsData = []; 
        let accessKeysData = {}; // NOVO: Cache para IDs/Senhas de Guardi√µes
        
        // Estrutura de Cole√ß√µes (P√∫blica)
        const COLLECTIONS = {
            MISSIONS: `artifacts/${appId}/public/data/missions`,
            REPORTS: `artifacts/${appId}/public/data/reports`,
            NINJAS: `artifacts/${appId}/public/data/ninjas`, 
            AUXILIARY_LOG: `artifacts/${appId}/public/data/auxiliary_log`,
            ACCESS_KEYS: `artifacts/${appId}/public/data/access_keys` // NOVO
        };

        // Mapeamento de Rank para Pontos e Constantes (Mantidas)
        const RANK_POINTS = {
            'SRANK': 5, 'ARANK': 4, 'BRANK': 3, 'CRANK': 2, 'DRANK': 1,
            'DEFESARAID': 10, 'NPCQUEST': 0, 'STORYLINE': 0, 'ANYLEVEL': 0
        };
        const RANK_OPTIONS = [
            "S-Rank", "A-Rank", "B-Rank", "C-Rank", "D-Rank", 
            "Defesa/Raid", "NPC Quest", "Storyline"
        ];
        const RANK_ORDER = ['S', 'A', 'B', 'C', 'D', 'DEFESA'];

        setLogLevel('debug'); 

        // ====================================================================
        // FUN√á√ïES DE PERSIST√äNCIA E INICIALIZA√á√ÉO (FIREBASE)
        // ====================================================================

        async function initializeFirebase() {
            try {
                if (!firebaseConfig || !firebaseConfig.projectId) {
                    throw new Error("Configura√ß√£o do Firebase inv√°lida ou faltando.");
                }
                
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Login An√¥nimo para acesso B√ÅSICO (Leitura)
                const anonUser = await signInAnonymously(auth);
                userId = anonUser.user.uid;
                
                document.getElementById('auth-info').textContent = `Usu√°rio ID (Anon): ${userId} | App ID (DB Contexto): ${appId}`;
                setupFirestoreListeners(); // Inicia os listeners de dados
                renderPage(currentPage);
                generateReportId(); 
                

            } catch (error) {
                console.error("Erro na inicializa√ß√£o do Firebase:", error);
                const statusElement = document.getElementById('status');
                statusElement.className = 'text-red-400 p-4 bg-red-900/50 rounded-lg block';
                statusElement.textContent = `‚ùå Erro ao conectar: ${error.message}. Verifique sua chave de API e regras de seguran√ßa.`;
            }
        }
        
        function setupFirestoreListeners() {
            if (!db) return;

            // 0. Chaves de Acesso (Nova Cole√ß√£o)
            onSnapshot(collection(db, COLLECTIONS.ACCESS_KEYS), (snapshot) => {
                accessKeysData = {};
                snapshot.forEach(doc => {
                    const data = doc.data();
                    accessKeysData[doc.id] = data; 
                });
            });

            // 1. Miss√µes / Quests
            onSnapshot(collection(db, COLLECTIONS.MISSIONS), (snapshot) => {
                missionsData = {};
                snapshot.forEach(doc => {
                    const data = doc.data();
                    missionsData[data.name] = data; 
                });
                if (Object.keys(missionsData).length === 0) {
                     seedInitialData(db);
                }
                if (['report_form', 'admin_panel'].includes(currentPage)) renderPage(currentPage);
            });

            // 2. Ninjas / Cadastro e Scoreboard
            onSnapshot(collection(db, COLLECTIONS.NINJAS), (snapshot) => {
                ninjasData = {};
                snapshot.forEach(doc => {
                    const data = doc.data();
                    data.id = doc.id; 
                    ninjasData[data.id] = data;
                });
                if (['report_form', 'scoreboard', 'admin_panel', 'ninja_panel'].includes(currentPage)) renderPage(currentPage);
            });
            
            // 3. Log de Aux√≠lio
            onSnapshot(collection(db, COLLECTIONS.AUXILIARY_LOG), (snapshot) => {
                auxiliaryData = {};
                snapshot.forEach(doc => {
                    const data = doc.data();
                    auxiliaryData[data.id] = data;
                });
                if (['auxiliary_log', 'ninja_panel'].includes(currentPage)) renderPage(currentPage);
            });

            // 4. Relat√≥rios / Logs
            onSnapshot(collection(db, COLLECTIONS.REPORTS), (snapshot) => {
                reportsData = [];
                snapshot.forEach(doc => reportsData.push(doc.data()));
                if (['reports_log', 'ninja_panel'].includes(currentPage)) renderPage(currentPage);
            });
        }
        
        // Simula o seed de dados no Firestore
        async function seedInitialData(db) {
            // ... (L√≥gica de seed mantida, mas adaptada para incluir chave mestra de exemplo)
            const newMissionsList = [
                { name: "Village's Most Wanted", rank: "S-Rank" },
                { name: "Glacier Bear Hunt", rank: "A-Rank" },
                { name: "Puppet Retirement", rank: "A-Rank" },
                { name: "Retrieve Compromised Documents", rank: "A-Rank" },
                { name: "Spy on Hokage/Kazekage/Mizukage Office", rank: "A-Rank" },
                { name: "Bounty Hunting", rank: "B-Rank" },
                { name: "Cold-Blooded Killer", rank: "B-Rank" },
                { name: "Guilty Pleasure", rank: "B-Rank" },
                { name: "Medical Supplies", rank: "B-Rank" },
                { name: "Antidotes Creation", rank: "C-Rank" },
                { name: "Bear Hunt", rank: "C-Rank" },
                { name: "Messenger Ninja", rank: "C-Rank" },
                { name: "Shark Attack", rank: "C-Rank" },
                { name: "Academy Scrolls", rank: "D-Rank" },
                { name: "Bad Larva", rank: "D-Rank" },
                { name: "Defeat Spiders", rank: "D-Rank" },
                { name: "Lost Puppy 'Giba'", rank: "D-Rank" },
                { name: "Defesa de Vila ou Raid", rank: "Defesa/Raid" },
                { name: "A Demon??", rank: "NPC Quest" },
                { name: "Land Of Waves", rank: "Storyline" },
            ];

            const batch = writeBatch(db);
            let ninjasAdded = 0;

            for (const mission of newMissionsList) {
                const docId = mission.name;
                const missionRef = doc(db, COLLECTIONS.MISSIONS, docId);
                const cleanRank = cleanRankForLookup(mission.rank);
                const points = RANK_POINTS[cleanRank] || 0; 
                batch.set(missionRef, {
                    name: mission.name,
                    baseRank: mission.rank,
                    points: points,
                    id: mission.name
                });
            }

            const exampleNinjas = ['dellzito', 'alnvctr'];
            for (const id of exampleNinjas) {
                const normalizedId = normalizeId(id); 
                const ninjaRef = doc(db, COLLECTIONS.NINJAS, normalizedId);
                const ninjaSnap = await getDoc(ninjaRef);
                if (!ninjaSnap.exists()) {
                    batch.set(ninjaRef, { id: normalizedId, isActive: true, rankPoints: 0, missionsCompleted: 0 });
                    ninjasAdded++;
                }
            }
            
            // NOVO: Adiciona uma chave de ADMIN MASTER para o primeiro uso
            const masterKeyRef = doc(db, COLLECTIONS.ACCESS_KEYS, 'MASTER_ADMIN');
            batch.set(masterKeyRef, {
                id: 'MASTER_ADMIN',
                key: 'MASTER_KEY_001', // Chave √∫nica e secreta para voc√™ (MUDE ESTE VALOR MANUALMENTE NO FIRESTORE)
                level: 'master_admin'
            }, { merge: true });

            // NOVO: Adiciona uma chave de ESCRITOR de exemplo
            const writerKeyRef = doc(db, COLLECTIONS.ACCESS_KEYS, 'Guardi√£o_Exemplo');
            batch.set(writerKeyRef, {
                id: 'GUARDIAN_1',
                key: 'report_123', // Chave para um Guardi√£o (MUDE ESTE VALOR MANUALMENTE NO FIRESTORE)
                level: 'report_writer'
            }, { merge: true });


            if (newMissionsList.length > 0 || ninjasAdded > 0) {
                try {
                    await batch.commit();
                } catch (e) {
                     console.error("Erro ao fazer seed inicial no Firestore:", e);
                }
            }
        }
        
        // ====================================================================
        // FUN√á√ïES DE CONTROLE DE ACESSO
        // ====================================================================

        window.toggleWriterUI = function(isAuthorized) {
            isWriterMode = isAuthorized;
            // Libera a aba Criar Relat√≥rio e o Gerenciamento de Miss√µes
            const writerElements = document.querySelectorAll('.writer-only');
            
            writerElements.forEach(el => {
                if (isAuthorized) {
                    el.classList.remove('hidden');
                } else {
                    el.classList.add('hidden');
                }
            });
            // Re-renderiza a p√°gina atual para aplicar as permiss√µes
            renderPage(currentPage);
        }

        window.toggleMasterAdminUI = function(isAuthorized) {
            isMasterAdminMode = isAuthorized;
            // Libera todas as funcionalidades de Admin
            const adminElements = document.querySelectorAll('.admin-only');
            
            adminElements.forEach(el => {
                if (isAuthorized) {
                    el.classList.remove('hidden');
                } else {
                    el.classList.add('hidden');
                }
            });
            // Re-renderiza a p√°gina atual para aplicar as permiss√µes
            renderPage(currentPage);
        }
        
        window.checkAccessKey = async function() {
            const idInput = document.getElementById('access-id-input');
            const keyInput = document.getElementById('access-key-input');
            const statusElement = document.getElementById('status');
            
            if (!idInput || !keyInput) return;

            const id = idInput.value.trim();
            const key = keyInput.value.trim();
            
            if (!id || !key) {
                statusElement.textContent = '‚ùå Preencha o ID e a Senha.';
                statusElement.className = 'text-red-400 p-4 bg-red-900/50 rounded-lg block';
                setTimeout(() => statusElement.classList.add('hidden'), 5000);
                return;
            }
            
            // 1. Procura a chave no cache do Firebase
            const accessData = accessKeysData[id];

            if (accessData && accessData.key === key) {
                
                if (accessData.level === 'master_admin') {
                    window.toggleMasterAdminUI(true);
                    window.toggleWriterUI(true);
                    statusElement.textContent = `‚úÖ Acesso MASTER LIBERADO. ID: ${id}`;
                } else if (accessData.level === 'report_writer') {
                    window.toggleWriterUI(true);
                    window.toggleMasterAdminUI(false);
                    statusElement.textContent = `‚úÖ Acesso ESCRITOR LIBERADO. ID: ${id}`;
                } else {
                    statusElement.textContent = '‚ùå ID/Senha v√°lidos, mas N√≠vel de Acesso n√£o reconhecido.';
                    statusElement.className = 'text-red-400 p-4 bg-red-900/50 rounded-lg block';
                    setTimeout(() => statusElement.classList.add('hidden'), 7000);
                    return;
                }
                
                keyInput.value = ''; 
                idInput.value = '';
                statusElement.className = 'text-green-400 p-4 bg-green-900/50 rounded-lg block';
                setTimeout(() => statusElement.classList.add('hidden'), 5000);
                
            } else {
                window.toggleWriterUI(false);
                window.toggleMasterAdminUI(false);
                statusElement.textContent = '‚ùå Autoriza√ß√£o Negada. ID ou Senha Incorreta.';
                statusElement.className = 'text-red-400 p-4 bg-red-900/50 rounded-lg block';
                setTimeout(() => statusElement.classList.add('hidden'), 7000);
            }
        }
        
        // ====================================================================
        // FUN√á√ïES DE ROTEAMENTO E TEMPLATES
        // ====================================================================

        window.renderPage = function(pageName) {
            currentPage = pageName;
            const contentDiv = document.getElementById('content');
            
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            const activeLink = document.getElementById(`nav-${pageName}`);
            if (activeLink) activeLink.classList.add('active');

            contentDiv.innerHTML = '';

            switch (pageName) {
                case 'home':
                    contentDiv.innerHTML = renderHome();
                    break;
                case 'report_form':
                    contentDiv.innerHTML = renderCriarRelatorio();
                    if (!isWriterMode) {
                        contentDiv.innerHTML += '<p class="text-center text-red-500 pt-8">Voc√™ precisa de autoriza√ß√£o (Login na aba Autoriza√ß√£o) para criar relat√≥rios.</p>';
                        break;
                    }
                    // Fun√ß√µes de inicializa√ß√£o espec√≠ficas para a p√°gina de relat√≥rio
                    updateMissionSelects(false); 
                    updateExecutorSelect();
                    updateExecutorTags(false); 
                    generateReportId();
                    addMissionEntry(null, false); 
                    window.updateDescriptionPreview();
                    break;
                case 'scoreboard':
                    contentDiv.innerHTML = renderRank();
                    renderScoreboard();
                    break;
                case 'reports_log':
                    contentDiv.innerHTML = renderRelatorios();
                    renderReportsLog();
                    break;
                case 'auxiliary_log':
                    contentDiv.innerHTML = renderAuxilio();
                    renderAuxiliaryLog();
                    break;
                case 'admin_panel':
                    contentDiv.innerHTML = renderAutorizacao(); // Novo nome da aba
                    break;
                case 'ninja_panel':
                    contentDiv.innerHTML = renderNinjaPanel();
                    renderReportsLogFiltered();
                    break;
                default:
                    contentDiv.innerHTML = renderHome();
            }
        }

        // NOVO: Template da aba Autoriza√ß√£o (antigo Painel Admin)
        function renderAutorizacao() {
             const accessStatus = isMasterAdminMode ? 
                `<div class="text-center text-green-400 font-bold text-lg p-2">‚úÖ MASTER ADMIN ATIVO</div>` : 
                (isWriterMode ? `<div class="text-center text-yellow-400 font-bold text-lg p-2">‚úÖ ESCRITOR DE RELAT√ìRIO ATIVO</div>` :
                `<div class="text-center text-red-400 font-bold text-lg p-2">‚ùå ACESSO INATIVO</div>`);

            return `
                <!-- PAINEL DE AUTORIZA√á√ÉO (Login Customizado) -->
                <section class="space-y-4 pt-4 pb-4 bg-gray-900 p-6 rounded-xl shadow-inner border border-blue-500/50">
                     <h2 class="text-2xl font-bold text-blue-400 text-center flex justify-center items-center gap-2">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M10 2a5 5 0 00-5 5v2a2 2 0 00-2 2v5a2 2 0 002 2h10a2 2 0 002-2v-5a2 2 0 00-2-2V7a5 5 0 00-5-5zm2 5v2h-4V7a3 3 0 016 0z"/></svg>
                         Autoriza√ß√£o de Escrita (ID & Senha √önica)
                     </h2>
                     <p class="text-center text-gray-400">Insira seu ID e Senha fornecidos para liberar as fun√ß√µes de escrita e edi√ß√£o.</p>
                     
                     <div id="admin-status-display">${accessStatus}</div>

                     <div class="flex flex-col md:flex-row gap-4 max-w-lg mx-auto">
                         <input id="access-id-input" type="text" placeholder="Seu ID de Guardi√£o/Admin" class="flex-grow p-2 rounded-lg bg-gray-700 border border-gray-600 text-white shadow-inner">
                         <input id="access-key-input" type="password" placeholder="Sua Senha √önica" class="flex-grow p-2 rounded-lg bg-gray-700 border border-gray-600 text-white shadow-inner">
                         <button id="set-access-key-btn" class="w-full md:w-auto py-2 px-4 bg-blue-600 hover:bg-blue-700 rounded-lg font-bold text-white transition duration-200">
                             Verificar Acesso
                         </button>
                     </div>
                </section>
                
                <!-- 5. CADASTRO: GUARDI√ïES (MASTER ADMIN ONLY) -->
                <section class="space-y-4 pt-8 pb-16">
                    <h2 class="text-3xl font-bold text-yellow-400 text-center">Cadastro: Guardi√µes (Membros da Organiza√ß√£o)</h2>
                    <p class="text-center text-gray-400">Pessoas que pontuam no Rank dos Guardi√µes. <span class="text-red-400">Master Admin Apenas.</span></p>

                    <!-- Add New Ninja Form (ADMIN ONLY) -->
                    <div id="add-ninja-form" class="bg-gray-700 p-4 rounded-lg shadow-inner flex flex-col sm:flex-row gap-4 admin-only ${isMasterAdminMode ? '' : 'hidden'}">
                        <input id="new-ninja-id" type="text" placeholder="ID do Novo Guardi√£o (Ex: Dellzito)" class="flex-grow p-2 rounded-lg bg-gray-800 border border-gray-600 text-white">
                        <button id="add-ninja" class="w-full sm:w-auto py-2 px-4 bg-yellow-600 hover:bg-yellow-700 rounded-lg font-bold text-white transition duration-200" onclick="window.addNinja()">Adicionar Guardi√£o</button>
                    </div>

                    <div class="bg-gray-800 p-4 rounded-xl shadow-xl overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-700">
                            <thead class="bg-gray-700">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">ID Guardi√£o</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Status</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider admin-only ${isMasterAdminMode ? '' : 'hidden'}">A√ß√£o</th>
                                </tr>
                            </thead>
                            <tbody id="ninjas-cadastro" class="bg-gray-800 divide-y divide-gray-700">
                                <!-- Ninja data will be inserted here by renderNinjasTable() -->
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- 6. BANCO DE DADOS: MISS√ïES E RANKS (MASTER ADMIN / WRITER MODE) -->
                <section class="space-y-4 pt-8">
                    <h2 class="text-3xl font-bold text-green-400 text-center">Gerenciamento de Miss√µes (Quests)</h2>
                    <p class="text-center text-gray-400">Adicione, edite ou exclua as quests dispon√≠veis. <span class="${isWriterMode ? 'text-green-400' : 'text-red-400'}">Requer Autoriza√ß√£o de Escrita.</span></p>
                    
                    <!-- Add New Mission Form (WRITER ONLY) -->
                    <div id="add-mission-form" class="bg-gray-700 p-4 rounded-lg shadow-inner flex flex-col sm:flex-row gap-4 writer-only ${isWriterMode ? '' : 'hidden'}">
                        <input id="new-mission-name" type="text" placeholder="Novo Nome da Miss√£o" class="flex-grow p-2 rounded-lg bg-gray-800 border border-gray-600 text-white">
                        <select id="new-mission-rank-select" class="w-full sm:w-32 p-2 rounded-lg bg-gray-800 border border-gray-600 text-white">
                             <option value="S-Rank">S-Rank (5 Pts)</option>
                             <option value="A-Rank">A-Rank (4 Pts)</option>
                             <option value="B-Rank" selected>B-Rank (3 Pts)</option>
                             <option value="C-Rank">C-Rank (2 Pts)</option>
                             <option value="D-Rank">D-Rank (1 Pt)</option>
                             <option value="Defesa/Raid">Defesa/Raid (10 Pts)</option>
                             <option value="NPC Quest">NPC Quest (0 Pts)</option>
                             <option value="Storyline">Storyline (0 Pts)</option>
                        </select>
                        <button id="add-mission" class="w-full sm:w-auto py-2 px-4 bg-green-600 hover:bg-green-700 rounded-lg font-bold text-white transition duration-200" onclick="window.addMission()">Adicionar Miss√£o</button>
                    </div>
                    
                    <div class="bg-gray-800 p-4 rounded-xl shadow-xl overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-700">
                            <thead class="bg-gray-700">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Nome da Miss√£o</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Rank Base</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Pontos</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider writer-only ${isWriterMode ? '' : 'hidden'}">A√ß√£o</th>
                                </tr>
                            </thead>
                            <tbody id="missions-database" class="bg-gray-800 divide-y divide-gray-700">
                                <!-- Mission data will be inserted here by renderMissionsDatabase() -->
                            </tbody>
                        </table>
                    </div>
                </section>
            `;
        }
        
        // ... (renderHome, renderCriarRelatorio, renderRank, renderRelatorios, renderAuxilio, renderNinjaPanel)
        // ... (Fun√ß√µes CRUD, Auxiliares e Listeners adaptados para o novo sistema)

        // --- Inicializa√ß√£o ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase(); 

            const content = document.getElementById('content');
            
            // Listeners delegados para os bot√µes que n√£o est√£o sempre no DOM
            content.addEventListener('click', (e) => {
                if (e.target.id === 'add-executor-btn') {
                    window.addExecutorEntry();
                } else if (e.target.id === 'add-mission-btn') {
                    window.addMissionEntry();
                } else if (e.target.id === 'submit-report') {
                    window.submitReport();
                } else if (e.target.id === 'set-access-key-btn') { // NOVO BOT√ÉO DE LOGIN
                    window.checkAccessKey();
                } else if (e.target.id === 'add-ninja') {
                    window.addNinja();
                } else if (e.target.id === 'add-mission') {
                    window.addMission();
                }
            });

            // Listeners para inputs no formul√°rio de relat√≥rio que requerem preview (devem ser delegados ou adicionados ap√≥s render)
            content.addEventListener('input', (e) => {
                if (['clients', 'mission-details', 'support-ids'].includes(e.target.id)) {
                    window.updateDescriptionPreview();
                }
            });
        });
    </script>
</body>
</html>
